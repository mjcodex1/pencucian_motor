<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wash Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="/favicon.png" id="dynamicFavicon" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qz-tray/qz-tray.js"></script>
    <style>
  .receipt-preview {
    width: 58mm;
    height: auto;
    min-height: 30mm;
    font-family: "Courier New", monospace;
    font-size: 10px;
    line-height: 1.1;
    overflow: hidden;
  }

  .sidebar-transition {
    transition: transform 0.3s ease-in-out;
  }

  .thermal-print {
    width: 80mm; /* diseragamkan ke ukuran terbesar */
    max-height: 265.5mm; /* batas tinggi maksimal */
    overflow: hidden;
    font-family: "Courier New", monospace;
    font-size: 10px;
    line-height: 1.2;
    margin: 0;
    padding: 2mm;
  }

  .alert {
    animation: slideIn 0.3s ease-out;
  }

  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  .vehicle-option {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #e5e7eb;
  }

  .vehicle-option:hover,
  .vehicle-option.selected {
    background-color: #f3f4f6;
  }

  .vehicle-option.highlighted {
    background-color: #dbeafe;
  }

  /* Styling untuk tab yang dipilih */
  .tab-button.active {
    border-bottom-width: 2px;
    border-color: #2563eb;
    color: #2563eb;
    font-weight: bold;
  }

  .tab-button:hover {
    border-color: #2563eb;
    color: #2563eb;
  }

  /* CSS untuk animasi dropdown */
  #dropdownArrow {
    transition: transform 0.2s ease-in-out;
  }

  #dropdownArrow.rotate-180 {
    transform: rotate(180deg);
  }

  /* Animasi untuk dropdown menu */
  #userDropdown {
    opacity: 0;
    transform: translateY(-10px);
    transition: opacity 0.2s ease-out, transform 0.2s ease-out;
  }

  #userDropdown.show {
    opacity: 1;
    transform: translateY(0);
  }

  /* Hover effects untuk menu items */
  #userDropdown button:hover {
    background-color: #f3f4f6;
  }

  #userDropdown button:hover i {
    color: #6b7280;
  }

  /* Special styling untuk logout button */
  #userDropdown button:last-child:hover {
    background-color: #fef2f2;
  }

  #userDropdown button:last-child:hover i {
    color: #ef4444;
  }

  #reportSubMenu {
    background: #1f2937;
    border-radius: 0 0 0.5rem 0.5rem;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
    z-index: 10;
    overflow: hidden;
    max-height: 0;
    transition: max-height 500ms ease-in-out;
  }

  /* Submenu Link Styling */
  #reportSubMenu a {
    width: 100%;
    display: flex;
    align-items: center;
    padding: 0.5rem 2rem;
  }

  #reportSubMenu.submenu-open {
    max-height: 500px;
  }

  /* PRINT SETTINGS */
  @media print {
    @page {
      size: 80mm auto;
      margin: 0;
    }

    body * {
      visibility: hidden;
    }

    .receipt-preview,
    .receipt-preview * {
      visibility: visible;
    }

    .receipt-preview {
      position: absolute;
      left: 0;
      top: 0;
      width: 80mm;
      min-height: 30mm;
      font-family: "Courier New", monospace;
      font-size: 10px;
      line-height: 1.2;
      padding: 2mm;
    }
  }
</style>

  </head>
  <body class="bg-gray-100">
    <div id="alert-container" class="fixed top-4 right-4 z-50 space-y-4"></div>
    <!-- Login Screen -->
    <div
      id="loginScreen"
      class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-600 to-purple-700"
    >
      <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
        <div class="text-center mb-8">
          <img
            id="loginLogoHeader"
            class="h-16 w-16 mx-auto mb-2 rounded hidden"
            alt="Logo Toko"
          />
          <i
            id="loginLogoIcon"
            class="fas fa-motorcycle text-4xl text-blue-600 mb-4"
          ></i>
          <h1
            id="storeNameHeader"
            class="text-2xl font-bold text-gray-800"
          ></h1>
          <p class="text-gray-600 mt-2">Sistem Manajemen Cuci Kendaraan</p>
        </div>

        <form id="loginForm" class="space-y-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Username</label
            >
            <input
              type="text"
              id="username"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="Masukkan username"
              autocomplete="off"
              spellcheck="false"
              required
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Password</label
            >
            <input
              type="password"
              id="password"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="Masukkan password"
              required
            />
          </div>

          <button
            type="submit"
            class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium"
          >
            <i class="fas fa-sign-in-alt mr-2"></i>Masuk
          </button>
        </form>
      </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden min-h-screen flex">
      <!-- Sidebar -->
      <div
        id="sidebar"
        class="bg-gray-800 text-white w-64 min-h-screen sidebar-transition fixed lg:relative z-40 lg:translate-x-0 -translate-x-full"
      >
        <div class="p-6">
          <div class="flex items-center mb-8">
            <img
              id="storeLogoHeader"
              class="h-8 w-8 mr-3 rounded hidden"
              alt="Logo Toko"
            />
            <i
              id="storeLogoIcon"
              class="fas fa-motorcycle text-2xl text-blue-400 mr-3"
            ></i>
            <h1 id="storeNameHeader" class="text-xl font-bold">WMS</h1>
          </div>

          <nav class="space-y-2">
            <!-- Updated order -->
            <a
              href="#"
              onclick="navigateToSection('dashboard')"
              class="nav-item flex items-center px-4 py-3 rounded-lg hover:bg-gray-700 transition duration-200"
              data-menu="dashboard"
            >
              <i class="fas fa-tachometer-alt mr-3"></i
              ><span class="sidebar-text">Dashboard</span>
            </a>
            <a
              href="#"
              onclick="navigateToSection('settings')"
              class="nav-item flex items-center px-4 py-3 rounded-lg hover:bg-gray-700 transition duration-200"
              data-menu="settings"
            >
              <i class="fas fa-cog mr-3"></i
              ><span class="sidebar-text">Pengaturan Toko</span>
            </a>
            <a
              href="#"
              onclick="navigateToSection('users')"
              class="nav-item flex items-center px-4 py-3 rounded-lg hover:bg-gray-700 transition duration-200"
              data-menu="users"
            >
              <i class="fas fa-user-cog mr-3"></i
              ><span class="sidebar-text">Manajemen User</span>
            </a>
            <a
              href="#"
              onclick="navigateToSection('employees')"
              class="nav-item flex items-center px-4 py-3 rounded-lg hover:bg-gray-700 transition duration-200"
              data-menu="employees"
            >
              <i class="fas fa-users mr-3"></i
              ><span class="sidebar-text">Karyawan</span>
            </a>
            <a
              href="#"
              onclick="navigateToSection('services')"
              class="nav-item flex items-center px-4 py-3 rounded-lg hover:bg-gray-700 transition duration-200"
              data-menu="services"
            >
              <i class="fas fa-tools mr-3"></i
              ><span class="sidebar-text">Jasa Kendaraan</span>
            </a>
            <a
              href="#"
              onclick="navigateToSection('transaction')"
              class="nav-item flex items-center px-4 py-3 rounded-lg hover:bg-gray-700 transition duration-200"
              data-menu="transaction"
            >
              <i class="fas fa-cash-register mr-3"></i
              ><span class="sidebar-text">Transaksi</span>
            </a>
            <a
              href="#"
              onclick="navigateToSection('expenses')"
              class="nav-item flex items-center px-4 py-3 rounded-lg hover:bg-gray-700 transition duration-200"
              data-menu="expenses"
            >
              <i class="fas fa-wallet mr-3"></i
              ><span class="sidebar-text">Kas Keluar</span>
            </a>

            <!-- Menu Laporan (dropdown) -->
            <div class="dropdown-menu">
              <button
                type="button"
                class="nav-item flex items-center justify-between px-4 py-3 rounded-lg hover:bg-gray-700 transition duration-200 w-full"
                onclick="toggleReportMenu()"
                id="reportMenuBtn"
              >
                <div class="flex items-center">
                  <i class="fas fa-chart-bar mr-3"></i>
                  <span class="sidebar-text">Laporan</span>
                </div>
                <i
                  class="fas fa-chevron-down ml-auto text-xs transform transition duration-200 menu-icon"
                ></i>
              </button>

              <div id="reportSubMenu" class="flex flex-col">
                <a
                  href="#"
                  onclick="navigateToSection('report_profit_gross')"
                  class="nav-item flex items-center hover:bg-gray-700 transition duration-200"
                  data-menu="report_profit_gross"
                >
                  <i class="fas fa-coins mr-2"></i>
                  <span class="sidebar-text">Laba Kotor</span>
                </a>
                <a
                  href="#"
                  onclick="navigateToSection('report_transactions')"
                  class="nav-item flex items-center hover:bg-gray-700 transition duration-200"
                  data-menu="report_transactions"
                >
                  <i class="fas fa-file-invoice-dollar mr-2"></i>
                  <span class="sidebar-text">Transaksi</span>
                </a>
                <a
                  href="#"
                  onclick="navigateToSection('report_cash_out')"
                  class="nav-item flex items-center hover:bg-gray-700 transition duration-200"
                  data-menu="report_cash_out"
                >
                  <i class="fas fa-money-bill-wave mr-2"></i>
                  <span class="sidebar-text">Kas Keluar</span>
                </a>
                <a
                  href="#"
                  onclick="navigateToSection('report_profit_net')"
                  class="nav-item flex items-center hover:bg-gray-700 transition duration-200"
                  data-menu="report_profit_net"
                >
                  <i class="fas fa-calculator mr-2"></i>
                  <span class="sidebar-text">Laba Bersih</span>
                </a>
              </div>
            </div>
          </nav>
        </div>
      </div>

      <!-- Sidebar Overlay for Mobile -->
      <div
        id="sidebarOverlay"
        class="fixed inset-0 bg-black bg-opacity-50 z-30 lg:hidden hidden"
      ></div>

      <!-- Main Content -->
      <div class="flex-1 flex flex-col lg:ml-0">
        <header class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
          <div class="flex items-center justify-between">
            <button
              id="sidebarToggle"
              onclick="toggleSidebar()"
              class="lg:hidden text-gray-600 hover:text-gray-900 p-2 rounded-lg hover:bg-gray-100"
            >
              <i class="fas fa-bars text-xl"></i>
            </button>
            <h2 id="pageTitle" class="text-xl font-semibold text-gray-800">
              Dashboard
            </h2>

            <div class="relative">
              <button
                id="userMenuToggle"
                onclick="toggleUserMenu()"
                class="flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <div
                  class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center"
                >
                  <span
                    class="text-white text-sm font-semibold"
                    id="userInitial"
                    >A</span
                  >
                </div>

                <div class="hidden sm:block text-left">
                  <div
                    class="text-sm font-medium text-gray-900"
                    id="currentUser"
                  >
                    Admin
                  </div>
                  <div class="text-xs text-gray-500"></div>
                </div>

                <i
                  class="fas fa-chevron-down text-gray-400 text-sm transition-transform"
                  id="dropdownArrow"
                ></i>
              </button>

              <div
                id="userDropdown"
                class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-50 hidden"
              >
                <div class="px-4 py-3 border-b border-gray-100 sm:hidden">
                  <div
                    class="text-sm font-medium text-gray-900"
                    id="mobileCurrentUser"
                  >
                    Admin
                  </div>
                  <div class="text-xs text-gray-500"></div>
                </div>

                <button
                  onclick="navigateToSection('settings'); closeUserMenu();"
                  class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors"
                >
                  <i class="fas fa-cog mr-3 text-gray-400"></i>
                  Pengaturan
                </button>

                <div class="border-t border-gray-100 my-1"></div>

                <button
                  onclick="logout()"
                  class="flex items-center w-full px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors"
                >
                  <i class="fas fa-sign-out-alt mr-3 text-red-500"></i>
                  Keluar
                </button>
              </div>
            </div>
          </div>
        </header>

        <!-- Content Area -->
        <main class="flex-1 p-6 overflow-auto">
          <!-- Dashboard Section -->
          <div id="dashboardSection" class="section">
            <div
              class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"
            >
              <div
                class="bg-white p-6 rounded-lg shadow-sm border border-gray-200"
              >
                <div class="flex items-center">
                  <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                    <i class="fas fa-cash-register text-xl"></i>
                  </div>
                  <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">
                      Transaksi Hari Ini
                    </p>
                    <p
                      class="text-2xl font-semibold text-gray-900"
                      id="todayTransactions"
                    >
                      0
                    </p>
                  </div>
                </div>
              </div>

              <div
                class="bg-white p-6 rounded-lg shadow-sm border border-gray-200"
              >
                <div class="flex items-center">
                  <div class="p-3 rounded-full bg-green-100 text-green-600">
                    <i class="fas fa-money-bill-wave text-xl"></i>
                  </div>
                  <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">
                      Pendapatan Hari Ini
                    </p>
                    <p
                      class="text-2xl font-semibold text-gray-900"
                      id="todayRevenue"
                    >
                      Rp 0
                    </p>
                  </div>
                </div>
              </div>

              <div
                class="bg-white p-6 rounded-lg shadow-sm border border-gray-200"
              >
                <div class="flex items-center">
                  <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                    <i class="fas fa-users text-xl"></i>
                  </div>
                  <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">
                      Karyawan Hadir
                    </p>
                    <button
                      class="text-2xl font-semibold text-blue-600 underline"
                      id="presentEmployeesBtn"
                      onclick="showPresentEmployeesModal()"
                      style="background: none; border: none; cursor: pointer"
                    >
                      <span id="presentEmployees">0</span>
                    </button>
                  </div>
                </div>
              </div>

              <div
                class="bg-white p-6 rounded-lg shadow-sm border border-gray-200"
              >
                <div class="flex items-center">
                  <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                    <i class="fas fa-clock text-xl"></i>
                  </div>
                  <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Belum Bayar</p>
                    <p
                      class="text-2xl font-semibold text-gray-900"
                      id="unpaidTransactions"
                    >
                      0
                    </p>
                  </div>
                </div>
              </div>

              <!-- Tambahkan di grid dashboard -->
              <div
                class="bg-white p-6 rounded-lg shadow-sm border border-gray-200"
              >
                <div class="flex items-center">
                  <div class="p-3 rounded-full bg-red-100 text-red-600">
                    <i class="fas fa-wallet text-xl"></i>
                  </div>
                  <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">
                      Kas Keluar Hari Ini
                    </p>
                    <p
                      class="text-2xl font-semibold text-gray-900"
                      id="todayExpenses"
                    >
                      Rp 0
                    </p>
                  </div>
                </div>
              </div>
              <div
                class="bg-white p-6 rounded-lg shadow-sm border border-gray-200"
              >
                <div class="flex items-center">
                  <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                    <i class="fas fa-calculator text-xl"></i>
                  </div>
                  <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">
                      Laba Bersih Hari Ini
                    </p>
                    <p
                      class="text-2xl font-semibold text-gray-900"
                      id="todayNetProfit"
                    >
                      Rp 0
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div
            id="presentEmployeesModal"
            class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
          >
            <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
              <h3 class="text-lg font-semibold mb-4">
                Karyawan Hadir Hari Ini
              </h3>
              <ul id="presentEmployeesListModal" class="space-y-2"></ul>
              <button
                onclick="closePresentEmployeesModal()"
                class="mt-4 w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700"
              >
                Tutup
              </button>
            </div>
          </div>

          <!-- Transaction Section -->
          <div id="transactionSection" class="section hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <!-- Transaction Form -->
              <div
                class="bg-white p-6 rounded-lg shadow-sm border border-gray-200"
              >
                <h3 class="text-lg font-semibold mb-4">Transaksi Baru</h3>

                <!-- Employee Validation Alert -->
                <div
                  id="employeeValidation"
                  class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg hidden"
                >
                  <div class="flex items-center">
                    <i
                      class="fas fa-exclamation-triangle text-yellow-600 mr-3"
                    ></i>
                    <div>
                      <p class="text-sm font-medium text-yellow-800">
                        Peringatan!
                      </p>
                      <p class="text-sm text-yellow-700">
                        Tidak ada karyawan yang hadir. Mohon set kehadiran
                        karyawan terlebih dahulu di menu Karyawan.
                      </p>
                    </div>
                  </div>
                </div>

                <form id="transactionForm" class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                      >Nomor Polisi
                      <span class="text-gray-400">(Opsional)</span></label
                    >
                    <input
                      type="text"
                      id="plateNumber"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="Contoh: B 1234 ABC"
                      autocomplete="off"
                      spellcheck="false"
                    />
                  </div>

                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                      >Jenis Kendaraan</label
                    >
                    <div class="relative">
                      <input
                        type="text"
                        id="vehicleSearch"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Ketik untuk mencari jenis kendaraan..."
                        autocomplete="off"
                        spellcheck="false"
                        required
                      />
                      <input type="hidden" id="selectedServiceId" />
                      <div class="absolute right-3 top-3 text-gray-400">
                        <i class="fas fa-search"></i>
                      </div>
                      <div
                        id="vehicleDropdown"
                        class="absolute z-20 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-60 overflow-y-auto hidden"
                      >
                        <!-- Vehicle options will be populated here -->
                      </div>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                      Gunakan ↑↓ untuk navigasi, Enter untuk memilih, Esc untuk
                      tutup
                    </div>
                  </div>

                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                      >Harga</label
                    >
                    <input
                      type="number"
                      id="price"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      readonly
                    />
                  </div>

                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                      >Catatan
                      <span class="text-gray-400">(Opsional)</span></label
                    >
                    <textarea
                      id="transactionNotes"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      rows="2"
                      placeholder="Tambahkan catatan khusus..."
                      autocomplete="off"
                      spellcheck="false"
                    ></textarea>
                  </div>

                  <!-- Employee Display -->
                  <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <h4 class="text-sm font-medium text-blue-800 mb-2">
                      <i class="fas fa-users mr-2"></i>Karyawan Hadir Hari Ini
                    </h4>
                    <div
                      id="presentEmployeesList"
                      class="text-sm text-blue-700"
                    >
                      <!-- Present employees will be loaded here -->
                    </div>
                  </div>

                  <div class="flex space-x-3">
                    <button
                      type="button"
                      onclick="processTransaction('pay')"
                      id="payButton"
                      class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed"
                    >
                      <i class="fas fa-credit-card mr-2"></i>Bayar
                    </button>
                    <button
                      type="button"
                      onclick="processTransaction('save')"
                      id="saveButton"
                      class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed"
                    >
                      <i class="fas fa-save mr-2"></i>Simpan
                    </button>
                  </div>
                </form>
              </div>

              <!-- Receipt Preview -->
              <div
                class="bg-white p-6 rounded-lg shadow-sm border border-gray-200"
              >
                <h3 class="text-lg font-semibold mb-4">
                  Preview Struk Thermal (58x30mm)
                </h3>
                <div
                  class="receipt-preview thermal-print"
                  id="receiptPreview"
                >
                  <div class="text-center mb-1">
                    <img
                      id="receiptLogoPreview"
                      class="h-10 w-10 mx-auto mb-1 rounded hidden"
                      alt="Logo Struk"
                    />
                    <div class="font-bold text-xs" id="receiptStoreName">
                      WASH MOTOR
                    </div>
                    <div class="text-xs" id="receiptStoreAddress">
                      Jl. Contoh No. 123
                    </div>
                    <div class="text-xs" id="receiptStorePhone">
                      Telp: 021-12345678
                    </div>
                  </div>
                  <div
                    class="border-t border-b border-dashed border-gray-400 py-1 my-1"
                  >
                    <div class="text-xs">
                      No: <span id="receiptNumber"></span>
                    </div>
                    <div class="text-xs">
                      Tanggal: <span id="receiptDate"></span>
                    </div>
                    <div class="text-xs">
                      Plat: <span id="receiptPlate">-</span>
                    </div>
                  </div>
                  <div class="text-xs mb-1">
                    <div class="flex justify-between">
                      <span id="receiptService">Cuci Motor</span>
                      <span id="receiptPrice">Rp 0</span>
                    </div>
                    <div id="receiptNotesSection" class="mt-1 hidden">
                      <div class="text-xs text-gray-600">Catatan:</div>
                      <div class="text-xs" id="receiptNotes"></div>
                    </div>
                  </div>
                  <div class="border-t border-dashed border-gray-400 pt-1">
                    <div class="flex justify-between font-bold text-xs">
                      <span>TOTAL</span>
                      <span id="receiptTotal">Rp 0</span>
                    </div>
                  </div>
                  <div class="text-center text-xs mt-1" id="receiptFooter">
                    Terima kasih
                  </div>
                </div>
              </div>
            </div>

            <!-- Transaction List -->
            <div
              class="mt-8 bg-white rounded-lg shadow-sm border border-gray-200"
            >
              <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                  <h3 class="text-lg font-semibold">Daftar Transaksi</h3>
                  <div class="flex items-center space-x-4">
                    <button
                      onclick="loadTransactions()"
                      class="text-gray-600 hover:text-gray-800 p-2 rounded-lg hover:bg-gray-100"
                      title="Refresh Data"
                    >
                      <i class="fas fa-sync-alt"></i>
                    </button>
                  </div>
                </div>

                <!-- Filter Tabs -->
                <div class="border-b border-gray-200 mb-6">
                  <nav class="-mb-px flex space-x-8">
                    <button
                      id="paidTabBtn"
                      onclick="switchTransactionView('paid')"
                      class="tab-button active py-3 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600 flex items-center"
                    >
                      <i class="fas fa-check-circle mr-2"></i>
                      Sudah Bayar
                      <span
                        id="paidTabCount"
                        class="ml-2 bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full"
                        >0</span
                      >
                    </button>
                    <button
                      id="unpaidTabBtn"
                      onclick="switchTransactionView('unpaid')"
                      class="tab-button py-3 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 flex items-center"
                    >
                      <i class="fas fa-clock mr-2"></i>
                      Belum Bayar
                      <span
                        id="unpaidTabCount"
                        class="ml-2 bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded-full"
                        >0</span
                      >
                    </button>
                  </nav>
                </div>

                <!-- Transaction Filters -->
                <div
                  class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-4 space-y-4 lg:space-y-0"
                >
                  <div class="flex flex-wrap gap-3">
                    <select
                      id="statusFilter"
                      class="px-3 py-2 border border-gray-300 rounded-lg"
                    >
                      <option value="paid">Sudah Bayar</option>
                      <option value="unpaid">Belum Bayar</option>
                    </select>
                    <select
                      id="paymentFilter"
                      class="px-3 py-2 border border-gray-300 rounded-lg"
                    >
                      <option value="">Semua Metode</option>
                      <option value="cash">Tunai</option>
                      <option value="transfer">Transfer</option>
                      <option value="qris">QRIS</option>
                    </select>
                    <div class="flex items-center space-x-2">
                      <label class="text-sm font-medium text-gray-700"
                        >Dari:</label
                      >
                      <input
                        type="date"
                        id="dateFrom"
                        class="px-3 py-2 border border-gray-300 rounded-lg text-sm"
                      />
                    </div>
                    <div class="flex items-center space-x-2">
                      <label class="text-sm font-medium text-gray-700"
                        >Sampai:</label
                      >
                      <input
                        type="date"
                        id="dateTo"
                        class="px-3 py-2 border border-gray-300 rounded-lg text-sm"
                      />
                    </div>
                    <button
                      onclick="resetDateFilter()"
                      class="px-3 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 text-sm"
                      title="Reset Filter Tanggal"
                    >
                      <i class="fas fa-undo mr-1"></i>Reset
                    </button>
                    <select
                      id="rowsPerPage"
                      class="px-3 py-2 border border-gray-300 rounded-lg"
                    >
                      <option value="10">10 per halaman</option>
                      <option value="25">25 per halaman</option>
                      <option value="50">50 per halaman</option>
                    </select>
                  </div>
                  <div class="text-sm text-gray-600">
                    Total: <span id="totalCount">0</span> transaksi
                  </div>
                </div>

                <!-- Transaction List -->
                <div id="transactionsList" class="space-y-3 min-h-[400px]">
                  <!-- Transactions will be loaded here -->
                </div>

                <!-- Pagination -->
                <div
                  id="transactionsPagination"
                  class="flex justify-center items-center space-x-2 mt-6"
                >
                  <!-- Pagination will be loaded here -->
                </div>
              </div>
            </div>
          </div>

          <!-- Services Section -->
          <div id="servicesSection" class="section hidden">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
              <div class="p-6">
                <div
                  class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 space-y-4 lg:space-y-0"
                >
                  <h3 class="text-lg font-semibold">Jasa Kendaraan</h3>
                  <div
                    class="flex flex-col lg:flex-row items-start lg:items-center space-y-3 lg:space-y-0 lg:space-x-4 w-full lg:w-auto"
                  >
                    <div class="relative w-full lg:w-80">
                      <input
                        type="text"
                        id="serviceSearchInput"
                        class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Cari jasa kendaraan..."
                        autocomplete="off"
                        spellcheck="false"
                      />
                      <div class="absolute left-3 top-3 text-gray-400">
                        <i class="fas fa-search"></i>
                      </div>
                    </div>
                    <button
                      onclick="showServiceModal()"
                      class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200 whitespace-nowrap"
                    >
                      <i class="fas fa-plus mr-2"></i>Tambah Jasa
                    </button>
                  </div>
                </div>

                <!-- Services Table -->
                <div class="overflow-x-auto">
                  <table class="w-full border-collapse">
                    <thead>
                      <tr class="bg-gray-50 border-b border-gray-200">
                        <th
                          class="text-left py-3 px-4 font-semibold text-gray-700"
                        >
                          No
                        </th>
                        <th
                          class="text-left py-3 px-4 font-semibold text-gray-700"
                        >
                          Nama Jasa
                        </th>
                        <th
                          class="text-left py-3 px-4 font-semibold text-gray-700"
                        >
                          Harga
                        </th>
                        <th
                          class="text-center py-3 px-4 font-semibold text-gray-700"
                        >
                          Aksi
                        </th>
                      </tr>
                    </thead>
                    <tbody id="servicesTableBody">
                      <!-- Services will be loaded here -->
                    </tbody>
                  </table>
                </div>

                <!-- Empty State -->
                <div id="servicesEmptyState" class="text-center py-12 hidden">
                  <div
                    class="bg-gray-100 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-4"
                  >
                    <i class="fas fa-tools text-3xl text-gray-400"></i>
                  </div>
                  <h3 class="text-lg font-medium text-gray-900 mb-2">
                    Belum Ada Jasa
                  </h3>
                  <p class="text-gray-500 mb-4">
                    Jasa kendaraan yang Anda cari tidak ditemukan
                  </p>
                  <button
                    onclick="clearServiceSearch()"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                  >
                    <i class="fas fa-times mr-2"></i>Hapus Filter
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Employees Section -->
          <div id="employeesSection" class="section hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <!-- Employee Management -->
              <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="p-6">
                  <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">Daftar Karyawan</h3>
                    <button
                      onclick="showEmployeeModal()"
                      class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200"
                    >
                      <i class="fas fa-plus mr-2"></i>Tambah Karyawan
                    </button>
                  </div>

                  <div id="employeesList" class="space-y-3">
                    <!-- Employees will be loaded here -->
                  </div>
                </div>
              </div>

              <!-- Salary Settings -->
              <div class="bg-white rounded-lg shadow-sm border border-gray-200" id="salarySettingsBox">
                <div class="p-6">
                  <h3 class="text-lg font-semibold mb-6">Pengaturan Gaji</h3>

                  <div class="space-y-4">
                    <div>
                      <label
                        class="block text-sm font-medium text-gray-700 mb-2"
                        >Gaji per Motor</label
                      >
                      <input
                        type="number"
                        id="salaryPerMotor"
                        value="7000"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      />
                    </div>

                    <button
                      onclick="updateSalarySettings()"
                      class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition duration-200"
                    >
                      <i class="fas fa-save mr-2"></i>Simpan Pengaturan
                    </button>

                    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                      <h4 class="font-medium mb-2">Ringkasan Gaji Hari Ini</h4>
                      <div class="text-sm text-gray-600 space-y-1">
                        <div class="flex justify-between">
                          <span>Karyawan Hadir:</span>
                          <span id="presentCount" class="font-medium">0</span>
                        </div>
                        <div class="flex justify-between">
                          <span>Total Transaksi:</span>
                          <span id="totalTransactions" class="font-medium"
                            >0</span
                          >
                        </div>
                        <div class="flex justify-between">
                          <span>Gaji per Karyawan:</span>
                          <span id="salaryPerEmployee" class="font-medium"
                            >Rp 0</span
                          >
                        </div>
                        <div class="border-t pt-2 mt-2">
                          <div
                            class="flex justify-between font-semibold text-green-600"
                          >
                            <span>Total Gaji:</span>
                            <span id="totalSalary">Rp 0</span>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Attendance Management -->
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                      <h4 class="font-medium mb-3 text-blue-800">
                        Manajemen Kehadiran
                      </h4>
                      <div class="flex space-x-2">
                        <button
                          onclick="markAllPresent()"
                          class="flex-1 bg-blue-600 text-white py-2 px-3 rounded text-sm hover:bg-blue-700 transition duration-200"
                        >
                          <i class="fas fa-user-check mr-1"></i>Semua Hadir
                        </button>
                        <button
                          onclick="markAllAbsent()"
                          class="flex-1 bg-gray-600 text-white py-2 px-3 rounded text-sm hover:bg-gray-700 transition duration-200"
                        >
                          <i class="fas fa-user-times mr-1"></i>Semua Tidak
                          Hadir
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Users Section -->
          <div id="usersSection" class="section hidden">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
              <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                  <h3 class="text-lg font-semibold">Manajemen User</h3>
                  <button
                    onclick="showUserModal()"
                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200"
                  >
                    <i class="fas fa-plus mr-2"></i>Tambah User
                  </button>
                </div>

                <div id="usersList" class="space-y-3">
                  <!-- Users will be loaded here -->
                </div>
              </div>
            </div>
          </div>

          <!-- Settings Section -->
          <div id="settingsSection" class="section hidden">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
              <div class="p-6">
                <h3 class="text-lg font-semibold mb-6">Pengaturan Toko</h3>

                <form id="storeSettingsForm" class="space-y-6">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                      <label
                        class="block text-sm font-medium text-gray-700 mb-2"
                        >Nama Toko</label
                      >
                      <input
                        type="text"
                        id="storeName"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        value="WASH MOTOR"
                      />
                    </div>

                    <div>
                      <label
                        class="block text-sm font-medium text-gray-700 mb-2"
                        >Nomor Telepon</label
                      >
                      <input
                        type="text"
                        id="storePhone"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        value="021-12345678"
                      />
                    </div>
                  </div>

                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                      >Alamat Toko</label
                    >
                    <textarea
                      id="storeAddress"
                      rows="3"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
Jl. Contoh No. 123</textarea
                    >
                  </div>

                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                      >Email Toko</label
                    >
                    <input
                      type="text"
                      id="storeEmail"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      value="info@washmotor.com"
                    />
                  </div>

                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                      >Pesan Footer Struk</label
                    >
                    <textarea
                      id="receiptFooterMessage"
                      rows="2"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
Terima kasih atas kunjungan Anda</textarea
                    >
                  </div>

                  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                      <label
                        class="block text-sm font-medium text-gray-700 mb-2"
                        >Margin Atas</label
                      >
                      <input
                        type="number"
                        id="marginTop"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        value="5"
                      />
                    </div>
                    <div>
                      <label
                        class="block text-sm font-medium text-gray-700 mb-2"
                        >Margin Kiri</label
                      >
                      <input
                        type="number"
                        id="marginLeft"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        value="5"
                      />
                    </div>
                    <div>
                      <label
                        class="block text-sm font-medium text-gray-700 mb-2"
                        >Margin Kanan</label
                      >
                      <input
                        type="number"
                        id="marginRight"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        value="5"
                      />
                    </div>
                    <div>
                      <label
                        class="block text-sm font-medium text-gray-700 mb-2"
                        >Margin Bawah</label
                      >
                      <input
                        type="number"
                        id="marginBottom"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        value="5"
                      />
                    </div>
                  </div>

                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                      >Font Struk</label
                    >
                    <select
                      id="receiptFont"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                      <option value="Courier New">Courier New</option>
                      <option value="Arial">Arial</option>
                      <option value="Times New Roman">Times New Roman</option>
                    </select>
                  </div>

                  <!-- Logo Usaha -->
                  <!-- Logo Usaha Section - Clean Version -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                      >Logo Usaha (PNG)</label
                    >

                    <div class="flex items-center gap-4">
                      <!-- Preview dengan reset button -->
                      <div class="relative">
                        <div
                          class="w-16 h-16 rounded border border-gray-200 bg-gray-50 flex items-center justify-center overflow-hidden"
                        >
                          <img
                            id="storeLogoPreview"
                            alt="Logo Preview"
                            class="max-w-full max-h-full"
                            style="display: none"
                          />
                        </div>

                        <!-- Reset Button -->
                        <button
                          type="button"
                          id="logoResetBtn"
                          class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center text-xs font-bold transition-colors duration-200 shadow-md hidden"
                          title="Hapus logo"
                        >
                          ×
                        </button>
                      </div>

                      <div class="flex-1">
                        <input type="hidden" id="logoUrlCurrent" />
                        <input
                          type="file"
                          id="storeLogoFile"
                          accept="image/png"
                          class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                          onchange="handleLogoFileChange(event)"
                        />
                        <p class="mt-1 text-xs text-gray-500">
                          *Format PNG transparan. Maksimal 300 KB, ukuran
                          256×256–512×512 px.
                        </p>
                      </div>
                    </div>
                  </div>

                  <button
                    type="submit"
                    onclick="saveStoreSettings()"
                    class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition duration-200"
                  >
                    <i class="fas fa-save mr-2"></i>Simpan Pengaturan
                  </button>
                </form>
              </div>
            </div>
          </div>

          <!-- ...Kas Keluar... -->
          <div id="expensesSection" class="section hidden">
            <div
              class="bg-white rounded-lg shadow-sm border border-gray-200 p-6"
            >
              <h3 class="text-lg font-semibold mb-4">Kas Keluar</h3>
              <!-- Form Input Pengeluaran Baru -->
              <form id="expenseForm" class="space-y-4 mb-8">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Tanggal</label
                  >
                  <input
                    type="date"
                    id="expenseDate"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                    required
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Kategori</label
                  >
                  <select
                    id="expenseCategory"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                    required
                  >
                    <option value="">Pilih Kategori</option>
                    <option value="Operasional">Operasional</option>
                    <option value="Peralatan">Peralatan</option>
                    <option value="Maintenance">Maintenance</option>
                    <option value="Transport">Transport</option>
                    <option value="Lainnya">Lainnya</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Nominal</label
                  >
                  <input
                    type="number"
                    id="expenseAmount"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                    required
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Deskripsi</label
                  >
                  <input
                    type="text"
                    id="expenseDescription"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                    required
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Catatan (Opsional)</label
                  >
                  <textarea
                    id="expenseNotes"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                  ></textarea>
                </div>
                <button
                  type="submit"
                  class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200"
                >
                  <i class="fas fa-save mr-2"></i>Simpan Pengeluaran
                </button>
              </form>
              <!-- Ringkasan Harian -->
              <div class="mb-8">
                <h4 class="text-md font-semibold mb-2">Ringkasan Harian</h4>
                <div id="expenseSummary" class="text-lg font-bold text-red-600">
                  Rp 0
                </div>
                <div id="expenseStats" class="text-sm text-gray-600"></div>
              </div>
              <!-- Filter Advanced -->
              <div class="mb-6 flex flex-wrap gap-3">
                <input
                  type="date"
                  id="expenseFilterFrom"
                  class="px-3 py-2 border border-gray-300 rounded-lg"
                  placeholder="Dari"
                />
                <input
                  type="date"
                  id="expenseFilterTo"
                  class="px-3 py-2 border border-gray-300 rounded-lg"
                  placeholder="Sampai"
                />
                <select
                  id="expenseFilterCategory"
                  class="px-3 py-2 border border-gray-300 rounded-lg"
                >
                  <option value="">Semua Kategori</option>
                  <option value="Operasional">Operasional</option>
                  <option value="Peralatan">Peralatan</option>
                  <option value="Maintenance">Maintenance</option>
                  <option value="Transport">Transport</option>
                  <option value="Lainnya">Lainnya</option>
                </select>
                <button
                  onclick="resetExpenseFilter()"
                  class="px-3 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 text-sm"
                >
                  <i class="fas fa-undo mr-1"></i>Reset
                </button>
              </div>
              <!-- Daftar Kas Keluar -->
              <div id="expensesList" class="space-y-3 min-h-[200px]">
                <!-- Data pengeluaran akan ditampilkan di sini -->
              </div>
            </div>
          </div>
<!-- Section Laba Kotor -->
<div id="report_profit_grossSection" class="section hidden">
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    <h3 class="text-lg font-semibold mb-4">Laporan Laba Kotor</h3>
    <div class="flex flex-wrap gap-3 mb-4">
  <input type="date" id="grossReportFrom" class="px-3 py-2 border border-gray-300 rounded-lg" />
  <input type="date" id="grossReportTo" class="px-3 py-2 border border-gray-300 rounded-lg" />
  <button onclick="searchGrossProfitReport()" class="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 flex items-center" title="Cari">
    <i class="fas fa-search"></i>
  </button>
<button onclick="showExportGrossProfitModal()" class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 flex items-center" title="Export Excel">
  <i class="fas fa-file-excel"></i>
</button>
</div>
    <div class="overflow-x-auto">
      <table class="w-full border-collapse" id="grossProfitTable">
        <thead>
          <tr class="bg-gray-50 border-b border-gray-200">
            <th class="py-2 px-4">No</th>
            <th class="py-2 px-4">Tanggal</th>
            <th class="py-2 px-4">Nama Motor</th>
            <th class="py-2 px-4">Catatan</th>
            <th class="py-2 px-4">Harga</th>
            <th class="py-2 px-4">Karyawan Hadir</th>
          </tr>
        </thead>
        <tbody id="grossProfitTableBody">
          <!-- Data akan ditampilkan di sini -->
        </tbody>
      </table>
    </div><!-- Ringkasan Statistik -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <!-- Total Pendapatan -->
      <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
        <div class="flex items-center justify-between mb-2">
          <h4 class="text-sm font-medium text-green-800">Total Pendapatan</h4>
          <i class="fas fa-money-bill-wave text-green-600"></i>
        </div>
        <p class="text-2xl font-bold text-green-700" id="totalRevenue">Rp 0</p>
      </div>
      
      <!-- Motor 20.000 -->
      <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
        <div class="flex items-center justify-between mb-2">
          <h4 class="text-sm font-medium text-blue-800">Motor Rp 20.000</h4>
          <i class="fas fa-motorcycle text-blue-600"></i>
        </div>
        <p class="text-2xl font-bold text-blue-700" id="motor20k">0 unit</p>
      </div>
      
      <!-- Motor 25.000 -->
      <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
        <div class="flex items-center justify-between mb-2">
          <h4 class="text-sm font-medium text-purple-800">Motor Rp 25.000</h4>
          <i class="fas fa-motorcycle text-purple-600"></i>
        </div>
        <p class="text-2xl font-bold text-purple-700" id="motor25k">0 unit</p>
      </div>
      
      <!-- Motor 30.000 -->
      <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-lg border border-orange-200">
        <div class="flex items-center justify-between mb-2">
          <h4 class="text-sm font-medium text-orange-800">Motor Rp 30.000</h4>
          <i class="fas fa-motorcycle text-orange-600"></i>
        </div>
        <p class="text-2xl font-bold text-orange-700" id="motor30k">0 unit</p>
      </div>
      
      <!-- Transaksi dengan Sabun -->
      <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 p-4 rounded-lg border border-yellow-200">
        <div class="flex items-center justify-between mb-2">
          <h4 class="text-sm font-medium text-yellow-800">Pakai Sabun</h4>
          <i class="fas fa-soap text-yellow-600"></i>
        </div>
        <p class="text-2xl font-bold text-yellow-700" id="soapCount">0 kali</p>
      </div>
    </div>
  </div>
<!-- Modal HTML yang diperbarui -->
<div id="exportGrossProfitModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
    <h3 class="text-lg font-semibold mb-4 text-center" id="exportGrossProfitTitle">Export Laporan Laba Kotor</h3>
    <p class="mb-4 text-gray-700 text-center text-sm" id="exportGrossProfitFilename"></p>
    
    <!-- Download Button -->
    <div class="mb-4">
      <button onclick="downloadGrossProfitExcel()" class="w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 flex items-center justify-center transition-colors" title="Download Excel">
        <i class="fas fa-download mr-2"></i>Download Excel
      </button>
    </div>
    
    <!-- Divider -->
    <div class="flex items-center my-4">
      <div class="flex-1 border-t border-gray-300"></div>
      <span class="px-3 text-sm text-gray-500">atau bagikan via</span>
      <div class="flex-1 border-t border-gray-300"></div>
    </div>
    
    <!-- Share Options -->
    <div class="grid grid-cols-2 gap-3 mb-4">
      <button onclick="shareViaWhatsApp()" class="bg-green-500 text-white px-4 py-3 rounded-lg hover:bg-green-600 flex items-center justify-center transition-colors" title="Bagikan via WhatsApp">
        <i class="fab fa-whatsapp mr-2 text-lg"></i>WhatsApp
      </button>
      <button onclick="shareViaEmail()" class="bg-blue-500 text-white px-4 py-3 rounded-lg hover:bg-blue-600 flex items-center justify-center transition-colors" title="Bagikan via Email">
        <i class="fas fa-envelope mr-2"></i>Email
      </button>
    </div>
    
    <button onclick="closeExportGrossProfitModal()" class="w-full bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">Tutup</button>
  </div>
</div>
    </div>
    
<!-- Section Detail Transaksi -->
<div id="report_transactionsSection" class="section hidden">
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    <h3 class="text-lg font-semibold mb-4">Laporan Detail Transaksi</h3>
    <div class="flex flex-wrap gap-3 mb-4">
      <input type="date" id="rd_transaksiFrom" class="px-3 py-2 border border-gray-300 rounded-lg" />
      <input type="date" id="rd_transaksiTo" class="px-3 py-2 border border-gray-300 rounded-lg" />
      <button onclick="searchDetailTransactions()" class="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 flex items-center" title="Cari">
        <i class="fas fa-search"></i>
      </button>
      <button onclick="showExportDetailTransactions()" class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 flex items-center" title="Export Excel">
        <i class="fas fa-file-excel"></i>
      </button>
</div> <!-- End Section -->    
    <!-- Tabel Laporan -->
    <div class="overflow-x-auto mb-6">
      <table class="w-full border-collapse" id="detail_transaksi_tabel">
        <thead>
          <tr class="bg-gray-50 border-b border-gray-200">
            <th class="py-2 px-4">No</th>
            <th class="py-2 px-4">Tanggal</th>
            <th class="py-2 px-4">Nama Motor</th>
            <th class="py-2 px-4">Nomor Polisi</th>
            <th class="py-2 px-4">Catatan</th>
            <th class="py-2 px-4">Harga</th>
            <th class="py-2 px-4">Karyawan Hadir</th>
            <th class="py-2 px-4">Gaji Karyawan</th>
          </tr>
        </thead>
        <tbody id="detail_transaksi_TableBody">
          <!-- Data akan ditampilkan di sini -->
        </tbody>
      </table>
      <!-- Statistik Ringkasan Laporan Detail Transaksi -->
    </div> <!-- End Tabel Laporan -->

<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
  <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
    <h4 class="text-sm font-medium text-green-800 mb-2">Total Pendapatan</h4>
    <p class="text-2xl font-bold text-green-700" id="dt_totalRevenue">Rp 0</p>
  </div>
  <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
    <h4 class="text-sm font-medium text-blue-800 mb-2">Total Transaksi</h4>
    <p class="text-2xl font-bold text-blue-700" id="dt_totalTransactions">0 transaksi</p>
  </div>
  <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
    <h4 class="text-sm font-medium text-purple-800 mb-2">Total Gaji Karyawan</h4>
    <p class="text-2xl font-bold text-purple-700" id="dt_totalSalary">Rp 0</p>
</div> <!-- End Statistik Ringkasan -->
  </div> <!-- End Card Container -->

  </div> <!-- End Section -->
</div> <!-- End Section -->

<!-- Section Kas Keluar -->
<div id="report_cash_outSection" class="section hidden">
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    <h3 class="text-lg font-semibold mb-4">Laporan Kas Keluar</h3>
    <div class="flex flex-wrap gap-3 mb-4">
      <input type="date" id="KasKeluar_From" class="px-3 py-2 border border-gray-300 rounded-lg" />
      <input type="date" id="KasKeluar_To" class="px-3 py-2 border border-gray-300 rounded-lg" />
      <button onclick="searchDetailKaskeluar()" class="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 flex items-center" title="Cari">
        <i class="fas fa-search"></i>
      </button>
      <button onclick="showExportDetailKaskeluar()" class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 flex items-center" title="Export Excel">
        <i class="fas fa-file-excel"></i>
      </button>
</div> <!-- End Section -->    
    
    <!-- Tabel Laporan -->
    <div class="overflow-x-auto mb-6">
      <table class="w-full border-collapse" id="detail_kaskeluar_tabel">
        <thead>
          <tr class="bg-gray-50 border-b border-gray-200">
            <th class="py-2 px-4">No</th>
            <th class="py-2 px-4">Tanggal</th>
            <th class="py-2 px-4">Kategori</th>
            <th class="py-2 px-4">Deskripsi</th>
            <th class="py-2 px-4">Catatan</th>
            <th class="py-2 px-4">Nominal</th>
          </tr>
        </thead>
        <tbody id="detail_kaskeluar_TableBody">
          <!-- Data akan ditampilkan di sini -->
        </tbody>
      </table>
      <!-- Statistik Ringkasan Laporan Total Kas Keluar -->
    </div> <!-- End Tabel Laporan -->

<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
  <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
    <h4 class="text-sm font-medium text-green-800 mb-2">Total Pengeluaran</h4>
    <p class="text-2xl font-bold text-green-700" id="kk_totalexpenses">Rp 0</p>
  </div>
  <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
    <h4 class="text-sm font-medium text-blue-800 mb-2">Total Transaksi</h4>
    <p class="text-2xl font-bold text-blue-700" id="kk_totalTransactions">0 transaksi</p>
  </div>
  </div> <!-- End Card Container -->
  </div>
   </div>
  
   <!-- Section Laba Bersih -->
<div id="report_profit_netSection" class="section">
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <div class="bg-green-100 p-3 rounded-lg">
          <i class="fas fa-chart-line text-green-600 text-xl"></i>
        </div>
        <div>
          <h3 class="text-xl font-bold text-gray-800">Laporan Laba Bersih</h3>
          <p class="text-sm text-gray-500">Analisis pendapatan dan pengeluaran</p>
        </div>
      </div>
    </div>

    <!-- Filter Section -->
    <div class="bg-gray-50 rounded-lg p-4 mb-6">
      <div class="flex flex-wrap items-center gap-3">
        <div class="flex-1 min-w-[200px]">
          <label class="block text-sm font-medium text-gray-700 mb-1">Dari Tanggal</label>
          <input type="date" id="LabaBersih_From" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
        </div>
        <div class="flex-1 min-w-[200px]">
          <label class="block text-sm font-medium text-gray-700 mb-1">Sampai Tanggal</label>
          <input type="date" id="LabaBersih_To" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
        </div>
        <div class="flex gap-2 mt-6">
          <button onclick="searchLabaBersih()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
            <i class="fas fa-search"></i>
            <!-- <span>Cari</span> -->
          </button>
          <button onclick="resetFilterLabaBersih()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition flex items-center gap-2">
            <i class="fas fa-redo"></i>
            <!-- <span>Reset</span> -->
          </button>
          <button onclick="showExportLabaBersih()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition flex items-center gap-2">
            <i class="fas fa-file-excel"></i>
            <!-- <span>Export</span> -->
          </button>
        </div>
      </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <!-- Total Pendapatan -->
      <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm font-medium text-blue-700">Total Pendapatan</span>
          <i class="fas fa-arrow-up text-blue-600"></i>
        </div>
        <div class="text-2xl font-bold text-blue-900" id="lb_totalRevenue">Rp 0</div>
        <div class="text-xs text-blue-600 mt-1" id="lb_revenueCount">0 transaksi</div>
      </div>

      <!-- Total Pengeluaran -->
      <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-lg p-4 border border-red-200">
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm font-medium text-red-700">Total Pengeluaran</span>
          <i class="fas fa-arrow-down text-red-600"></i>
        </div>
        <div class="text-2xl font-bold text-red-900" id="lb_totalExpenses">Rp 0</div>
        <div class="text-xs text-red-600 mt-1" id="lb_expensesCount">0 transaksi</div>
      </div>

      <!-- Total Gaji Karyawan -->
      <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg p-4 border border-orange-200">
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm font-medium text-orange-700">Total Gaji</span>
          <i class="fas fa-users text-orange-600"></i>
        </div>
        <div class="text-2xl font-bold text-orange-900" id="lb_totalSalary">Rp 0</div>
        <div class="text-xs text-orange-600 mt-1" id="lb_salaryInfo">-</div>
      </div>

      <!-- Laba Bersih -->
      <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border border-green-200">
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm font-medium text-green-700">Laba Bersih</span>
          <i class="fas fa-coins text-green-600"></i>
        </div>
        <div class="text-2xl font-bold text-green-900" id="lb_netProfit">Rp 0</div>
        <div class="text-xs text-green-600 mt-1" id="lb_profitMargin">Margin: 0%</div>
      </div>
    </div>

    <!-- Detail Breakdown -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
      <!-- Pendapatan Detail -->
      <div class="bg-white rounded-lg border border-gray-200 p-4">
        <h4 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
          <i class="fas fa-money-bill-wave text-blue-600"></i>
          Rincian Pendapatan
        </h4>
        <div class="space-y-2">
          <div class="flex justify-between items-center py-2 border-b border-gray-100">
            <span class="text-sm text-gray-600">Pendapatan Kotor</span>
            <span class="font-semibold text-gray-800" id="lb_detail_revenue">Rp 0</span>
          </div>
          <div class="flex justify-between items-center py-2">
            <span class="text-sm text-gray-600">Jumlah Transaksi</span>
            <span class="font-semibold text-gray-800" id="lb_detail_trxCount">0</span>
          </div>
        </div>
      </div>

      <!-- Pengeluaran Detail -->
      <div class="bg-white rounded-lg border border-gray-200 p-4">
        <h4 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
          <i class="fas fa-receipt text-red-600"></i>
          Rincian Pengeluaran
        </h4>
        <div class="space-y-2">
          <div class="flex justify-between items-center py-2 border-b border-gray-100">
            <span class="text-sm text-gray-600">Pengeluaran Operasional</span>
            <span class="font-semibold text-gray-800" id="lb_detail_expenses">Rp 0</span>
          </div>
          <div class="flex justify-between items-center py-2 border-b border-gray-100">
            <span class="text-sm text-gray-600">Gaji Karyawan</span>
            <span class="font-semibold text-gray-800" id="lb_detail_salary">Rp 0</span>
          </div>
          <div class="flex justify-between items-center py-2 font-semibold border-t-2 border-gray-300">
            <span class="text-sm text-gray-700">Total Pengeluaran</span>
            <span class="text-gray-900" id="lb_detail_totalOut">Rp 0</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Profit Analysis -->
    <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border-2 border-green-200 p-6">
      <div class="flex items-center justify-between">
        <div class="flex-1">
          <h4 class="text-lg font-bold text-gray-800 mb-2">Analisis Laba Bersih</h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <span class="text-sm text-gray-600">Formula:</span>
              <p class="text-sm font-medium text-gray-800 mt-1">
                Pendapatan - (Pengeluaran + Gaji)
              </p>
            </div>
            <div>
              <span class="text-sm text-gray-600">Persentase Laba:</span>
              <p class="text-2xl font-bold text-green-700 mt-1" id="lb_profitPercentage">0%</p>
            </div>
            <div>
              <span class="text-sm text-gray-600">Status:</span>
              <p class="text-sm font-bold mt-1" id="lb_profitStatus">
                <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-gray-200 text-gray-700">
                  <i class="fas fa-minus-circle"></i>
                  Belum ada data
                </span>
              </p>
            </div>
          </div>
        </div>
        <div class="hidden lg:block">
          <i class="fas fa-chart-pie text-green-200 text-8xl opacity-30"></i>
        </div>
      </div>
    </div>

    <!-- Table Section -->
    <div class="mt-6">
      <div class="bg-gray-50 rounded-lg p-4 mb-3">
        <h4 class="font-semibold text-gray-800 flex items-center gap-2">
          <i class="fas fa-table text-gray-600"></i>
          Detail Transaksi Periode
        </h4>
      </div>
      
      <div class="overflow-x-auto rounded-lg border border-gray-200">
        <table class="w-full">
          <thead class="bg-gray-100 border-b-2 border-gray-300">
            <tr>
              <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">No</th>
              <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">Tanggal</th>
              <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">Kategori</th>
              <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700">Keterangan</th>
              <th class="py-3 px-4 text-right text-sm font-semibold text-gray-700">Pendapatan</th>
              <th class="py-3 px-4 text-right text-sm font-semibold text-gray-700">Pengeluaran</th>
              <th class="py-3 px-4 text-right text-sm font-semibold text-gray-700">Gaji</th>
            </tr>
          </thead>
          <tbody id="labaBersihTableBody">
            <tr>
              <td colspan="7" class="text-center py-8 text-gray-500">
                <i class="fas fa-inbox text-4xl mb-2 opacity-30"></i>
                <p>Pilih periode untuk menampilkan data</p>
              </td>
            </tr>
          </tbody>
        </table>
        </div>
    </div>
      <!-- tambahkan section hidden disni -->
        </main>
      </div>
    </div>    
    <!-- Modals -->
    <!-- Payment Modal -->
    <div
      id="paymentModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
    >
      <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
        <h3 class="text-lg font-semibold mb-4">Pilih Metode Pembayaran</h3>

        <div class="space-y-3 mb-6" id="paymentMethodButtons">
          <button
            onclick="selectPaymentMethod('cash')"
            class="payment-method-btn w-full p-4 border-2 border-gray-300 rounded-lg hover:border-green-500 hover:bg-green-50 flex items-center transition duration-200"
          >
            <i class="fas fa-money-bill-wave text-green-600 mr-3 text-xl"></i>
            <div class="text-left">
              <div class="font-medium">Tunai</div>
              <div class="text-sm text-gray-500">
                Pembayaran dengan uang tunai
              </div>
            </div>
          </button>
          <button
            onclick="selectPaymentMethod('transfer')"
            class="payment-method-btn w-full p-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 flex items-center transition duration-200"
          >
            <i class="fas fa-university text-blue-600 mr-3 text-xl"></i>
            <div class="text-left">
              <div class="font-medium">Transfer Bank</div>
              <div class="text-sm text-gray-500">
                Transfer melalui mobile banking
              </div>
            </div>
          </button>
          <button
            onclick="selectPaymentMethod('qris')"
            class="payment-method-btn w-full p-4 border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 flex items-center transition duration-200"
          >
            <i class="fas fa-qrcode text-purple-600 mr-3 text-xl"></i>
            <div class="text-left">
              <div class="font-medium">QRIS</div>
              <div class="text-sm text-gray-500">Scan QR Code untuk bayar</div>
            </div>
          </button>
        </div>

        <div id="paymentAmountSection" class="hidden mb-6">
          <div class="bg-gray-50 p-4 rounded-lg mb-4">
            <div class="flex justify-between items-center mb-2">
              <span class="text-sm text-gray-600">Total Tagihan:</span>
              <span class="text-lg font-bold text-gray-800" id="paymentTotal"
                >Rp 0</span
              >
            </div>
            <div class="text-xs text-gray-500">
              Metode: <span id="selectedMethodText"></span>
            </div>
          </div>

          <div id="cashPaymentSection" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Jumlah Uang Diterima</label
            >
            <input
              type="number"
              id="paymentAmount"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg"
              placeholder="Masukkan jumlah uang"
            />
            <div
              id="changeAmount"
              class="mt-3 p-3 bg-green-50 border border-green-200 rounded-lg hidden"
            >
              <div class="flex justify-between items-center">
                <span class="text-sm font-medium text-green-700"
                  >Kembalian:</span
                >
                <span class="text-lg font-bold text-green-800" id="changeValue"
                  >Rp 0</span
                >
              </div>
            </div>
          </div>

          <div id="nonCashPaymentSection" class="hidden">
            <div
              class="text-center p-4 bg-blue-50 border border-blue-200 rounded-lg"
            >
              <i class="fas fa-check-circle text-blue-600 text-2xl mb-2"></i>
              <p class="text-sm text-blue-700">
                Konfirmasi pembayaran telah diterima
              </p>
            </div>
          </div>
        </div>

        <div class="flex space-x-3">
          <button
            onclick="closePaymentModal()"
            class="flex-1 bg-gray-300 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-400 transition duration-200"
          >
            <i class="fas fa-times mr-2"></i>Batal
          </button>
          <button
            id="confirmPaymentBtn"
            onclick="confirmPayment()"
            class="flex-1 bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition duration-200 hidden"
          >
            <i class="fas fa-credit-card mr-2"></i>Proses Bayar
          </button>
        </div>
      </div>
    </div>

    <!-- Service Modal -->
    <div
      id="serviceModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
    >
      <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
        <h3 class="text-lg font-semibold mb-4" id="serviceModalTitle">
          Tambah Jasa Baru
        </h3>

        <form id="serviceForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Nama Jasa</label
            >
            <input
              type="text"
              id="serviceName"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              required
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Harga</label
            >
            <div class="flex space-x-2 mb-2">
              <button
                type="button"
                onclick="setServicePrice(20000)"
                class="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300"
              >
                Rp 20.000
              </button>
              <button
                type="button"
                onclick="setServicePrice(25000)"
                class="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300"
              >
                Rp 25.000
              </button>
              <button
                type="button"
                onclick="setServicePrice(30000)"
                class="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300"
              >
                Rp 30.000
              </button>
            </div>
            <input
              type="number"
              id="servicePrice"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              required
            />
          </div>

          <div class="flex space-x-3">
            <button
              type="button"
              onclick="closeServiceModal()"
              class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition duration-200"
            >
              Batal
            </button>
            <button
              type="submit"
              class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200"
            >
              Simpan
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Employee Modal -->
    <div
      id="employeeModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
    >
      <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
        <h3 class="text-lg font-semibold mb-4" id="employeeModalTitle">
          Tambah Karyawan Baru
        </h3>

        <form id="employeeForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Nama Karyawan</label
            >
            <input
              type="text"
              id="employeeName"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              required
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Nomor Telepon</label
            >
            <input
              type="text"
              id="employeePhone"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>

          <div class="flex space-x-3">
            <button
              type="button"
              onclick="closeEmployeeModal()"
              class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition duration-200"
            >
              Batal
            </button>
            <button
              type="submit"
              class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200"
            >
              Simpan
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- User Modal -->
    <div
      id="userModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
    >
      <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
        <h3 class="text-lg font-semibold mb-4" id="userModalTitle">
          Tambah User Baru
        </h3>

        <form id="userForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Username</label
            >
            <input
              type="text"
              id="newUsername"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              autocomplete="off"
              required
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Password</label
            >
            <input
              type="password"
              id="newPassword"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              required
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Jabatan</label
            >
            <select
              id="userRole"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              required
            >
              <option value="">Pilih Jabatan</option>
              <option value="admin">Admin</option>
              <option value="karyawan">Karyawan</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Akses Menu</label
            >

            <!-- Toggle Semua -->
            <label class="inline-flex items-center mb-3 select-none">
              <input
                type="checkbox"
                id="accessAll"
                class="mr-2"
                onchange="toggleAllAccess()"
              />
              <span class="text-sm font-medium">Semua Menu</span>
            </label>

            <!-- Menu utama (grid rapi, tidak turun ke bawah) -->
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
              <label class="inline-flex items-center whitespace-nowrap">
                <input
                  type="checkbox"
                  name="menuAccess"
                  value="dashboard"
                  class="mr-2"
                />
                <span class="text-sm">Dashboard</span>
              </label>
              <label class="inline-flex items-center whitespace-nowrap">
                <input
                  type="checkbox"
                  name="menuAccess"
                  value="transaction"
                  class="mr-2"
                />
                <span class="text-sm">Transaksi</span>
              </label>
              <label class="inline-flex items-center whitespace-nowrap">
                <input
                  type="checkbox"
                  name="menuAccess"
                  value="services"
                  class="mr-2"
                />
                <span class="text-sm">Jasa Kendaraan</span>
              </label>
              <label class="inline-flex items-center whitespace-nowrap">
                <input
                  type="checkbox"
                  name="menuAccess"
                  value="employees"
                  class="mr-2"
                />
                <span class="text-sm">Karyawan</span>
              </label>
              <label class="inline-flex items-center whitespace-nowrap">
                <input
                  type="checkbox"
                  name="menuAccess"
                  value="users"
                  class="mr-2"
                />
                <span class="text-sm">Manajemen User</span>
              </label>
              <label class="inline-flex items-center whitespace-nowrap">
                <input
                  type="checkbox"
                  name="menuAccess"
                  value="settings"
                  class="mr-2"
                />
                <span class="text-sm">Pengaturan Toko</span>
              </label>
              <label class="inline-flex items-center whitespace-nowrap">
                <input
                  type="checkbox"
                  name="menuAccess"
                  value="expenses"
                  class="mr-2"
                />
                <span class="text-sm">Kas Keluar</span>
              </label>
            </div>

            <!-- Kelompok Laporan -->
            <div class="mt-4">
              <div class="flex items-center justify-between">
                <span class="text-sm font-medium text-gray-700">Laporan</span>
                <label class="inline-flex items-center select-none">
                  <input
                    type="checkbox"
                    id="accessReportsAll"
                    class="mr-2"
                    onchange="toggleGroupAccess('reports')"
                  />
                  <span class="text-xs text-gray-600">Pilih semua laporan</span>
                </label>
              </div>

              <!-- Grid laporan (rapi, tidak turun berantakan) -->
              <div
                id="reportsGroup"
                class="mt-2 grid grid-cols-2 md:grid-cols-3 gap-3"
              >
                <label class="inline-flex items-center whitespace-nowrap">
                  <input
                    type="checkbox"
                    name="menuAccess"
                    value="report_profit_net"
                    class="mr-2"
                    data-group="reports"
                  />
                  <span class="text-sm">Laba Bersih</span>
                </label>
                <label class="inline-flex items-center whitespace-nowrap">
                  <input
                    type="checkbox"
                    name="menuAccess"
                    value="report_profit_gross"
                    class="mr-2"
                    data-group="reports"
                  />
                  <span class="text-sm">Laba Kotor</span>
                </label>
                <label class="inline-flex items-center whitespace-nowrap">
                  <input
                    type="checkbox"
                    name="menuAccess"
                    value="report_transactions"
                    class="mr-2"
                    data-group="reports"
                  />
                  <span class="text-sm">Transaksi</span>
                </label>
                <label class="inline-flex items-center whitespace-nowrap">
                  <input
                    type="checkbox"
                    name="menuAccess"
                    value="report_cash_out"
                    class="mr-2"
                    data-group="reports"
                  />
                  <span class="text-sm">Kas Keluar</span>
                </label>
              </div>
            </div>
          </div>

          <div class="flex space-x-3">
            <button
              type="button"
              onclick="closeUserModal()"
              class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition duration-200"
            >
              Batal
            </button>
            <button
              type="submit"
              class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200"
            >
              Simpan
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Success Modal -->
    <div
      id="successModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
    >
      <div
        class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md text-center"
      >
        <div class="mb-4">
          <div
            class="mx-auto w-16 h-16 bg-green-100 rounded-full flex items-center justify-center"
          >
            <i class="fas fa-check text-2xl text-green-600"></i>
          </div>
        </div>
        <h3 class="text-xl font-semibold mb-2 text-gray-800">
          Pembayaran Berhasil!
        </h3>
        <p class="text-gray-600 mb-2">Transaksi telah berhasil diproses</p>
        <div class="text-sm text-gray-500 mb-6">
          <span id="successTransactionDetails"></span>
        </div>

        <div class="space-y-3">
          <div class="flex space-x-3">
            <button
              onclick="closeSuccessModal()"
              class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition duration-200 text-sm"
            >
              Tutup
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div
      id="logoutModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
    >
      <div
        class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md text-center"
      >
        <div class="mb-4">
          <i class="fas fa-sign-out-alt text-4xl text-red-600"></i>
        </div>
        <h3 class="text-lg font-semibold mb-2">Konfirmasi Keluar</h3>
        <p class="text-gray-600 mb-6">
          Apakah Anda yakin ingin keluar dari sistem?
        </p>

        <div class="flex space-x-3">
          <button
            onclick="closeLogoutModal()"
            class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition duration-200"
          >
            Batal
          </button>
          <button
            onclick="confirmLogout()"
            class="flex-1 bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-200"
          >
            <i class="fas fa-sign-out-alt mr-2"></i>Keluar
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div
      id="editTransactionModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
    >
      <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
        <h3 class="text-lg font-semibold mb-4">Edit Transaksi</h3>

        <form id="editTransactionForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Nomor Polisi</label
            >
            <input
              type="text"
              id="editPlateNumber"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="Contoh: B 1234 ABC"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Jenis Kendaraan</label
            >
            <div class="relative">
              <input
                type="text"
                id="editVehicleSearch"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="Ketik untuk mencari jenis kendaraan..."
                autocomplete="off"
                spellcheck="false"
                required
              />
              <input type="hidden" id="editSelectedServiceId" />
              <div class="absolute right-3 top-3 text-gray-400">
                <i class="fas fa-search"></i>
              </div>
              <div
                id="editVehicleDropdown"
                class="absolute z-20 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-60 overflow-y-auto hidden"
              >
                <!-- Vehicle options will be populated here -->
              </div>
            </div>
            <div class="text-xs text-gray-500 mt-1">
              Gunakan ↑↓ untuk navigasi, Enter untuk memilih, Esc untuk tutup
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Harga</label
            >
            <input
              type="number"
              id="editPrice"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              readonly
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Catatan <span class="text-gray-400">(Opsional)</span></label
            >
            <textarea
              id="editTransactionNotes"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              rows="2"
              placeholder="Tambahkan catatan khusus..."
              autocomplete="off"
              spellcheck="false"
            ></textarea>
          </div>

          <div class="flex space-x-3">
            <button
              type="button"
              onclick="closeEditTransactionModal()"
              class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition duration-200"
            >
              Batal
            </button>
            <button
              type="submit"
              class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200"
            >
              Simpan
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Jaringan Terputus -->
    <div
      id="networkErrorModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white rounded-lg p-6 shadow-lg text-center max-w-sm w-full"
      >
        <i class="fas fa-wifi-slash text-red-500 text-4xl mb-3"></i>
        <h3 class="text-lg font-semibold mb-2">Koneksi Terputus</h3>
        <p class="text-gray-700 mb-4">
          Sistem tidak dapat terhubung ke server.<br />Periksa jaringan internet
          Anda.
        </p>
        <button
          onclick="closeNetworkErrorModal()"
          class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600"
        >
          Tutup
        </button>
      </div>
    </div>

    <!-- Modal Export Laporan Detail Transaksi -->
<div id="exportDetailTransactionsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
    <h3 class="text-lg font-semibold mb-4 text-center" id="exportDetailTransactionsTitle">Export Laporan Detail Transaksi</h3>
    <p class="mb-4 text-gray-700 text-center text-sm" id="exportDetailTransactionsFilename"></p>
    
    <!-- Download Button -->
    <div class="mb-4">
      <button onclick="downloadDetailTransactionsExcel()" class="w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 flex items-center justify-center transition-colors" title="Download Excel">
        <i class="fas fa-download mr-2"></i>Download Excel
      </button>
    </div>
    
    <!-- Divider -->
    <div class="flex items-center my-4">
      <div class="flex-1 border-t border-gray-300"></div>
      <span class="px-3 text-sm text-gray-500">atau bagikan via</span>
      <div class="flex-1 border-t border-gray-300"></div>
    </div>
    
    <!-- Share Options -->
    <div class="grid grid-cols-2 gap-3 mb-4">
      <button onclick="shareDetailTransactionsViaWhatsApp()" class="bg-green-500 text-white px-4 py-3 rounded-lg hover:bg-green-600 flex items-center justify-center transition-colors" title="Bagikan via WhatsApp">
        <i class="fab fa-whatsapp mr-2 text-lg"></i>WhatsApp
      </button>
      <button onclick="shareDetailTransactionsViaEmail()" class="bg-blue-500 text-white px-4 py-3 rounded-lg hover:bg-blue-600 flex items-center justify-center transition-colors" title="Bagikan via Email">
        <i class="fas fa-envelope mr-2"></i>Email
      </button>
    </div>
    
    <button onclick="closeExportDetailTransactionsModal()" class="w-full bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">Tutup</button>
  </div>
</div>
    

    <script>
      // Supabase Configuration Database
      const SUPABASE_URL = "https://vyyofhgowcpmiiunopyr.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ5eW9maGdvd2NwbWlpdW5vcHlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MDQzOTEsImV4cCI6MjA3MzQ4MDM5MX0.gLBQKYE7bzsdkwP6g1TctQ0ookryOOZTJQvRw5SrXFY";

      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY,
        {
          db: {
            schema: "public",
          },
          auth: {
            autoRefreshToken: false,
            persistSession: false,
          },
          global: {
            headers: {
              "x-client-info": "wash-management-system",
            },
          },
        }
      );

      // Global error handler for Supabase timeouts
      window.addEventListener("unhandledrejection", function (event) {
        if (
          event.reason &&
          event.reason.message &&
          event.reason.message.includes("timeout")
        ) {
          console.warn("⚠️ Supabase timeout detected, retrying operation...");
          event.preventDefault(); // Prevent the error from being logged
        }
      });

      function showNetworkErrorModal() {
        document.getElementById("networkErrorModal").classList.remove("hidden");
      }
      function closeNetworkErrorModal() {
        document.getElementById("networkErrorModal").classList.add("hidden");
      }

      // Deteksi koneksi browser
      window.addEventListener("offline", showNetworkErrorModal);
      window.addEventListener("online", closeNetworkErrorModal);

      // Deteksi error Supabase (contoh pada fungsi fetch)
      async function safeSupabaseQuery(queryPromise) {
        try {
          const { data, error } = await queryPromise;
          if (
            error &&
            (error.message.includes("Failed to fetch") ||
              error.code === "ECONNREFUSED")
          ) {
            showNetworkErrorModal();
          }
          return { data, error };
        } catch (err) {
          showNetworkErrorModal();
          return { data: null, error: err };
        }
      }

      // Global Variables
      let currentUser = null;
      let sessionTimeoutTimer = null;
      const SESSION_TIMEOUT_MS = 60 * 5000; // 5 menit (uji coba)

      let currentTransaction = null;
      let selectedPaymentMethod = null;
      let editingServiceId = null;
      let editingEmployeeId = null;
      let editingUserId = null;
      let editingTransactionId = null;
      let availableServices = [];
      let selectedServiceIndex = -1;

      // Transaction view variables
      let currentTransactionView = "paid";
      let currentPage = 1;
      let rowsPerPage = 10;
      let totalTransactions = 0;

      // Initialize Application
      document.addEventListener("DOMContentLoaded", function () {
        initializeApp();
        // Ambil nama toko dari Supabase untuk header login
        fetchStoreNameHeader();
      });

      async function fetchStoreNameHeader() {
        try {
          const { data, error } = await supabase
            .from("store_settings")
            .select("name")
            .single();
          if (error) throw error;
          if (data && data.name) {
            document.getElementById("storeNameHeader").innerText = data.name;
          }
        } catch (err) {
          // fallback jika gagal, tetap gunakan default
          document.getElementById("storeNameHeader").innerText =
            "Wash Management System";
        }
      }

      function setDefaultExpenseDate() {
  const now = new Date();
  const jakartaOffset = 8 * 60;
  const localOffset = now.getTimezoneOffset();
  const jakartaTime = new Date(
    now.getTime() + (jakartaOffset - localOffset) * 60000
  );
  const today = jakartaTime.toISOString().split("T")[0];
  const el = document.getElementById("expenseDate");
  if (el && !el.value) el.value = today;
}

      async function initializeApp() {
        setupEventListeners();
        // Set default expense date (hari ini, zona Jakarta)
+       setDefaultExpenseDate();
        // Cek validitas sesi setiap awal load
        if (!checkSessionValidity()) return;

        // Check if user is already logged in
        const savedUser = localStorage.getItem("currentUser");
        if (savedUser) {
          try {
            currentUser = JSON.parse(savedUser);
            showMainApp();
            await loadStoreSettings(); // <-- Tambahkan ini!
            await loadInitialData();
            return;
          } catch (error) {
            localStorage.removeItem("currentUser");
          }
        }

        // Show login screen
        document.getElementById("loginScreen").classList.remove("hidden");
        document.getElementById("mainApp").classList.add("hidden");

        // Initialize default admin user if not exists
        await initializeDefaultUser();
      }

      async function initializeDefaultUser() {
        try {
          // Check if admin user exists
          const { data: existingUser } = await supabase
            .from("users")
            .select("*")
            .eq("username", "admin")
            .single();

          if (!existingUser) {
            // Create default admin user
            await supabase.from("users").insert([
              {
                username: "admin",
                password: "123",
                role: "admin",
                access_menu: [
                  "dashboard",
                  "transaction",
                  "services",
                  "employees",
                  "users",
                  "settings",
                  "expenses",
                ],
                is_active: true,
              },
            ]);
          }
        } catch (error) {
          console.error("Error initializing default user:", error);
        }
      }

      function setupEventListeners() {
        // Login form
        document
          .getElementById("loginForm")
          .addEventListener("submit", handleLogin);

        // Vehicle search functionality
        setupVehicleSearch();
        document
          .getElementById("plateNumber")
          .addEventListener("input", updateReceiptPreview);
        document
          .getElementById("transactionNotes")
          .addEventListener("input", updateReceiptPreview);

        // Store settings form
        document
          .getElementById("storeSettingsForm")
          .addEventListener("submit", saveStoreSettings);

        // Service form
        document
          .getElementById("serviceForm")
          .addEventListener("submit", saveService);

        // Employee form
        document
          .getElementById("employeeForm")
          .addEventListener("submit", saveEmployee);

        // User form
        document
          .getElementById("userForm")
          .addEventListener("submit", saveUser);

        // Edit transaction form
        document
          .getElementById("editTransactionForm")
          .addEventListener("submit", saveEditTransaction);
        setupEditVehicleSearch();

        // Transaction filters
        document
          .getElementById("statusFilter")
          .addEventListener("change", function () {
            currentTransactionView = this.value;
            currentPage = 1;
            loadTransactions();
            updateTabButtons();
          });

        document
          .getElementById("paymentFilter")
          .addEventListener("change", function () {
            currentPage = 1;
            loadTransactions();
          });

        document
          .getElementById("rowsPerPage")
          .addEventListener("change", function () {
            rowsPerPage = parseInt(this.value);
            currentPage = 1;
            loadTransactions();
          });

        // Date filters
        document
          .getElementById("dateFrom")
          .addEventListener("change", function () {
            currentPage = 1;
            loadTransactions();
          });

        document
          .getElementById("dateTo")
          .addEventListener("change", function () {
            currentPage = 1;
            loadTransactions();
          });          

        // Service search
        document
          .getElementById("serviceSearchInput")
          .addEventListener("input", function () {
            filterServices(this.value);
          });

        // Payment amount change calculation
        document
          .getElementById("paymentAmount")
          .addEventListener("input", calculateChange);

          // Expense filters: update laporan saat user ubah filter
  const expFromEl = document.getElementById("expenseFilterFrom");
  const expToEl = document.getElementById("expenseFilterTo");
  const expCatEl = document.getElementById("expenseFilterCategory");
  if (expFromEl) expFromEl.addEventListener("change", () => { currentPage = 1; loadExpenses(); });
  if (expToEl) expToEl.addEventListener("change", () => { currentPage = 1; loadExpenses(); });
  if (expCatEl) expCatEl.addEventListener("change", () => { currentPage = 1; loadExpenses(); });

        // Update receipt date
        updateReceiptDate();
        setInterval(updateReceiptDate, 60000); // Update every minute
      }

      // Vehicle Search Functions
      function setupVehicleSearch() {
        const searchInput = document.getElementById("vehicleSearch");
        const dropdown = document.getElementById("vehicleDropdown");

        searchInput.addEventListener("input", handleVehicleSearch);
        searchInput.addEventListener("keydown", handleVehicleKeydown);
        searchInput.addEventListener("focus", showVehicleDropdown);

        // Close dropdown when clicking outside
        document.addEventListener("click", function (e) {
          if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
            hideVehicleDropdown();
          }
        });
      }

      function setupEditVehicleSearch() {
        const searchInput = document.getElementById("editVehicleSearch");
        const dropdown = document.getElementById("editVehicleDropdown");

        searchInput.addEventListener("input", handleEditVehicleSearch);
        searchInput.addEventListener("keydown", handleEditVehicleKeydown);
        searchInput.addEventListener("focus", showEditVehicleDropdown);

        // Close dropdown when clicking outside
        document.addEventListener("click", function (e) {
          if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
            hideEditVehicleDropdown();
          }
        });
      }

      async function handleVehicleSearch(e) {
        const query = e.target.value.trim();

        // Clear previous selection if user is typing
        if (
          query !==
          document.getElementById("vehicleSearch").dataset.selectedName
        ) {
          document.getElementById("selectedServiceId").value = "";
          document.getElementById("price").value = "";
          updateReceiptPreview();
        }

        // Only show dropdown when user types something
        if (query.length === 0) {
          hideVehicleDropdown();
          return;
        }

        // Only search when user types at least 1 character
        if (query.length < 1) {
          hideVehicleDropdown();
          return;
        }

        try {
          // Use LIKE CONCAT query for better search - only show matching results
          const { data: filteredServices, error } = await supabase
            .from("services")
            .select("*")
            .eq("is_active", true)
            .ilike("name", `%${query}%`)
            .order("name")
            .limit(10); // Limit results for performance

          if (error) throw error;

          displayVehicleOptions(filteredServices || [], query);
          selectedServiceIndex = -1;
          showVehicleDropdown();
        } catch (error) {
          console.error("Error searching services:", error);
          // Fallback to local search if database query fails
          const filteredServices = availableServices
            .filter((service) =>
              service.name.toLowerCase().includes(query.toLowerCase())
            )
            .slice(0, 10); // Limit results
          displayVehicleOptions(filteredServices, query);
          selectedServiceIndex = -1;
          showVehicleDropdown();
        }
      }

      function handleVehicleKeydown(e) {
        const dropdown = document.getElementById("vehicleDropdown");
        const options = dropdown.querySelectorAll(".vehicle-option");

        if (dropdown.classList.contains("hidden")) {
          if (e.key === "ArrowDown" || e.key === "Enter") {
            e.preventDefault();
            showVehicleDropdown();
            return;
          }
        }

        switch (e.key) {
          case "ArrowDown":
            e.preventDefault();
            selectedServiceIndex = Math.min(
              selectedServiceIndex + 1,
              options.length - 1
            );
            updateHighlight(options);
            scrollToHighlighted();
            break;
          case "ArrowUp":
            e.preventDefault();
            selectedServiceIndex = Math.max(selectedServiceIndex - 1, -1);
            updateHighlight(options);
            scrollToHighlighted();
            break;
          case "Enter":
            e.preventDefault();
            if (selectedServiceIndex >= 0 && options[selectedServiceIndex]) {
              const serviceId = options[selectedServiceIndex].dataset.serviceId;
              const service = availableServices.find((s) => s.id == serviceId);
              if (service) {
                selectVehicleOption(service);
              }
            }
            break;
          case "Escape":
            e.preventDefault();
            hideVehicleDropdown();
            break;
          case "Tab":
            hideVehicleDropdown();
            break;
        }
      }

      function scrollToHighlighted() {
        const dropdown = document.getElementById("vehicleDropdown");
        const highlighted = dropdown.querySelector(
          ".vehicle-option.highlighted"
        );
        if (highlighted) {
          highlighted.scrollIntoView({ block: "nearest" });
        }
      }

      function updateHighlight(options) {
        options.forEach((option, index) => {
          option.classList.toggle(
            "highlighted",
            index === selectedServiceIndex
          );
        });
      }

      function showVehicleDropdown() {
        // Don't show all services by default - only show when searching
        const query = document.getElementById("vehicleSearch").value.trim();
        if (query.length > 0) {
          // Will be handled by handleVehicleSearch
          return;
        }
        hideVehicleDropdown();
      }

      function hideVehicleDropdown() {
        document.getElementById("vehicleDropdown").classList.add("hidden");
      }

      function displayVehicleOptions(services, query = "") {
        const dropdown = document.getElementById("vehicleDropdown");
        dropdown.innerHTML = "";

        if (services.length === 0) {
          dropdown.innerHTML =
            '<div class="p-3 text-gray-500 text-sm text-center"><i class="fas fa-search mr-2"></i>Tidak ada jenis kendaraan ditemukan</div>';
        } else {
          services.forEach((service, index) => {
            const option = document.createElement("div");
            option.className =
              "vehicle-option flex items-center justify-between p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0";
            option.dataset.serviceId = service.id;

            // Highlight matching text
            let displayName = service.name;
            if (query) {
              const regex = new RegExp(`(${query})`, "gi");
              displayName = service.name.replace(
                regex,
                '<mark class="bg-yellow-200">$1</mark>'
              );
            }

            option.innerHTML = `
                        <div class="flex-1">
                            <div class="font-medium text-gray-800">${displayName}</div>
                            <div class="text-xs text-gray-500">Jasa cuci kendaraan</div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold text-blue-600">${formatCurrency(
                              service.price
                            )}</div>
                            <div class="text-xs text-gray-400">per unit</div>
                        </div>
                    `;

            option.addEventListener("click", () =>
              selectVehicleOption(service)
            );
            option.addEventListener("mouseenter", () => {
              selectedServiceIndex = index;
              updateHighlight(dropdown.querySelectorAll(".vehicle-option"));
            });

            dropdown.appendChild(option);
          });
        }

        dropdown.classList.remove("hidden");
      }

      function selectVehicleOption(service) {
        const searchInput = document.getElementById("vehicleSearch");
        searchInput.value = service.name;
        searchInput.dataset.selectedName = service.name.toLowerCase();
        document.getElementById("selectedServiceId").value = service.id;
        document.getElementById("price").value = service.price;
        hideVehicleDropdown();
        updateReceiptPreview();

        // Show success feedback
        searchInput.classList.add("border-green-500", "bg-green-50");
        setTimeout(() => {
          searchInput.classList.remove("border-green-500", "bg-green-50");
        }, 1000);
      }

      // Edit Vehicle Search Functions
      async function handleEditVehicleSearch(e) {
        const query = e.target.value.trim();

        // Clear previous selection if user is typing
        if (
          query !==
          document.getElementById("editVehicleSearch").dataset.selectedName
        ) {
          document.getElementById("editSelectedServiceId").value = "";
          document.getElementById("editPrice").value = "";
        }

        // Only show dropdown when user types something
        if (query.length === 0) {
          hideEditVehicleDropdown();
          return;
        }

        try {
          const { data: filteredServices, error } = await supabase
            .from("services")
            .select("*")
            .eq("is_active", true)
            .ilike("name", `%${query}%`)
            .order("name")
            .limit(10);

          if (error) throw error;

          displayEditVehicleOptions(filteredServices || [], query);
          selectedServiceIndex = -1;
          showEditVehicleDropdown();
        } catch (error) {
          console.error("Error searching services:", error);
          const filteredServices = availableServices
            .filter((service) =>
              service.name.toLowerCase().includes(query.toLowerCase())
            )
            .slice(0, 10);
          displayEditVehicleOptions(filteredServices, query);
          selectedServiceIndex = -1;
          showEditVehicleDropdown();
        }
      }

      function handleEditVehicleKeydown(e) {
        const dropdown = document.getElementById("editVehicleDropdown");
        const options = dropdown.querySelectorAll(".vehicle-option");

        if (dropdown.classList.contains("hidden")) {
          if (e.key === "ArrowDown" || e.key === "Enter") {
            e.preventDefault();
            showEditVehicleDropdown();
            return;
          }
        }

        switch (e.key) {
          case "ArrowDown":
            e.preventDefault();
            selectedServiceIndex = Math.min(
              selectedServiceIndex + 1,
              options.length - 1
            );
            updateEditHighlight(options);
            scrollToEditHighlighted();
            break;
          case "ArrowUp":
            e.preventDefault();
            selectedServiceIndex = Math.max(selectedServiceIndex - 1, -1);
            updateEditHighlight(options);
            scrollToEditHighlighted();
            break;
          case "Enter":
            e.preventDefault();
            if (selectedServiceIndex >= 0 && options[selectedServiceIndex]) {
              const serviceId = options[selectedServiceIndex].dataset.serviceId;
              const service = availableServices.find((s) => s.id == serviceId);
              if (service) {
                selectEditVehicleOption(service);
              }
            }
            break;
          case "Escape":
            e.preventDefault();
            hideEditVehicleDropdown();
            break;
          case "Tab":
            hideEditVehicleDropdown();
            break;
        }
      }

      function scrollToEditHighlighted() {
        const dropdown = document.getElementById("editVehicleDropdown");
        const highlighted = dropdown.querySelector(
          ".vehicle-option.highlighted"
        );
        if (highlighted) {
          highlighted.scrollIntoView({ block: "nearest" });
        }
      }

      function updateEditHighlight(options) {
        options.forEach((option, index) => {
          option.classList.toggle(
            "highlighted",
            index === selectedServiceIndex
          );
        });
      }

      function showEditVehicleDropdown() {
        const query = document.getElementById("editVehicleSearch").value.trim();
        if (query.length > 0) {
          return;
        }
        hideEditVehicleDropdown();
      }

      function hideEditVehicleDropdown() {
        document.getElementById("editVehicleDropdown").classList.add("hidden");
      }

      function displayEditVehicleOptions(services, query = "") {
        const dropdown = document.getElementById("editVehicleDropdown");
        dropdown.innerHTML = "";

        if (services.length === 0) {
          dropdown.innerHTML =
            '<div class="p-3 text-gray-500 text-sm text-center"><i class="fas fa-search mr-2"></i>Tidak ada jenis kendaraan ditemukan</div>';
        } else {
          services.forEach((service, index) => {
            const option = document.createElement("div");
            option.className =
              "vehicle-option flex items-center justify-between p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0";
            option.dataset.serviceId = service.id;

            let displayName = service.name;
            if (query) {
              const regex = new RegExp(`(${query})`, "gi");
              displayName = service.name.replace(
                regex,
                '<mark class="bg-yellow-200">$1</mark>'
              );
            }

            option.innerHTML = `
                        <div class="flex-1">
                            <div class="font-medium text-gray-800">${displayName}</div>
                            <div class="text-xs text-gray-500">Jasa cuci kendaraan</div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold text-blue-600">${formatCurrency(
                              service.price
                            )}</div>
                            <div class="text-xs text-gray-400">per unit</div>
                        </div>
                    `;

            option.addEventListener("click", () =>
              selectEditVehicleOption(service)
            );
            option.addEventListener("mouseenter", () => {
              selectedServiceIndex = index;
              updateEditHighlight(dropdown.querySelectorAll(".vehicle-option"));
            });

            dropdown.appendChild(option);
          });
        }

        dropdown.classList.remove("hidden");
      }

      function selectEditVehicleOption(service) {
        const searchInput = document.getElementById("editVehicleSearch");
        searchInput.value = service.name;
        searchInput.dataset.selectedName = service.name.toLowerCase();
        document.getElementById("editSelectedServiceId").value = service.id;
        document.getElementById("editPrice").value = service.price;
        hideEditVehicleDropdown();

        // Show success feedback
        searchInput.classList.add("border-green-500", "bg-green-50");
        setTimeout(() => {
          searchInput.classList.remove("border-green-500", "bg-green-50");
        }, 1000);
      }

      // Employee Validation
      async function checkEmployeeValidation() {
        try {
          const { data: presentEmployees } = await supabase
            .from("employees")
            .select("*")
            .eq("is_present", true)
            .eq("is_active", true);

          const hasEmployees = presentEmployees && presentEmployees.length > 0;
          const validationAlert = document.getElementById("employeeValidation");
          const payButton = document.getElementById("payButton");
          const saveButton = document.getElementById("saveButton");

          if (!hasEmployees) {
            validationAlert.classList.remove("hidden");
            payButton.disabled = true;
            saveButton.disabled = true;
          } else {
            validationAlert.classList.add("hidden");
            payButton.disabled = false;
            saveButton.disabled = false;
          }

          return hasEmployees;
        } catch (error) {
          console.error("Error checking employee validation:", error);
          return false;
        }
      }

      async function handleLogin(e) {
        e.preventDefault();

        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value;

        if (!username || !password) {
          showAlert("Username dan password harus diisi!", "error");
          return;
        }

        try {
          // Cek user di database
          const { data: users, error: userError } = await supabase
            .from("users")
            .select("*")
            .eq("username", username)
            .eq("password", password);

          if (userError) {
            console.error("Database error:", userError);
            showAlert("Terjadi kesalahan saat login", "error");
            return;
          }

          if (!users || users.length === 0) {
            showAlert("Username atau password salah!", "error");
            return;
          }

          const user = users[0];

          // Cek apakah user aktif
          if (!user.is_active) {
            showAlert(
              "Akun Anda telah dinonaktifkan. Hubungi administrator.",
              "error"
            );
            return;
          }

          // Simpan user global & localStorage
          currentUser = user;
          localStorage.setItem("currentUser", JSON.stringify(currentUser));

          // Load setting toko
          await loadStoreSettings();

          // Tampilkan aplikasi utama
          showMainApp();
          updateEmployeeAddButton();

          // Pastikan user tetap tersimpan setelah showMainApp
          currentUser = user;
          localStorage.setItem("currentUser", JSON.stringify(currentUser));

          // Set sessionDate (waktu Jakarta) setelah login sukses
          const now = new Date();
          const jakartaOffset = 8 * 60;
          const localOffset = now.getTimezoneOffset();
          const jakartaTime = new Date(
            now.getTime() + (jakartaOffset - localOffset) * 60000
          );
          const today = jakartaTime.toISOString().split("T")[0];
          localStorage.setItem("sessionDate", today);

          // Load data awal
          await loadInitialData();

          // Update UI dengan user info
          showAlert(`Selamat datang, ${currentUser.username}!`, "success");
          document.getElementById("currentUser").textContent =
            currentUser.username;
          document.getElementById("mobileCurrentUser").textContent =
            currentUser.username;
          document
            .querySelectorAll("#currentUser, #mobileCurrentUser")
            .forEach((el) => {
              if (el)
                el.nextElementSibling.textContent =
                  currentUser.role === "admin" ? "Admin" : "Karyawan";
            });
        } catch (error) {
          console.error("Login error:", error);
          showAlert("Terjadi kesalahan saat login", "error");
        }
      }

      // Mulai timer setelah login
      function showMainApp() {
  document.getElementById("loginScreen").classList.add("hidden");
  document.getElementById("mainApp").classList.remove("hidden");
  document.getElementById("currentUser").textContent = currentUser.username;

  updateSidebarAccess();

  // Hide pengaturan gaji jika bukan admin
  const salarySettingsBox = document.getElementById("salarySettingsBox");
  if (salarySettingsBox) {
    salarySettingsBox.style.display = currentUser.role === "admin" ? "block" : "none";
  }

  // Buka section pertama yang boleh diakses user
  const userAccess = currentUser.access_menu || [];
  const defaultSection = userAccess.length > 0 ? userAccess[0] : "dashboard";
  navigateToSection(defaultSection);

  resetSessionTimeout(); // Mulai timer
  updateUserHeaderUI();
  updateUserMenuAccess();
}

      function updateSidebarAccess() {
        const menuItems = document.querySelectorAll(".nav-item");
        const userAccess = currentUser.access_menu || [];

        // Sembunyikan/Show menu utama
        menuItems.forEach((item) => {
          const menuName = item.getAttribute("data-menu");
          if (menuName && !userAccess.includes(menuName)) {
            item.style.display = "none";
          } else {
            item.style.display = "flex";
          }
        });

        // Khusus submenu laporan
        const reportSubMenu = document.getElementById("reportSubMenu");
        if (reportSubMenu) {
          // Ambil semua submenu laporan
          const subMenus = reportSubMenu.querySelectorAll(
            ".nav-item[data-menu]"
          );
          let visibleCount = 0;
          subMenus.forEach((sub) => {
            const subMenuName = sub.getAttribute("data-menu");
            if (userAccess.includes(subMenuName)) {
              sub.style.display = "flex";
              visibleCount++;
            } else {
              sub.style.display = "none";
            }
          });
          // Tampilkan tombol Laporan jika ada minimal satu submenu yang boleh diakses
          const reportMenuBtn = document.getElementById("reportMenuBtn");
          if (reportMenuBtn) {
            reportMenuBtn.style.display = visibleCount > 0 ? "flex" : "none";
          }
        }
      }

      async function loadExpenses() {
  const from = document.getElementById("expenseFilterFrom").value;
  const to = document.getElementById("expenseFilterTo").value;
  const category = document.getElementById("expenseFilterCategory").value;

  let query = supabase.from("expenses").select("*");
  if (from) query = query.gte("date", from);
  if (to) query = query.lte("date", to);
  if (category) query = query.eq("category", category);

  query = query.order("date", { ascending: false });

  const { data, error } = await query;
  if (error) {
    document.getElementById("expensesList").innerHTML =
      '<div class="text-red-600">Gagal memuat data pengeluaran</div>';
    return;
  }

  // Ringkasan — aman ketika data kosong
  const total = (data || []).reduce((sum, e) => sum + (e.amount || 0), 0);
  document.getElementById("expenseSummary").textContent =
    formatCurrency(total);

  // Statistik kategori
  const stats = {};
  (data || []).forEach((e) => {
    const amt = e.amount || 0;
    stats[e.category] = (stats[e.category] || 0) + amt;
  });
  document.getElementById("expenseStats").textContent = Object.entries(
    stats
  )
    .map(([cat, amt]) => `${cat}: ${formatCurrency(amt)}`)
    .join(" | ");

  // List
  const list = document.getElementById("expensesList");
  list.innerHTML = "";
  if (!data || data.length === 0) {
    list.innerHTML =
      '<div class="text-gray-500 text-center py-6">Belum ada pengeluaran</div>';
  } else {
    data.forEach((exp) => {
      const div = document.createElement("div");
      div.className =
        "flex items-center justify-between p-4 border border-gray-200 rounded-lg bg-red-50";
      div.innerHTML = `
          <div>
              <div class="font-bold text-red-700">${formatCurrency(
                exp.amount || 0
              )}</div>
              <div class="text-sm text-gray-700">${exp.category} | ${
        exp.description
      }</div>
              <div class="text-xs text-gray-500">${exp.date}</div>
              ${
                exp.notes
                  ? `<div class="text-xs text-gray-400 mt-1">Catatan: ${exp.notes}</div>`
                  : ""
              }
          </div>
          <div class="flex space-x-2">
              <button onclick="editExpense(${exp.id})" class="text-blue-600 hover:text-blue-800"><i class="fas fa-edit"></i></button>
              <button onclick="deleteExpense(${exp.id})" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
          </div>
      `;
      list.appendChild(div);
    });
  }
}

      document
        .getElementById("expenseForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const date = document.getElementById("expenseDate").value;
          const category = document.getElementById("expenseCategory").value;
          const amount = parseInt(
            document.getElementById("expenseAmount").value
          );
          const description =
            document.getElementById("expenseDescription").value;
          const notes = document.getElementById("expenseNotes").value;

          const { error } = await supabase.from("expenses").insert([
            {
              date,
              category,
              amount,
              description,
              notes,
            },
          ]);
          if (error) {
            showAlert("Gagal menyimpan pengeluaran", "error");
          } else {
            showAlert("Pengeluaran berhasil disimpan", "success");
            this.reset();
            loadExpenses();
          }
        });

      function resetExpenseFilter() {
        document.getElementById("expenseFilterFrom").value = "";
        document.getElementById("expenseFilterTo").value = "";
        document.getElementById("expenseFilterCategory").value = "";
        loadExpenses();
        clearDetailKaskeluarTable();
      }

      async function editExpense(id) {
        const { data, error } = await supabase
          .from("expenses")
          .select("*")
          .eq("id", id)
          .single();
        if (error || !data) return showAlert("Data tidak ditemukan", "error");
        document.getElementById("expenseDate").value = data.date;
        document.getElementById("expenseCategory").value = data.category;
        document.getElementById("expenseAmount").value = data.amount;
        document.getElementById("expenseDescription").value = data.description;
        document.getElementById("expenseNotes").value = data.notes || "";
        // Hapus data lama setelah edit
        await supabase.from("expenses").delete().eq("id", id);
        loadExpenses();
      }

      async function deleteExpense(id) {
        if (!confirm("Hapus pengeluaran ini?")) return;
        const { error } = await supabase.from("expenses").delete().eq("id", id);
        if (error) {
          showAlert("Gagal menghapus pengeluaran", "error");
        } else {
          showAlert("Pengeluaran berhasil dihapus", "success");
          loadExpenses();
        }
      }

      function toggleReportMenu() {
        const subMenu = document.getElementById("reportSubMenu");
        const icon = document.querySelector("#reportMenuBtn .menu-icon");

        // Toggle the 'submenu-open' class to trigger the smooth CSS transition
        subMenu.classList.toggle("submenu-open");

        // Toggle icon rotation
        icon.classList.toggle("rotate-180");
      }

      // Navigation Functions
      function navigateToSection(sectionName) {
        // Hide all sections
       // console.log("Navigasi ke section:", sectionName); // Debug log

  // Hide all sections
  document.querySelectorAll(".section").forEach((section) => {
    section.classList.add("hidden");
  });

  // Show selected section
  const sectionEl = document.getElementById(sectionName + "Section");
  if (sectionEl) {
    sectionEl.classList.remove("hidden");
  // console.log("Section ditemukan dan ditampilkan:", sectionName + "Section");
  // } else {
  //   console.warn("Section tidak ditemukan:", sectionName + "Section");
  }
        // Update page title
        const titles = {
          dashboard: "Dashboard",
          transaction: "Transaksi",
          services: "Jasa Kendaraan",
          employees: "Karyawan",
          users: "Manajemen User",
          settings: "Pengaturan Toko",
          expenses: "Kas Keluar",
          report_profit_gross: "Laporan Laba Kotor",
          report_transactions: "Laporan Transaksi",
          report_cash_out: "Laporan Kas Keluar",
          report_profit_net: "Laporan Laba Bersih",
        };
        // Check if the title exists before setting it
        const pageTitleElement = document.getElementById("pageTitle");
        if (titles[sectionName] && pageTitleElement) {
          pageTitleElement.textContent = titles[sectionName];
        }

        // Load section-specific data
        switch (sectionName) {
          case "dashboard":
            loadDashboardData();
            break;
          case "transaction":
            loadTransactionData();
            break;
          case "services":
            loadServices();
            break;
          case "employees":
            loadEmployees();
            loadSalarySettings();
            break;
          case "users":
            loadUsers();
            break;
          case "settings":
            loadStoreSettings();
            break;
          case "expenses":
            loadExpenses();
            setDefaultExpenseFilterDates();
            loadExpenses();
            break;
          case "report_profit_gross":
  setDefaultGrossReportDate(); // Set tanggal default hari ini
  clearGrossProfitTable();     // Kosongkan tabel saat pertama kali buka
  break;
          case "report_transactions":
            setDefaultDetailTransactionsDate();
      clearDetailTransactionsTable();
      resetDetailTransactionsStats();
      searchDetailTransactions();
            break;
          case "report_cash_out":
            setDefaultDetailKaskeluarDate();
            clearDetailKaskeluarTable();
            resetDetailKaskeluarStats();
            searchDetailKaskeluar();
            break;
          case "report_profit_net":
            setTodayDateLabaBersih();    // Set tanggal hari ini
  clearLabaBersihTable();      // Kosongkan tabel
  resetLabaBersihStats();      // Reset statistik
  // searchLabaBersih();
            break;
        }
      }

      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("sidebarOverlay");

        // Check if sidebar is currently hidden
        const isHidden = sidebar.classList.contains("-translate-x-full");

        if (isHidden) {
          // Show sidebar
          sidebar.classList.remove("-translate-x-full");
          sidebar.classList.add("translate-x-0");
          if (window.innerWidth < 1024) {
            overlay.classList.remove("hidden");
          }
        } else {
          // Hide sidebar
          sidebar.classList.add("-translate-x-full");
          sidebar.classList.remove("translate-x-0");
          if (window.innerWidth < 1024) {
            overlay.classList.add("hidden");
          }
        }
      }

      // Data Loading Functions
      async function loadInitialData() {
        try {
          await Promise.all([
            loadServices(),
            loadEmployees(),
            loadSalarySettings(),
          ]);
        } catch (error) {
          console.error("Error loading initial data:", error);
        }
      }
      
      async function loadDashboardData() {
        try {
          // Ambil tanggal hari ini di zona Asia/Jakarta
          const now = new Date();
          const jakartaOffset = 8 * 60; // +08:00 dalam menit
          const localOffset = now.getTimezoneOffset();
          const jakartaTime = new Date(
            now.getTime() + (jakartaOffset - localOffset) * 60000
          );
          const today = jakartaTime.toISOString().split("T")[0];
          // Query present employees hari ini
          const { data: employees } = await supabase
            .from("employees")
            .select("*")
            .eq("is_present", true)
            .eq("is_active", true);
          // Query data hari ini
          const { data: transactions } = await supabase
            .from("transactions")
            .select("*")
            .gte("created_at", today + "T00:00:00+08:00")
            .lt("created_at", today + "T23:59:59+08:00");

          const { data: expenses } = await supabase
            .from("expenses")
            .select("*")
            .gte("date", today)
            .lte("date", today);

          const paidTransactions =
            transactions?.filter((t) => t.status === "paid") || [];
          const unpaidTransactions =
            transactions?.filter((t) => t.status === "unpaid") || [];
          const totalRevenue = paidTransactions.reduce(
            (sum, t) => sum + t.price,
            0
          );
          const totalExpenses =
            expenses?.reduce((sum, e) => sum + e.amount, 0) || 0;
          const netProfit = totalRevenue - totalExpenses;

          document.getElementById("presentEmployees").textContent =
            employees?.length || 0;
          document.getElementById("todayTransactions").textContent =
            paidTransactions.length;
          document.getElementById("todayRevenue").textContent =
            formatCurrency(totalRevenue);
          document.getElementById("unpaidTransactions").textContent =
            unpaidTransactions.length;
          document.getElementById("todayExpenses").textContent =
            formatCurrency(totalExpenses);
          document.getElementById("todayNetProfit").textContent =
            formatCurrency(netProfit);
        } catch (error) {
          console.error("Error loading dashboard data:", error);
        }
      }

      async function loadTransactionData() {
        await loadStoreSettings(); // Pastikan data toko diambil dulu
        await checkEmployeeValidation();
        await loadPresentEmployees();
        setDefaultDateFilters();
        currentTransactionView = "paid";
        document.getElementById("statusFilter").value = "paid";
        await loadTransactions();
        updateTabButtons();
      }

      function setDefaultDateFilters() {
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("dateFrom").value = today;
        document.getElementById("dateTo").value = today;
      }

      function resetDateFilter() {
        setDefaultDateFilters();
        currentPage = 1;
        loadTransactions();
      }

      async function loadPresentEmployees() {
        try {
          const { data: presentEmployees } = await supabase
            .from("employees")
            .select("*")
            .eq("is_present", true)
            .eq("is_active", true)
            .order("name");

          const employeesList = document.getElementById("presentEmployeesList");

          if (!presentEmployees || presentEmployees.length === 0) {
            employeesList.innerHTML =
              '<div class="text-red-600"><i class="fas fa-exclamation-triangle mr-1"></i>Tidak ada karyawan yang hadir</div>';
          } else {
            const employeeNames = presentEmployees
              .map((emp) => emp.name)
              .join(", ");
            employeesList.innerHTML = `<div><i class="fas fa-check-circle mr-1"></i>${employeeNames} (${presentEmployees.length} orang)</div>`;
          }
        } catch (error) {
          console.error("Error loading present employees:", error);
          document.getElementById("presentEmployeesList").innerHTML =
            '<div class="text-red-600">Gagal memuat data karyawan</div>';
        }
      }

      async function loadServices() {
        try {
          const { data, error } = await supabase
            .from("services")
            .select("*")
            .eq("is_active", true)
            .order("name");

          if (error) throw error;

          availableServices = data || [];

          // Update services table
          displayServicesTable(availableServices);

          // Update edit transaction dropdown
          updateEditTransactionDropdown();
        } catch (error) {
          console.error("Error loading services:", error);
        }
      }

      function displayServicesTable(services) {
        const tableBody = document.getElementById("servicesTableBody");
        const emptyState = document.getElementById("servicesEmptyState");

        tableBody.innerHTML = "";

        if (!services || services.length === 0) {
          emptyState.classList.remove("hidden");
          return;
        }

        emptyState.classList.add("hidden");

        services.forEach((service, index) => {
          const row = document.createElement("tr");
          row.className =
            "border-b border-gray-100 hover:bg-gray-50 transition-colors";
          row.innerHTML = `
                    <td class="py-4 px-4 text-gray-700 font-medium">${
                      index + 1
                    }</td>
                    <td class="py-4 px-4">
                        <div class="font-medium text-gray-900">${
                          service.name
                        }</div>
                        <div class="text-sm text-gray-500">Jasa cuci kendaraan</div>
                    </td>
                    <td class="py-4 px-4">
                        <span class="font-semibold text-blue-600">${formatCurrency(
                          service.price
                        )}</span>
                    </td>
                    <td class="py-4 px-4 text-center">
                        <div class="flex items-center justify-center space-x-2">
                            <button onclick="showServiceModal(${
                              service.id
                            })" class="text-blue-600 hover:text-blue-800 p-2 rounded-lg hover:bg-blue-100 transition-colors" title="Edit Jasa">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteService(${
                              service.id
                            })" class="text-red-600 hover:text-red-800 p-2 rounded-lg hover:bg-red-100 transition-colors" title="Hapus Jasa">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
          tableBody.appendChild(row);
        });
      }

      function filterServices(searchTerm) {
        const filteredServices = availableServices.filter((service) =>
          service.name.toLowerCase().includes(searchTerm.toLowerCase())
        );
        displayServicesTable(filteredServices);
      }

      function clearServiceSearch() {
        document.getElementById("serviceSearchInput").value = "";
        displayServicesTable(availableServices);
      }

      function updateEditTransactionDropdown() {
        availableServices.forEach((service) => {
          const option = document.createElement("option");
          option.value = service.id;
          option.textContent = `${service.name} - ${formatCurrency(
            service.price
          )}`;
          option.dataset.price = service.price;
          // editSelect.appendChild(option);
        });
      }

      async function loadEmployees() {
        try {
          const { data, error } = await supabase
            .from("employees")
            .select("*")
            .eq("is_active", true)
            .order("name");

          if (error) throw error;

          const employeesList = document.getElementById("employeesList");
          employeesList.innerHTML = "";

          if (!data || data.length === 0) {
            employeesList.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-users text-4xl mb-4"></i>
                            <p>Belum ada karyawan yang terdaftar</p>
                        </div>
                    `;
          } else {
            data.forEach((employee) => {
              const employeeItem = createEmployeeItem(employee);
              employeesList.appendChild(employeeItem);
            });
          }

          await updateSalarySummary();
          updateEmployeeAddButton();
        } catch (error) {
          console.error("Error loading employees:", error);
        }
      }

      async function loadUsers() {
        try {
          const { data, error } = await supabase
            .from("users")
            .select("*")
            .order("username");

          if (error) throw error;

          const usersList = document.getElementById("usersList");
          usersList.innerHTML = "";

          if (!data || data.length === 0) {
            usersList.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-user-cog text-4xl mb-4"></i>
                            <p>Belum ada user yang terdaftar</p>
                        </div>
                    `;
          } else {
            data.forEach((user) => {
              const userItem = createUserItem(user);
              usersList.appendChild(userItem);
            });
          }
        } catch (error) {
          console.error("Error loading users:", error);
        }
      }

      async function loadTransactions() {
  try {
    const paymentFilter = document.getElementById("paymentFilter").value;
    const dateFrom = document.getElementById("dateFrom").value;
    const dateTo = document.getElementById("dateTo").value;

    // Build base queries
    let countQueryPaid = supabase
      .from("transactions")
      .select("*", { count: "exact", head: true })
      .eq("status", "paid");

    let countQueryUnpaid = supabase
      .from("transactions")
      .select("*", { count: "exact", head: true })
      .eq("status", "unpaid");

    let dataQuery = supabase
      .from("transactions")
      .select(`*, services(name)`)
      .eq("status", currentTransactionView);

    // Apply date filters
    if (dateFrom) {
      countQueryPaid = countQueryPaid.gte("created_at", dateFrom + "T00:00:00");
      countQueryUnpaid = countQueryUnpaid.gte(
        "created_at",
        dateFrom + "T00:00:00"
      );
      dataQuery = dataQuery.gte("created_at", dateFrom + "T00:00:00");
    }
    if (dateTo) {
      countQueryPaid = countQueryPaid.lte("created_at", dateTo + "T23:59:59");
      countQueryUnpaid = countQueryUnpaid.lte(
        "created_at",
        dateTo + "T23:59:59"
      );
      dataQuery = dataQuery.lte("created_at", dateTo + "T23:59:59");
    }

    // Apply payment method filter (only for paid)
    if (paymentFilter && currentTransactionView === "paid") {
      countQueryPaid = countQueryPaid.eq("payment_method", paymentFilter);
      dataQuery = dataQuery.eq("payment_method", paymentFilter);
    }

    // Get counts
    const { count: totalCountPaid } = await countQueryPaid;
    const { count: totalCountUnpaid } = await countQueryUnpaid;

    // Update tab counters
    document.getElementById("paidTabCount").textContent = totalCountPaid || 0;
    document.getElementById("unpaidTabCount").textContent = totalCountUnpaid || 0;

    // 💡 Tambahan: update totalCount untuk tampilan aktif
    const totalActiveCount =
      currentTransactionView === "paid"
        ? totalCountPaid || 0
        : totalCountUnpaid || 0;
    document.getElementById("totalCount").textContent = totalActiveCount;

    // Ambil data paginated
    const offset = (currentPage - 1) * rowsPerPage;
    const { data, error } = await dataQuery
      .order("created_at", { ascending: false })
      .range(offset, offset + rowsPerPage - 1);

    if (error) throw error;

    const transactionsList = document.getElementById("transactionsList");
    transactionsList.innerHTML = "";

    if (!data || data.length === 0) {
      const isPaid = currentTransactionView === "paid";
      const filterText =
        paymentFilter && isPaid ? ` dengan metode ${paymentFilter}` : "";
      const iconClass = isPaid
        ? "fas fa-receipt text-green-600"
        : "fas fa-clock text-orange-400";
      const bgClass = isPaid ? "bg-green-100" : "bg-orange-100";
      const statusText = isPaid ? "sudah dibayar" : "belum dibayar";

      transactionsList.innerHTML = `
        <div class="text-center py-12">
          <div class="${bgClass} rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-4">
            <i class="${iconClass} text-3xl"></i>
          </div>
          <h3 class="text-lg font-medium text-gray-900 mb-2">Belum Ada Transaksi</h3>
          <p class="text-gray-500">Transaksi yang ${statusText}${filterText} akan muncul di sini</p>
          <button onclick="loadTransactions()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            <i class="fas fa-refresh mr-2"></i>Refresh Data
          </button>
        </div>
      `;
    } else {
      const fragment = document.createDocumentFragment();
      data.forEach((transaction, index) => {
        const isPaid = transaction.status === "paid";
        const rowNumber = (currentPage - 1) * rowsPerPage + index + 1;
        const transactionItem = createTransactionItem(
          transaction,
          isPaid,
          rowNumber
        );
        fragment.appendChild(transactionItem);
      });
      transactionsList.appendChild(fragment);
    }

    // Update pagination
    updatePagination();
  } catch (error) {
    console.error("❌ Error loading transactions:", error);
    const transactionsList = document.getElementById("transactionsList");
    transactionsList.innerHTML = `
      <div class="text-center py-8 text-red-500">
        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
        <h3 class="text-lg font-medium mb-2">Gagal Memuat Data</h3>
        <p class="text-sm mb-4">${error.message}</p>
        <button onclick="loadTransactions()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
          <i class="fas fa-redo mr-2"></i>Coba Lagi
        </button>
      </div>
    `;

    // Reset counts to 0
    document.getElementById("paidTabCount").textContent = "0";
    document.getElementById("unpaidTabCount").textContent = "0";
    document.getElementById("totalCount").textContent = "0";
  }
}


      async function loadSalarySettings() {
        try {
          const { data, error } = await supabase
            .from("salary_settings")
            .select("*")
            .single();

          if (data) {
            document.getElementById("salaryPerMotor").value =
              data.salary_per_motor || 7000;
          }

          await updateSalarySummary();
        } catch (error) {
          console.error("Error loading salary settings:", error);
          document.getElementById("salaryPerMotor").value = 7000;
        }
      }
    </script>
    <script>
      // ===== PERBAIKAN 5: Improved loadStoreSettings =====
      async function loadStoreSettings() {
        try {
          console.log(
            "[loadStoreSettings] Loading store settings from database..."
          );

          const { data, error } = await supabase
            .from("store_settings")
            .select("*")
            .single();

          if (error) {
            console.error("[loadStoreSettings] Database error:", error);
            throw error;
          }

          console.log("[loadStoreSettings] Data loaded:", data);

          // Update form fields jika ada
          const formFields = [
            { id: "storeName", value: data.name },
            { id: "storeAddress", value: data.address },
            { id: "storePhone", value: data.phone },
            { id: "storeEmail", value: data.email },
            { id: "receiptFooterMessage", value: data.footer_message },
            { id: "marginTop", value: data.margin_top || 5 },
            { id: "marginLeft", value: data.margin_left || 5 },
            { id: "marginRight", value: data.margin_right || 5 },
            { id: "marginBottom", value: data.margin_bottom || 5 },
            { id: "receiptFont", value: data.font || "Courier New" },
          ];

          formFields.forEach((field) => {
            const element = document.getElementById(field.id);
            if (element) {
              element.value = field.value || "";
            }
          });

          // Update display elements
          const displayElements = [
            { id: "receiptStoreName", content: data.name },
            { id: "receiptStoreAddress", content: data.address },
            { id: "receiptStorePhone", content: `Telp: ${data.phone || ""}` },
            { id: "receiptFooter", content: data.footer_message },
            {
              id: "storeNameHeader",
              content: data.name || "Wash Management System",
            },
          ];

          displayElements.forEach((element) => {
            const el = document.getElementById(element.id);
            if (el) {
              el.textContent = element.content || "";
            }
          });

          // Update document title
          document.title = `${
            data.name || "Wash Management System"
          } - Wash Management System`;

          // ===== LOGO HANDLING =====
          const logoUrl = data.logo_url || "";
          console.log("[loadStoreSettings] Processing logo URL:", logoUrl);

          // Reset flags
          _logoWillBeDeleted = false;
          _pendingLogoFile = null;

          // Update logo-related fields
          const logoUrlInput = document.getElementById("logoUrlCurrent");
          if (logoUrlInput) {
            logoUrlInput.value = logoUrl;
          }

          // Update all logo displays
          setSrc("storeLogoPreview", logoUrl);
          // applyLogoUI(logoUrl);
          applyLoginLogoUI(logoUrl);
          applyReceiptLogoUI(logoUrl);

          // Update reset button state
          if (typeof toggleResetButton === "function") {
            toggleResetButton(!!logoUrl);
          }

          console.log("[loadStoreSettings] Store settings loaded successfully");
        } catch (error) {
          console.error("Error loading store settings:", error);
          showAlert("Gagal memuat pengaturan toko", "error");
        }
      }

      function applyReceiptLogoUI(logoUrl) {
        const img = document.getElementById("receiptLogoPreview");
        console.log("[applyReceiptLogoUI] logoUrl:", logoUrl);
        if (img) {
          if (logoUrl) {
            img.src = logoUrl;
            img.classList.remove("hidden");
          } else {
            img.classList.add("hidden");
          }
        }
      }

      function updateFaviconWithLogo(logoUrl) {
        let favicon = document.querySelector('link[rel="icon"]');
        if (!favicon) {
          favicon = document.createElement("link");
          favicon.rel = "icon";
          favicon.type = "image/png";
          document.head.appendChild(favicon);
        }
        // Jika logoUrl kosong, fallback ke default favicon
        favicon.href =
          logoUrl && logoUrl.trim() !== "" ? logoUrl : "/favicon.png";
      }

      // ===== PERBAIKAN 4: Enhanced applyLoginLogoUI =====
      function applyLoginLogoUI(logoUrl) {
        console.log("[applyLoginLogoUI] Called with logoUrl:", logoUrl);

        const img = document.getElementById("loginLogoHeader");
        const icon = document.getElementById("loginLogoIcon");

        if (!img || !icon) {
          console.warn("[applyLoginLogoUI] Elements not found:", {
            img: !!img,
            icon: !!icon,
          });
          return;
        }

        if (logoUrl && logoUrl.trim() !== "") {
          console.log("[applyLoginLogoUI] Setting logo image:", logoUrl);

          img.src = logoUrl;
          img.classList.remove("hidden");
          icon.classList.add("hidden");

          // Handle load error
          img.onerror = function () {
            console.error(
              "[applyLoginLogoUI] Failed to load logo, fallback to icon"
            );
            img.classList.add("hidden");
            icon.classList.remove("hidden");
          };
        } else {
          console.log("[applyLoginLogoUI] No logo URL, showing icon");
          img.classList.add("hidden");
          icon.classList.remove("hidden");
        }
        // Tambahkan di sini:
        updateFaviconWithLogo();
      }

      // Transaction Functions
      function updateReceiptPreview() {
        const plateNumber = document.getElementById("plateNumber").value;
        const vehicleSearch = document.getElementById("vehicleSearch").value;
        const price = document.getElementById("price").value;

        document.getElementById("receiptPlate").textContent =
          plateNumber || "-";
        document.getElementById("receiptService").textContent =
          vehicleSearch || "Cuci Motor";
        document.getElementById("receiptPrice").textContent = price
          ? formatCurrency(parseInt(price))
          : "Rp 0";
        document.getElementById("receiptTotal").textContent = price
          ? formatCurrency(parseInt(price))
          : "Rp 0";

        // Notes are never shown in receipt - always hidden
        const notesSection = document.getElementById("receiptNotesSection");
        notesSection.classList.add("hidden");
      }

      function updateReceiptDate() {
        const now = new Date();
        const dateStr =
          now.toLocaleDateString("id-ID") +
          " " +
          now.toLocaleTimeString("id-ID");
        document.getElementById("receiptDate").textContent = dateStr;
      }

      async function processTransaction(type) {
        // console.log("🚀 Processing transaction type:", type);

        const plateNumber = document.getElementById("plateNumber").value;
        const serviceId = document.getElementById("selectedServiceId").value;
        const price = document.getElementById("price").value;

        // console.log("📝 Form data:", { plateNumber, serviceId, price });

        if (!serviceId || !price) {
          showAlert("Mohon pilih jenis kendaraan terlebih dahulu", "error");
          return;
        }

        // Check employee validation
        const hasEmployees = await checkEmployeeValidation();
        if (!hasEmployees) {
          showAlert(
            "Tidak ada karyawan yang hadir. Mohon set kehadiran karyawan terlebih dahulu.",
            "error"
          );
          return;
        }

        const notes = document.getElementById("transactionNotes").value.trim();

        // Get present employees for this transaction
        const { data: presentEmployees } = await supabase
          .from("employees")
          .select("id, name")
          .eq("is_present", true)
          .eq("is_active", true);

        const employeeIds = presentEmployees
          ? presentEmployees.map((emp) => emp.id)
          : [];
        const employeeNames = presentEmployees
          ? presentEmployees.map((emp) => emp.name)
          : [];

        currentTransaction = {
          plate_number: plateNumber || null,
          service_id: parseInt(serviceId),
          price: parseInt(price),
          notes: notes || null,
          status: type === "pay" ? "paid" : "unpaid",
          created_by: currentUser.id,
          employee_ids: employeeIds,
          employee_names: employeeNames,
        };

        // console.log("💾 Transaction object created:", currentTransaction);

        if (type === "pay") {
          showPaymentModal();
        } else {
          //   console.log("💰 Saving unpaid transaction...");
          await saveTransaction();
        }
      }

      function showPaymentModal() {
        document.getElementById("paymentModal").classList.remove("hidden");
        document.getElementById("paymentModal").classList.add("flex");
        document.getElementById("paymentTotal").textContent = formatCurrency(
          currentTransaction.price
        );
      }

      function closePaymentModal() {
        document.getElementById("paymentModal").classList.add("hidden");
        document.getElementById("paymentModal").classList.remove("flex");
        document.getElementById("paymentAmountSection").classList.add("hidden");
        document.getElementById("confirmPaymentBtn").classList.add("hidden");
        document.getElementById("cashPaymentSection").classList.add("hidden");
        document
          .getElementById("nonCashPaymentSection")
          .classList.add("hidden");
        document.getElementById("changeAmount").classList.add("hidden");

        // Reset payment method buttons
        document.querySelectorAll(".payment-method-btn").forEach((btn) => {
          btn.classList.remove(
            "border-green-500",
            "border-blue-500",
            "border-purple-500",
            "bg-green-50",
            "bg-blue-50",
            "bg-purple-50"
          );
          btn.classList.add("border-gray-300");
        });

        // Reset form
        document.getElementById("paymentAmount").value = "";
        selectedPaymentMethod = null;
      }

      function selectPaymentMethod(method) {
        selectedPaymentMethod = method;

        // Update button styles
        document.querySelectorAll(".payment-method-btn").forEach((btn) => {
          btn.classList.remove(
            "border-green-500",
            "border-blue-500",
            "border-purple-500",
            "bg-green-50",
            "bg-blue-50",
            "bg-purple-50"
          );
          btn.classList.add("border-gray-300");
        });

        const selectedBtn = event.target.closest(".payment-method-btn");
        if (method === "cash") {
          selectedBtn.classList.add("border-green-500", "bg-green-50");
        } else if (method === "transfer") {
          selectedBtn.classList.add("border-blue-500", "bg-blue-50");
        } else if (method === "qris") {
          selectedBtn.classList.add("border-purple-500", "bg-purple-50");
        }

        // Show payment section
        document
          .getElementById("paymentAmountSection")
          .classList.remove("hidden");
        document.getElementById("confirmPaymentBtn").classList.remove("hidden");

        // Update method text
        const methodTexts = {
          cash: "Tunai",
          transfer: "Transfer Bank",
          qris: "QRIS",
        };
        document.getElementById("selectedMethodText").textContent =
          methodTexts[method];

        // Show appropriate payment section
        if (method === "cash") {
          document
            .getElementById("cashPaymentSection")
            .classList.remove("hidden");
          document
            .getElementById("nonCashPaymentSection")
            .classList.add("hidden");
          document.getElementById("paymentAmount").value =
            currentTransaction.price;
          document.getElementById("paymentAmount").focus();
          calculateChange();
        } else {
          document.getElementById("cashPaymentSection").classList.add("hidden");
          document
            .getElementById("nonCashPaymentSection")
            .classList.remove("hidden");
        }
      }

      function calculateChange() {
        const paymentAmount =
          parseInt(document.getElementById("paymentAmount").value) || 0;
        const total = currentTransaction.price;
        const change = paymentAmount - total;

        const changeDiv = document.getElementById("changeAmount");
        const changeValue = document.getElementById("changeValue");
        const confirmBtn = document.getElementById("confirmPaymentBtn");

        if (change >= 0) {
          changeValue.textContent = formatCurrency(change);
          changeDiv.classList.remove("hidden");
          confirmBtn.disabled = false;
          confirmBtn.classList.remove("bg-gray-400", "cursor-not-allowed");
          confirmBtn.classList.add("bg-green-600", "hover:bg-green-700");
        } else {
          changeDiv.classList.add("hidden");
          confirmBtn.disabled = true;
          confirmBtn.classList.add("bg-gray-400", "cursor-not-allowed");
          confirmBtn.classList.remove("bg-green-600", "hover:bg-green-700");
        }
      }

      async function confirmPayment() {
    let paymentAmount = currentTransaction.price;

    if (selectedPaymentMethod === "cash") {
        paymentAmount =
            parseInt(document.getElementById("paymentAmount").value) || 0;

        if (paymentAmount < currentTransaction.price) {
            showAlert("Jumlah pembayaran tidak mencukupi", "error");
            return;
        }
    }

    currentTransaction.payment_method = selectedPaymentMethod;
    currentTransaction.payment_amount = paymentAmount;

    // Show loading state
    const confirmBtn = document.getElementById("confirmPaymentBtn");
    const originalText = confirmBtn.innerHTML;
    confirmBtn.innerHTML =
        '<i class="fas fa-spinner fa-spin mr-2"></i>Memproses...';
    confirmBtn.disabled = true;

    try {
        let transactionData = null; // Variabel untuk menyimpan data transaksi hasil update/save

        if (currentTransaction.id) {
            // Get current present employees for payment update
            const { data: presentEmployees } = await supabase
                .from("employees")
                .select("id, name")
                .eq("is_present", true)
                .eq("is_active", true);

            const employeeIds = presentEmployees
                ? presentEmployees.map((emp) => emp.id)
                : [];
            const employeeNames = presentEmployees
                ? presentEmployees.map((emp) => emp.name)
                : [];

            // Update existing transaction from unpaid to paid
            const { data, error } = await supabase
                .from("transactions")
                .update({
                    status: "paid",
                    payment_method: selectedPaymentMethod,
                    payment_amount: paymentAmount,
                    paid_at: new Date().toISOString(),
                    employee_ids: employeeIds,
                    employee_names: employeeNames,
                })
                .eq("id", currentTransaction.id)
                .select("*, services(name)")
                .single();

            if (error) {
                console.error("❌ Error updating transaction:", error);
                throw error;
            }

            transactionData = data; // Simpan data hasil update
            
            // Update currentTransaction with the latest data
            currentTransaction = { ...currentTransaction, ...data };

            // Reload transactions and dashboard data
            await Promise.all([loadTransactions(), loadDashboardData()]);

            // Switch to paid view to show the updated transaction
            switchTransactionView("paid");
        } else {
            // console.log("💾 Saving new paid transaction...");
            // Save new transaction (Diasumsikan saveTransaction juga mengupdate currentTransaction)
            transactionData = await saveTransaction(); // saveTransaction harus mengembalikan data transaksi
        }

        closePaymentModal();
        
        // =======================================================
        // 🚀 BAGIAN PENTING: Panggil fungsi cetak otomatis di sini
        // =======================================================
        if (transactionData || currentTransaction.id) {
            // Kita menggunakan data transaksi terakhir untuk cetak
            const dataToPrint = transactionData || currentTransaction; 
            
            // 🛑 Panggil autoPrintThermalQZ untuk mencetak struk secara otomatis
            await autoPrintThermalQZ(dataToPrint);
        }

        // Update success modal with transaction details
        // Update success modal with transaction details
          const serviceName =
            currentTransaction.services?.name ||
            availableServices.find((s) => s.id == currentTransaction.service_id)
              ?.name ||
            "Layanan";
          
          // 🛑 PERBAIKAN POIN 3: Gunakan selectedPaymentMethod yang sudah pasti ada
          const selectedMethod = currentTransaction.payment_method || selectedPaymentMethod || 'cash';
          
          const methodText = {
            cash: "Tunai",
            transfer: "Transfer Bank",
            qris: "QRIS",
          }[selectedMethod]; // Gunakan selectedMethod yang diperiksa

          document.getElementById("successTransactionDetails").innerHTML = `
            ${serviceName} - ${formatCurrency(
              currentTransaction.price
            )}<br>
            Metode: ${methodText}
            ${
              selectedMethod === "cash" &&
              paymentAmount > currentTransaction.price
                ? `<br>Kembalian: ${formatCurrency(
                    paymentAmount - currentTransaction.price
                  )}`
                : ""
            }
          `;

        showSuccessModal();

        //   console.log("✅ Payment process completed successfully");
    } catch (error) {
        console.error("❌ Payment error:", error);
        showAlert(`Gagal memproses pembayaran: ${error.message}`, "error");
    } finally {
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;
    }
}

      async function saveTransaction() {
        try {
    const { data, error } = await supabase
      .from("transactions")
      .insert([currentTransaction])
      .select("*, services(name)")
      .single();

    if (error) throw error;

    // Reset form
    document.getElementById("transactionForm").reset();
    document.getElementById("vehicleSearch").value = "";
    document.getElementById("vehicleSearch").dataset.selectedName = "";
    document.getElementById("selectedServiceId").value = "";
    document.getElementById("price").value = "";
    document.getElementById("transactionNotes").value = "";
    updateReceiptPreviewFromData(data);

    await Promise.all([loadTransactions(), loadDashboardData()]);

    if (currentTransaction.status === "unpaid") {
      switchTransactionView("unpaid");
      showAlert("Transaksi disimpan ke daftar belum bayar", "success");
    } else {
      switchTransactionView("paid");
      showAlert(
        `Pembayaran ${currentTransaction.payment_method?.toUpperCase() || "TUNAI"} berhasil`,
        "success"
      );

      // 🔥 Cetak otomatis ke printer thermal via QZ Tray
      await autoPrintThermalQZ(data);
    }
  } catch (error) {
    console.error("Error saving transaction:", error);
    showAlert("Gagal menyimpan transaksi: " + error.message, "error");
  }
}

      function showSuccessModal() {
  const modal = document.getElementById("successModal");
  modal.classList.remove("hidden");
  modal.classList.add("flex");

  // Tutup otomatis setelah 3 detik (3000 milidetik)
  setTimeout(closeSuccessModal, 3000);
}

function closeSuccessModal() {
  const modal = document.getElementById("successModal");
  modal.classList.add("hidden");
  modal.classList.remove("flex");
}

      function generateReceiptHTML() {
        const storeName =
          document.getElementById("receiptStoreName").textContent;
        const storeAddress = document.getElementById(
          "receiptStoreAddress"
        ).textContent;
        const storePhone =
          document.getElementById("receiptStorePhone").textContent;
        const receiptNumber =
          document.getElementById("receiptNumber").textContent;
        const receiptDate = document.getElementById("receiptDate").textContent;
        const receiptPlate =
          document.getElementById("receiptPlate").textContent;
        const receiptService =
          document.getElementById("receiptService").textContent;
        const receiptPrice =
          document.getElementById("receiptPrice").textContent;
        const receiptTotal =
          document.getElementById("receiptTotal").textContent;
        const receiptFooter =
          document.getElementById("receiptFooter").textContent;

        return `
                <div class="center bold">${storeName}</div>
                <div class="center">${storeAddress}</div>
                <div class="center">${storePhone}</div>
                <div class="line"></div>
                <div>No: ${receiptNumber}</div>
                <div>Tanggal: ${receiptDate}</div>
                <div>Plat: ${receiptPlate}</div>
                <div class="line"></div>
                <div class="flex">
                    <span>${receiptService}</span>
                    <span>${receiptPrice}</span>
                </div>
                <div class="line"></div>
                <div class="flex bold">
                    <span>TOTAL</span>
                    <span>${receiptTotal}</span>
                </div>
                <div class="line"></div>
                <div class="center">${receiptFooter}</div>
            `;
      }

      async function printToBluetooth() {
        try {
          // Check if Bluetooth is available
          if (!navigator.bluetooth) {
            throw new Error("Bluetooth tidak didukung di browser ini");
          }

          // Request device with proper filters for thermal printers
          const device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: [
              "000018f0-0000-1000-8000-00805f9b34fb", // Common thermal printer service
              "49535343-fe7d-4ae5-8fa9-9fafd205e455", // Another common service
              "0000ff00-0000-1000-8000-00805f9b34fb", // Generic printer service
            ],
          });

          if (!device.gatt) {
            throw new Error("Perangkat tidak mendukung GATT");
          }

          showAlert("Menghubungkan ke printer...", "info");
          const server = await device.gatt.connect();

          // Try different service UUIDs
          let service, characteristic;
          const serviceUUIDs = [
            "000018f0-0000-1000-8000-00805f9b34fb",
            "49535343-fe7d-4ae5-8fa9-9fafd205e455",
            "0000ff00-0000-1000-8000-00805f9b34fb",
          ];

          const characteristicUUIDs = [
            "00002af1-0000-1000-8000-00805f9b34fb",
            "49535343-1e4d-4bd9-ba61-23c647249616",
            "0000ff01-0000-1000-8000-00805f9b34fb",
          ];

          for (const serviceUUID of serviceUUIDs) {
            try {
              service = await server.getPrimaryService(serviceUUID);
              for (const charUUID of characteristicUUIDs) {
                try {
                  characteristic = await service.getCharacteristic(charUUID);
                  break;
                } catch (e) {
                  continue;
                }
              }
              if (characteristic) break;
            } catch (e) {
              continue;
            }
          }

          if (!characteristic) {
            throw new Error(
              "Tidak dapat menemukan karakteristik printer yang sesuai"
            );
          }

          // Generate receipt data
          const receiptData = generateReceiptData();
          await characteristic.writeValue(
            new TextEncoder().encode(receiptData)
          );

          showAlert("Struk berhasil dicetak via Bluetooth", "success");
        } catch (error) {
          console.error("Bluetooth printing failed:", error);

          let errorMessage = "Gagal mencetak via Bluetooth: ";

          if (error.name === "NotFoundError") {
            errorMessage +=
              "Tidak ada printer Bluetooth yang ditemukan atau dipilih";
          } else if (error.name === "SecurityError") {
            errorMessage +=
              "Akses Bluetooth ditolak. Pastikan situs menggunakan HTTPS";
          } else if (error.name === "NetworkError") {
            errorMessage +=
              "Gagal terhubung ke printer. Pastikan printer dalam jangkauan dan aktif";
          } else if (error.message.includes("GATT")) {
            errorMessage += "Printer tidak mendukung koneksi GATT";
          } else if (error.message.includes("karakteristik")) {
            errorMessage += "Printer tidak kompatibel dengan sistem";
          } else {
            errorMessage += error.message || "Kesalahan tidak diketahui";
          }

          showAlert(errorMessage, "error");

          // Fallback to browser print
          setTimeout(() => {
            showAlert("Menggunakan print browser sebagai alternatif", "info");
            // printReceiptBrowser();
          }, 2000);
        }
      }

      function generateReceiptData() {
        const storeName =
          document.getElementById("receiptStoreName").textContent;
        const storeAddress = document.getElementById(
          "receiptStoreAddress"
        ).textContent;
        const storePhone =
          document.getElementById("receiptStorePhone").textContent;
        const receiptNumber =
          document.getElementById("receiptNumber").textContent;
        const receiptDate = document.getElementById("receiptDate").textContent;
        const receiptPlate =
          document.getElementById("receiptPlate").textContent;
        const receiptService =
          document.getElementById("receiptService").textContent;
        const receiptPrice =
          document.getElementById("receiptPrice").textContent;
        const receiptTotal =
          document.getElementById("receiptTotal").textContent;
        const receiptFooter =
          document.getElementById("receiptFooter").textContent;

        return `
${storeName}
${storeAddress}
${storePhone}
--------------------------------
No: ${receiptNumber}
Tanggal: ${receiptDate}
Plat: ${receiptPlate}
--------------------------------
${receiptService}        ${receiptPrice}
--------------------------------
TOTAL           ${receiptTotal}
--------------------------------
${receiptFooter}

`;
      }

      // Service Management Functions
      function showServiceModal(serviceId = null) {
        editingServiceId = serviceId;

        if (serviceId) {
          loadServiceForEdit(serviceId);
          document.getElementById("serviceModalTitle").textContent =
            "Edit Jasa";
        } else {
          document.getElementById("serviceModalTitle").textContent =
            "Tambah Jasa Baru";
          document.getElementById("serviceForm").reset();
        }

        document.getElementById("serviceModal").classList.remove("hidden");
        document.getElementById("serviceModal").classList.add("flex");
      }

      async function loadServiceForEdit(serviceId) {
        try {
          const { data, error } = await supabase
            .from("services")
            .select("*")
            .eq("id", serviceId)
            .single();

          if (error) throw error;

          document.getElementById("serviceName").value = data.name;
          document.getElementById("servicePrice").value = data.price;
        } catch (error) {
          console.error("Error loading service for edit:", error);
        }
      }

      function closeServiceModal() {
        document.getElementById("serviceModal").classList.add("hidden");
        document.getElementById("serviceModal").classList.remove("flex");
        editingServiceId = null;
      }

      function setServicePrice(price) {
        document.getElementById("servicePrice").value = price;
      }

      async function saveService(e) {
        e.preventDefault();

        const name = document.getElementById("serviceName").value;
        const price = parseInt(document.getElementById("servicePrice").value);

        try {
          if (editingServiceId) {
            const { error } = await supabase
              .from("services")
              .update({ name, price })
              .eq("id", editingServiceId);

            if (error) throw error;
            showAlert("Jasa berhasil diperbarui", "success");
          } else {
            const { error } = await supabase
              .from("services")
              .insert([{ name, price }]);

            if (error) throw error;
            showAlert("Jasa berhasil ditambahkan", "success");
          }

          closeServiceModal();
          await loadServices();
        } catch (error) {
          console.error("Error saving service:", error);
          showAlert("Gagal menyimpan jasa", "error");
        }
      }

      async function deleteService(serviceId) {
        try {
          const { error } = await supabase
            .from("services")
            .update({ is_active: false })
            .eq("id", serviceId);

          if (error) throw error;

          showAlert("Jasa berhasil dihapus", "success");
          await loadServices();
        } catch (error) {
          console.error("Error deleting service:", error);
          showAlert("Gagal menghapus jasa", "error");
        }
      }

      // Employee Management Functions
      function showEmployeeModal(employeeId = null) {
        editingEmployeeId = employeeId;

        if (employeeId) {
          loadEmployeeForEdit(employeeId);
          document.getElementById("employeeModalTitle").textContent =
            "Edit Karyawan";
        } else {
          document.getElementById("employeeModalTitle").textContent =
            "Tambah Karyawan Baru";
          document.getElementById("employeeForm").reset();
        }

        document.getElementById("employeeModal").classList.remove("hidden");
        document.getElementById("employeeModal").classList.add("flex");
      }

      async function loadEmployeeForEdit(employeeId) {
        try {
          const { data, error } = await supabase
            .from("employees")
            .select("*")
            .eq("id", employeeId)
            .single();

          if (error) throw error;

          document.getElementById("employeeName").value = data.name;
          document.getElementById("employeePhone").value = data.phone || "";
        } catch (error) {
          console.error("Error loading employee for edit:", error);
        }
      }

      function closeEmployeeModal() {
        document.getElementById("employeeModal").classList.add("hidden");
        document.getElementById("employeeModal").classList.remove("flex");
        editingEmployeeId = null;
      }

      async function saveEmployee(e) {
        e.preventDefault();

        const name = document.getElementById("employeeName").value;
        const phone = document.getElementById("employeePhone").value;

        try {
          if (editingEmployeeId) {
            const { error } = await supabase
              .from("employees")
              .update({ name, phone })
              .eq("id", editingEmployeeId);

            if (error) throw error;
            showAlert("Karyawan berhasil diperbarui", "success");
          } else {
            const { error } = await supabase
              .from("employees")
              .insert([{ name, phone, is_present: false, is_active: true }]);

            if (error) throw error;
            showAlert("Karyawan berhasil ditambahkan", "success");
          }

          closeEmployeeModal();
          await loadEmployees();
        } catch (error) {
          console.error("Error saving employee:", error);
          showAlert("Gagal menyimpan karyawan", "error");
        }
      }

      async function deleteEmployee(employeeId) {
        try {
          const { error } = await supabase
            .from("employees")
            .delete()
            .eq("id", employeeId);

          if (error) throw error;

          showAlert("Karyawan berhasil dihapus", "success");
          await loadEmployees();
          await loadDashboardData();
        } catch (error) {
          console.error("Error deleting employee:", error);
          showAlert("Gagal menghapus karyawan", "error");
        }
      }

      async function toggleEmployeePresence(employeeId, isPresent) {
        try {
          const { error } = await supabase
            .from("employees")
            .update({ is_present: isPresent })
            .eq("id", employeeId);

          if (error) throw error;

          await loadEmployees();
          await loadDashboardData();
          await checkEmployeeValidation();
          await loadPresentEmployees();
        } catch (error) {
          console.error("Error updating employee presence:", error);
          showAlert("Gagal mengupdate kehadiran", "error");
        }
      }

      async function updateSalarySettings() {
        const salaryPerMotor = document.getElementById("salaryPerMotor").value;

        try {
          const { error } = await supabase
            .from("salary_settings")
            .upsert([{ id: 1, salary_per_motor: parseInt(salaryPerMotor) }]);

          if (error) throw error;

          showAlert("Pengaturan gaji berhasil disimpan", "success");
          await updateSalarySummary();
        } catch (error) {
          console.error("Error updating salary settings:", error);
          showAlert("Gagal menyimpan pengaturan gaji", "error");
        }
      }

      async function updateSalarySummary() {
        try {
          const { data: presentEmployees } = await supabase
            .from("employees")
            .select("*")
            .eq("is_present", true)
            .eq("is_active", true);

          const today = new Date().toISOString().split("T")[0];
          const { data: todayTransactions } = await supabase
            .from("transactions")
            .select("*")
            .eq("status", "paid")
            .gte("created_at", today + "T00:00:00")
            .lt("created_at", today + "T23:59:59");

          const presentCount = presentEmployees?.length || 0;
          const transactionCount = todayTransactions?.length || 0;
          const salaryPerMotor =
            parseInt(document.getElementById("salaryPerMotor").value) || 7000;

          const salaryPerEmployee =
            presentCount > 0
              ? (transactionCount * salaryPerMotor) / presentCount
              : 0;
          const totalSalary = salaryPerEmployee * presentCount;

          document.getElementById("presentCount").textContent = presentCount;
          document.getElementById("totalTransactions").textContent =
            transactionCount;
          document.getElementById("salaryPerEmployee").textContent =
            formatCurrency(salaryPerEmployee);
          document.getElementById("totalSalary").textContent =
            formatCurrency(totalSalary);
        } catch (error) {
          console.error("Error updating salary summary:", error);
        }
      }

      async function markAllPresent() {
        try {
          const { error } = await supabase
            .from("employees")
            .update({ is_present: true })
            .eq("is_active", true);

          if (error) throw error;

          showAlert("Semua karyawan aktif telah ditandai hadir", "success");
          await loadEmployees();
          await loadDashboardData();
          await checkEmployeeValidation();
          await loadPresentEmployees();
        } catch (error) {
          console.error("Error marking all present:", error);
          showAlert("Gagal menandai kehadiran semua karyawan", "error");
        }
      }

      async function markAllAbsent() {
        try {
          const { error } = await supabase
            .from("employees")
            .update({ is_present: false })
            .eq("is_active", true);

          if (error) throw error;

          showAlert("Semua karyawan telah ditandai tidak hadir", "success");
          await loadEmployees();
          await loadDashboardData();
          await checkEmployeeValidation();
          await loadPresentEmployees();
        } catch (error) {
          console.error("Error marking all absent:", error);
          showAlert("Gagal menandai ketidakhadiran semua karyawan", "error");
        }
      }

      // User Management Functions
      function showUserModal(userId = null) {
        editingUserId = userId;

        if (userId) {
          loadUserForEdit(userId);
          document.getElementById("userModalTitle").textContent = "Edit User";
        } else {
          document.getElementById("userModalTitle").textContent =
            "Tambah User Baru";
          document.getElementById("userForm").reset();
        }

        document.getElementById("userModal").classList.remove("hidden");
        document.getElementById("userModal").classList.add("flex");
      }

      async function loadUserForEdit(userId) {
        try {
          const { data, error } = await supabase
            .from("users")
            .select("*")
            .eq("id", userId)
            .single();

          if (error) throw error;

          document.getElementById("newUsername").value = data.username;
          document.getElementById("newPassword").value = data.password;
          document.getElementById("userRole").value = data.role;

          const accessMenu = data.access_menu || [];
          document
            .querySelectorAll('input[name="menuAccess"]')
            .forEach((checkbox) => {
              checkbox.checked = accessMenu.includes(checkbox.value);
            });

          const allCheckboxes = document.querySelectorAll(
            'input[name="menuAccess"]'
          );
          const checkedCheckboxes = document.querySelectorAll(
            'input[name="menuAccess"]:checked'
          );
          document.getElementById("accessAll").checked =
            allCheckboxes.length === checkedCheckboxes.length;
        } catch (error) {
          console.error("Error loading user for edit:", error);
        }
      }

      function closeUserModal() {
        document.getElementById("userModal").classList.add("hidden");
        document.getElementById("userModal").classList.remove("flex");
        editingUserId = null;
      }

      async function saveUser(e) {
        e.preventDefault();

        const username = document.getElementById("newUsername").value.trim();
        const password = document.getElementById("newPassword").value;
        const role = document.getElementById("userRole").value;
        const menuAccess = Array.from(
          document.querySelectorAll('input[name="menuAccess"]:checked')
        ).map((cb) => cb.value);

        if (!username || !password || !role) {
          showAlert("Semua field harus diisi!", "error");
          return;
        }

        if (menuAccess.length === 0) {
          showAlert("Pilih minimal satu akses menu!", "error");
          return;
        }

        try {
          if (editingUserId) {
            const { data: updatedUser, error } = await supabase
              .from("users")
              .update({
                username,
                password,
                role,
                access_menu: menuAccess,
              })
              .eq("id", editingUserId)
              .select()
              .single();

            if (error) throw error;

            // Jika user yang diedit adalah user yang sedang login, update localStorage
            if (currentUser && currentUser.id === editingUserId) {
              currentUser = { ...currentUser, ...updatedUser };
              localStorage.setItem("currentUser", JSON.stringify(currentUser));
              document.getElementById("currentUser").textContent =
                currentUser.username;
              document.getElementById("mobileCurrentUser").textContent =
                currentUser.username;
              document
                .querySelectorAll("#currentUser, #mobileCurrentUser")
                .forEach((el) => {
                  if (el)
                    el.nextElementSibling.textContent =
                      currentUser.role === "admin"
                        ? "Admin"
                        : "Karyawan";
                });
              updateSidebarAccess();
            }

            showAlert("User berhasil diperbarui", "success");
          } else {
            const { error } = await supabase.from("users").insert([
              {
                username,
                password,
                role,
                access_menu: menuAccess,
                is_active: true,
              },
            ]);

            if (error) throw error;
            showAlert("User berhasil ditambahkan", "success");
          }

          closeUserModal();
          await loadUsers();
        } catch (error) {
          console.error("Error saving user:", error);

          // Check for specific error types
          if (error.code === "23505") {
            showAlert("Username sudah digunakan!", "error");
          } else {
            showAlert("Gagal menyimpan user: " + error.message, "error");
          }
        }
      }

      async function deleteUser(userId) {
        try {
          const { error } = await supabase
            .from("users")
            .delete()
            .eq("id", userId);

          if (error) throw error;

          showAlert("User berhasil dihapus", "success");
          await loadUsers();
        } catch (error) {
          console.error("Error deleting user:", error);
          showAlert("Gagal menghapus user", "error");
        }
      }

      async function toggleUserStatus(userId, newStatus) {
        try {
          const { error } = await supabase
            .from("users")
            .update({ is_active: newStatus })
            .eq("id", userId);

          if (error) throw error;

          showAlert(
            `User berhasil ${newStatus ? "diaktifkan" : "dinonaktifkan"}`,
            "success"
          );
          await loadUsers();
        } catch (error) {
          console.error("Error updating user status:", error);
          showAlert("Gagal mengubah status user", "error");
        }
      }

      // Transaction View Functions
      function switchTransactionView(view) {
        currentTransactionView = view;
        currentPage = 1;

        // Update status filter dropdown
        document.getElementById("statusFilter").value = view;

        // Update tab buttons
        updateTabButtons();

        // Load transactions for the new view
        loadTransactions();
      }

      function updateTabButtons() {
        // Reset all tab buttons
        document.querySelectorAll(".tab-button").forEach((btn) => {
          btn.classList.remove("active", "border-blue-500", "text-blue-600");
          btn.classList.add("border-transparent", "text-gray-500");
        });

        // Set active class based on current transaction view
        if (currentTransactionView === "paid") {
          document
            .getElementById("paidTabBtn")
            .classList.add("active", "border-blue-500", "text-blue-600");
        } else {
          document
            .getElementById("unpaidTabBtn")
            .classList.add("active", "border-blue-500", "text-blue-600");
        }

        // Show/hide payment filter based on current view
        const paymentFilter = document.getElementById("paymentFilter");
        if (currentTransactionView === "paid") {
          paymentFilter.style.display = "block";
        } else {
          paymentFilter.style.display = "none";
          paymentFilter.value = ""; // Reset filter when switching to unpaid
        }
      }

      function updatePagination() {
        const totalPages = Math.ceil(totalTransactions / rowsPerPage);
        const paginationContainer = document.getElementById(
          "transactionsPagination"
        );

        if (totalPages <= 1) {
          paginationContainer.innerHTML = "";
          return;
        }

        let paginationHTML = "";

        // Previous button
        if (currentPage > 1) {
          paginationHTML += `
                    <button onclick="changePage(${
                      currentPage - 1
                    })" class="px-3 py-2 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                `;
        }

        // Page numbers
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);

        if (startPage > 1) {
          paginationHTML += `
                    <button onclick="changePage(1)" class="px-3 py-2 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-50">1</button>
                `;
          if (startPage > 2) {
            paginationHTML += '<span class="px-2 text-gray-500">...</span>';
          }
        }

        for (let i = startPage; i <= endPage; i++) {
          const isActive = i === currentPage;
          paginationHTML += `
                    <button onclick="changePage(${i})" class="px-3 py-2 text-sm ${
            isActive
              ? "bg-blue-600 text-white"
              : "bg-white text-gray-700 hover:bg-gray-50"
          } border border-gray-300 rounded-lg">
                        ${i}
                    </button>
                `;
        }

        if (endPage < totalPages) {
          if (endPage < totalPages - 1) {
            paginationHTML += '<span class="px-2 text-gray-500">...</span>';
          }
          paginationHTML += `
                    <button onclick="changePage(${totalPages})" class="px-3 py-2 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-50">${totalPages}</button>
                `;
        }

        // Next button
        if (currentPage < totalPages) {
          paginationHTML += `
                    <button onclick="changePage(${
                      currentPage + 1
                    })" class="px-3 py-2 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                `;
        }

        paginationContainer.innerHTML = paginationHTML;
      }

      function changePage(page) {
        currentPage = page;
        loadTransactions();
      }

      async function payTransaction(transactionId) {
        try {
          const { data: transaction, error } = await supabase
            .from("transactions")
            .select("*, services(name)")
            .eq("id", transactionId)
            .single();

          if (error) {
            console.error("❌ Error fetching transaction:", error);
            throw error;
          }

          if (!transaction) {
            console.error("❌ Transaction not found for ID:", transactionId);
            showAlert("Transaksi tidak ditemukan", "error");
            return;
          }

          currentTransaction = {
            ...transaction,
            id: transactionId,
            status: "paid",
          };

          showPaymentModal();
        } catch (error) {
          console.error("❌ Error loading transaction for payment:", error);
          showAlert(`Gagal memuat data transaksi: ${error.message}`, "error");
        }
      }

      async function deleteTransaction(transactionId) {
        // Use custom modal instead of confirm() due to sandbox restrictions
        showDeleteConfirmModal(transactionId);
      }

      function showDeleteConfirmModal(transactionId) {
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
        modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md text-center">
                    <div class="mb-4">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-600"></i>
                    </div>
                    <h3 class="text-lg font-semibold mb-2">Konfirmasi Hapus</h3>
                    <p class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus transaksi ini?</p>
                    
                    <div class="flex space-x-3">
                        <button onclick="closeDeleteModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition duration-200">
                            Batal
                        </button>
                        <button onclick="confirmDeleteTransaction(${transactionId})" class="flex-1 bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-200">
                            <i class="fas fa-trash mr-2"></i>Hapus
                        </button>
                    </div>
                </div>
            `;
        modal.id = "deleteConfirmModal";
        document.body.appendChild(modal);
      }

      function closeDeleteModal() {
        const modal = document.getElementById("deleteConfirmModal");
        if (modal) {
          modal.remove();
        }
      }

      async function confirmDeleteTransaction(transactionId) {
        closeDeleteModal();

        try {
          //   console.log("Deleting transaction ID:", transactionId);

          // First check if transaction exists
          const { data: existingTransaction, error: checkError } =
            await supabase
              .from("transactions")
              .select("*")
              .eq("id", transactionId)
              .single();

          if (checkError) {
            console.error("Transaction check error:", checkError);
            throw new Error("Transaksi tidak ditemukan");
          }

          // Delete the transaction
          const { error } = await supabase
            .from("transactions")
            .delete()
            .eq("id", transactionId);

          if (error) {
            console.error("Delete error:", error);
            throw error;
          }

          showAlert("Transaksi berhasil dihapus", "success");

          // Reload transactions and dashboard data
          await Promise.all([loadTransactions(), loadDashboardData()]);
        } catch (error) {
          console.error("Error deleting transaction:", error);
          showAlert(`Gagal menghapus transaksi: ${error.message}`, "error");
        }
      }

      // Edit Transaction Functions
      function showEditTransactionModal(transactionId) {
        editingTransactionId = transactionId;
        loadTransactionForEdit(transactionId);
        document
          .getElementById("editTransactionModal")
          .classList.remove("hidden");
        document.getElementById("editTransactionModal").classList.add("flex");
      }

      async function loadTransactionForEdit(transactionId) {
        try {
          const { data, error } = await supabase
            .from("transactions")
            .select("*, services(name)")
            .eq("id", transactionId)
            .single();

          if (error) throw error;

          document.getElementById("editPlateNumber").value =
            data.plate_number || "";
          document.getElementById("editTransactionNotes").value =
            data.notes || "";
          document.getElementById("editPrice").value = data.price;

          // Set vehicle search field
          if (data.services) {
            document.getElementById("editVehicleSearch").value =
              data.services.name;
            document.getElementById("editVehicleSearch").dataset.selectedName =
              data.services.name.toLowerCase();
            document.getElementById("editSelectedServiceId").value =
              data.service_id;
          }
        } catch (error) {
          console.error("Error loading transaction for edit:", error);
        }
      }

      function closeEditTransactionModal() {
        document.getElementById("editTransactionModal").classList.add("hidden");
        document
          .getElementById("editTransactionModal")
          .classList.remove("flex");
        editingTransactionId = null;

        // Reset form
        document.getElementById("editTransactionForm").reset();
        document.getElementById("editVehicleSearch").value = "";
        document.getElementById("editVehicleSearch").dataset.selectedName = "";
        document.getElementById("editSelectedServiceId").value = "";
        hideEditVehicleDropdown();
      }

      async function saveEditTransaction(e) {
        e.preventDefault();

        const plateNumber = document.getElementById("editPlateNumber").value;
        const serviceId = document.getElementById(
          "editSelectedServiceId"
        ).value;
        const price = document.getElementById("editPrice").value;
        const notes = document
          .getElementById("editTransactionNotes")
          .value.trim();

        if (!serviceId || !price) {
          showAlert("Mohon pilih jenis kendaraan terlebih dahulu", "error");
          return;
        }

        try {
          const { error } = await supabase
            .from("transactions")
            .update({
              plate_number: plateNumber || null,
              service_id: parseInt(serviceId),
              price: parseInt(price),
              notes: notes || null,
            })
            .eq("id", editingTransactionId);

          if (error) throw error;

          showAlert("Transaksi berhasil diperbarui", "success");
          closeEditTransactionModal();
          await loadTransactions();
        } catch (error) {
          console.error("Error updating transaction:", error);
          showAlert("Gagal memperbarui transaksi", "error");
        }
      }

      // Helper Functions
      async function getCurrentEmployeeName() {
        try {
          const { data: presentEmployees } = await supabase
            .from("employees")
            .select("name")
            .eq("is_present", true)
            .eq("is_active", true)
            .limit(1);

          return presentEmployees && presentEmployees.length > 0
            ? presentEmployees[0].name
            : "Karyawan hadir";
        } catch (error) {
          return "Karyawan hadir";
        }
      }

      function createServiceItem(service) {
        const div = document.createElement("div");
        div.className =
          "flex items-center justify-between p-4 border border-gray-200 rounded-lg";
        div.innerHTML = `
                <div>
                    <h4 class="font-medium">${service.name}</h4>
                    <p class="text-sm text-gray-600">${formatCurrency(
                      service.price
                    )}</p>
                </div>
                <div class="flex space-x-2">
                    <button onclick="showServiceModal(${
                      service.id
                    })" class="text-blue-600 hover:text-blue-800">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteService(${
                      service.id
                    })" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        return div;
      }

      function createEmployeeItem(employee) {
  const div = document.createElement("div");
  div.className =
    "flex items-center justify-between p-4 border border-gray-200 rounded-lg";
  div.innerHTML = `
    <div>
      <h4 class="font-medium">${employee.name}</h4>
      <p class="text-sm text-gray-600">${employee.phone || "Tidak ada nomor telepon"}</p>
    </div>
    <div class="flex items-center space-x-3">
      <label class="flex items-center">
        <input type="checkbox" ${employee.is_present ? "checked" : ""}
          onchange="toggleEmployeePresence(${employee.id}, this.checked)"
          class="mr-2">
        <span class="text-sm">${employee.is_present ? "Hadir" : "Tidak Hadir"}</span>
      </label>
      ${
        currentUser.role === "admin"
          ? `<div class="flex space-x-2">
              <button onclick="showEmployeeModal(${employee.id})" class="text-blue-600 hover:text-blue-800">
                <i class="fas fa-edit"></i>
              </button>
              <button onclick="deleteEmployee(${employee.id})" class="text-red-600 hover:text-red-800">
                <i class="fas fa-trash"></i>
              </button>
            </div>`
          : ""
      }
    </div>
  `;
  return div;
}

      function createUserItem(user) {
        const div = document.createElement("div");
        div.className =
          "flex items-center justify-between p-4 border border-gray-200 rounded-lg";

        const accessText =
          user.access_menu && user.access_menu.length > 0
            ? user.access_menu.join(", ")
            : "Tidak ada akses";

        const statusBadge = user.is_active
          ? '<span class="inline-block px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Aktif</span>'
          : '<span class="inline-block px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">Nonaktif</span>';

        div.innerHTML = `
                <div>
                    <div class="flex items-center space-x-2">
                        <h4 class="font-medium">${user.username}</h4>
                        ${statusBadge}
                    </div>
                    <p class="text-sm text-gray-600">Jabatan: ${user.role}</p>
                    <p class="text-xs text-gray-500">Akses: ${accessText}</p>
                </div>
                <div class="flex space-x-2">
                    <button onclick="showUserModal(${
                      user.id
                    })" class="text-blue-600 hover:text-blue-800">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="toggleUserStatus(${
                      user.id
                    }, ${!user.is_active})" class="text-yellow-600 hover:text-yellow-800">
                        <i class="fas fa-${
                          user.is_active ? "user-slash" : "user-check"
                        }"></i>
                    </button>
                    <button onclick="deleteUser(${
                      user.id
                    })" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        return div;
      }

      function createTransactionItem(transaction, isPaid, rowNumber) {
        const div = document.createElement("div");
        div.className = `p-4 border rounded-lg transition-all duration-200 hover:shadow-md ${
          isPaid
            ? "border-green-200 bg-green-50"
            : "border-orange-200 bg-orange-50"
        }`;
        div.dataset.paymentMethod = transaction.payment_method || "";

        const serviceName =
          transaction.services?.name || "Layanan Tidak Diketahui";
        const plateNumber = transaction.plate_number || "Tanpa Plat Nomor";
        const date = new Date(transaction.created_at).toLocaleDateString(
          "id-ID"
        );
        const time = new Date(transaction.created_at).toLocaleTimeString(
          "id-ID",
          {
            hour: "2-digit",
            minute: "2-digit",
          }
        );

        // Status badge
        let statusBadge = "";
        if (isPaid) {
          const methods = {
            cash: {
              name: "Tunai",
              color: "bg-green-100 text-green-800",
              icon: "fas fa-money-bill-wave",
            },
            transfer: {
              name: "Transfer",
              color: "bg-blue-100 text-blue-800",
              icon: "fas fa-university",
            },
            qris: {
              name: "QRIS",
              color: "bg-purple-100 text-purple-800",
              icon: "fas fa-qrcode",
            },
          };
          const method = methods[transaction.payment_method] || {
            name: "Paid",
            color: "bg-green-100 text-green-800",
            icon: "fas fa-check",
          };
          statusBadge = `
                    <span class="inline-flex items-center px-2 py-1 text-xs rounded-full ${method.color}">
                        <i class="${method.icon} mr-1"></i>
                        ${method.name}
                    </span>
                `;
        } else {
          statusBadge = `
                    <span class="inline-flex items-center px-2 py-1 text-xs rounded-full bg-orange-100 text-orange-800">
                        <i class="fas fa-clock mr-1"></i>
                        Belum Bayar
                    </span>
                `;
        }

        // Notes display
        const notesDisplay = transaction.notes
          ? `<div class="text-xs text-gray-600 mt-1 p-2 bg-yellow-50 border border-yellow-200 rounded">
                    <i class="fas fa-sticky-note mr-1"></i>
                    <strong>Catatan:</strong> ${transaction.notes}
                </div>`
          : "";

        // Employee names display
        const employeeNamesDisplay =
          transaction.employee_names && transaction.employee_names.length > 0
            ? `<div class="text-xs text-blue-600 mt-1 p-2 bg-blue-50 border border-blue-200 rounded">
                    <i class="fas fa-users mr-1"></i>
                    <strong>Karyawan:</strong> ${transaction.employee_names.join(
                      ", "
                    )}
                </div>`
            : "";

        // Different button sets for paid vs unpaid
        let actionButtons = "";
        if (isPaid) {
          actionButtons = `
                    <div class="flex items-center space-x-1">
                        <button onclick="showEditTransactionModal(${transaction.id})" class="text-blue-600 hover:text-blue-800 p-2 rounded-lg hover:bg-blue-100 transition-colors" title="Edit Transaksi">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="printTransactionReceipt(${transaction.id})" class="text-purple-600 hover:text-purple-800 p-2 rounded-lg hover:bg-purple-100 transition-colors" title="Cetak Struk">
                            <i class="fas fa-print"></i>
                        </button>
                        <button onclick="deleteTransaction(${transaction.id})" class="text-red-600 hover:text-red-800 p-2 rounded-lg hover:bg-red-100 transition-colors" title="Hapus Transaksi">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
        } else {
          actionButtons = `
                    <div class="flex items-center space-x-2">
                        <button onclick="payTransaction(${transaction.id})" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center text-sm font-medium" title="Bayar Sekarang">
                            <i class="fas fa-credit-card mr-2"></i>Bayar
                        </button>
                        <div class="flex items-center space-x-1">
                            <button onclick="showEditTransactionModal(${transaction.id})" class="text-blue-600 hover:text-blue-800 p-2 rounded-lg hover:bg-blue-100 transition-colors" title="Edit Transaksi">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteTransaction(${transaction.id})" class="text-red-600 hover:text-red-800 p-2 rounded-lg hover:bg-red-100 transition-colors" title="Hapus Transaksi">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
        }

        div.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex-1 min-w-0">
                        <!-- Nomor Urut dan Jenis Kendaraan (Atas) -->
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-3">
                                <span class="inline-flex items-center justify-center w-8 h-8 bg-blue-100 text-blue-800 text-sm font-bold rounded-full">
                                    ${rowNumber}
                                </span>
                                <h3 class="text-lg font-bold text-gray-900">${serviceName}</h3>
                            </div>
                            ${statusBadge}
                        </div>
                        
                        <!-- Nomor Polisi (Tengah) -->
                        <div class="mb-2">
                            <p class="text-base font-medium text-gray-700">
                                <i class="fas fa-car mr-2 text-gray-500"></i>
                                ${plateNumber}
                            </p>
                        </div>
                        
                        <!-- Info Bawah -->
                        <div class="flex items-center space-x-4 text-sm text-gray-600 mb-2">
                            <span><i class="fas fa-calendar mr-1"></i>${date}</span>
                            <span><i class="fas fa-clock mr-1"></i>${time}</span>
                        </div>
                        
                        <!-- Catatan -->
                        ${notesDisplay}
                        
                        <!-- Karyawan -->
                        ${employeeNamesDisplay}
                    </div>
                    
                    <!-- Harga dan Aksi -->
                    <div class="text-right ml-4 flex-shrink-0">
                        <p class="font-bold text-2xl ${
                          isPaid ? "text-green-600" : "text-orange-600"
                        } mb-3">
                            ${formatCurrency(transaction.price)}
                        </p>
                        ${actionButtons}
                    </div>
                </div>
            `;

        return div;
      }

      /* ===========================================================
   ✅ FUNGSI: printTransactionReceipt (Cetak Ulang dengan RAW/ESC/POS)
   =========================================================== */
async function printTransactionReceipt(transactionId) {
    showAlert("Mempersiapkan struk untuk dicetak...", "info", "print-receipt-alert");
    try {
        // 1. Ambil data transaksi berdasarkan ID
        const { data: transaction, error } = await supabase
            .from("transactions")
            .select("*, services(name)")
            .eq("id", transactionId)
            .single();

        if (error || !transaction) {
            throw new Error(error?.message || "Data transaksi tidak ditemukan.");
        }
        
        // 2. Update Preview (agar preview menampilkan data yang dicetak)
        // Fungsi ini menggunakan objek 'transaction'
        if (typeof updateReceiptPreviewFromData === 'function') {
            updateReceiptPreviewFromData(transaction); 
        } else {
            console.warn("Fungsi updateReceiptPreviewFromData tidak ditemukan. Melanjutkan cetak tanpa preview.");
        }
        
        // 3. Panggil fungsi cetak thermal RAW/ESC/POS
        // Menggunakan objek 'transaction' yang sudah diambil
        await autoPrintThermalQZ(transaction); 
        
        showAlert("Struk berhasil dicetak (Thermal QZ Tray)", "success", "print-receipt-alert");

    } catch (error) {
        console.error("❌ Gagal mencetak struk:", error);
        showAlert("Gagal mencetak struk: Pastikan QZ Tray berjalan dan printer sudah terkonfigurasi.", "error", "print-receipt-alert");
    }
}

      // function formatCurrency(amount) {
      //   return new Intl.NumberFormat("id-ID", {
      //     style: "currency",
      //     currency: "IDR",
      //     minimumFractionDigits: 0,
      //   }).format(amount);
      // }
      
//       function formatCurrency(amount) {
//   return "Rp " + amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
// }

function formatCurrency(amount) {
  amount = Math.round(amount); // bulatkan ke integer terdekat
  return "Rp " + amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}


      function showAlert(message, type = "info", id = null) {
        const container = document.getElementById("alert-container");
        if (!container) return console.error("Alert container not found!");

        // Jika ID diberikan, hapus alert dengan ID yang sama
        if (id) {
          const existingAlert = document.getElementById(id);
          if (existingAlert) existingAlert.remove();
        }

        const alert = document.createElement("div");

        if (id) alert.id = id;

        alert.className = `alert p-4 rounded-lg shadow-lg max-w-sm w-full ${
          type === "success"
            ? "bg-green-500 text-white"
            : type === "error"
            ? "bg-red-500 text-white"
            : type === "warning"
            ? "bg-yellow-500 text-white"
            : "bg-blue-500 text-white"
        }`;

        alert.innerHTML = `
    <div class="flex items-center">
      <i class="fas fa-${
        type === "success"
          ? "check-circle"
          : type === "error"
          ? "exclamation-circle"
          : type === "warning"
          ? "exclamation-triangle"
          : "info-circle"
      } mr-3"></i>
      <span>${message}</span>
    </div>
  `;

        container.appendChild(alert);

        setTimeout(() => {
          alert.remove();
        }, 5000);
      }

      // Close sidebar when clicking overlay
      document.addEventListener("click", function (e) {
        if (e.target.id === "sidebarOverlay") {
          toggleSidebar();
        }
      });

      // Handle window resize for responsive sidebar
      window.addEventListener("resize", function () {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("sidebarOverlay");

        if (window.innerWidth >= 1024) {
          // Desktop: show sidebar, hide overlay
          sidebar.classList.remove("-translate-x-full");
          sidebar.classList.add("translate-x-0");
          overlay.classList.add("hidden");
        } else {
          // Mobile/Tablet: hide sidebar by default
          if (!overlay.classList.contains("hidden")) {
            // If overlay is visible, keep sidebar open
            sidebar.classList.remove("-translate-x-full");
            sidebar.classList.add("translate-x-0");
          } else {
            // Hide sidebar
            sidebar.classList.add("-translate-x-full");
            sidebar.classList.remove("translate-x-0");
          }
        }
      });
    </script>

    <!-- Toggle Akses Pengaturan Menu -->
    <script>
      function toggleAllAccess() {
        const allCheckbox = document.getElementById("accessAll");
        const all = document.querySelectorAll('input[name="menuAccess"]');
        all.forEach((cb) => (cb.checked = allCheckbox.checked));

        // Sinkronkan toggle kelompok laporan
        const groupAll = document.getElementById("accessReportsAll");
        if (groupAll) groupAll.checked = allCheckbox.checked;
      }

      // Toggle per-kelompok, contoh: group 'reports'
      function toggleGroupAccess(groupName) {
        const groupToggle = document.getElementById(
          `access${capitalize(groupName)}All`
        );
        const groupBoxes = document.querySelectorAll(
          `input[name="menuAccess"][data-group="${groupName}"]`
        );
        groupBoxes.forEach((cb) => (cb.checked = groupToggle.checked));

        // Jika semua tercentang di seluruh menu, centang “Semua Menu”
        syncAllToggle();
      }

      // Jika user centang/uncentang salah satu checkbox, kita tetap sinkronkan status “Semua Menu” dan “Pilih semua laporan”
      document.addEventListener("change", (e) => {
        const target = e.target;
        if (target && target.name === "menuAccess") {
          // Sinkron toggle kelompok laporan
          syncGroupToggle("reports");
          // Sinkron toggle "Semua Menu"
          syncAllToggle();
        }
      });

      function syncGroupToggle(groupName) {
        const groupToggle = document.getElementById(
          `access${capitalize(groupName)}All`
        );
        if (!groupToggle) return;
        const groupBoxes = document.querySelectorAll(
          `input[name="menuAccess"][data-group="${groupName}"]`
        );
        if (groupBoxes.length === 0) return;
        const allChecked = Array.from(groupBoxes).every((cb) => cb.checked);
        const noneChecked = Array.from(groupBoxes).every((cb) => !cb.checked);
        // Kalau semua tercentang, aktif; kalau tidak semua, nonaktif (biar jelas)
        groupToggle.checked =
          allChecked && !noneChecked ? true : allChecked ? true : false;
      }

      function syncAllToggle() {
        const allToggle = document.getElementById("accessAll");
        const all = document.querySelectorAll('input[name="menuAccess"]');
        const allChecked = Array.from(all).every((cb) => cb.checked);
        allToggle.checked = allChecked;
      }

      function capitalize(s) {
        return s ? s.charAt(0).toUpperCase() + s.slice(1) : s;
      }
    </script>
    <script>
      (function () {
        function c() {
          var b = a.contentDocument || a.contentWindow.document;
          if (b) {
            var d = b.createElement("script");
            d.innerHTML =
              "window.__CF$cv$params={r:'980ec7c296559cdb',t:'MTc1ODE3Njg3Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='';document.getElementsByTagName('head')[0].appendChild(a);";
            b.getElementsByTagName("head")[0].appendChild(d);
          }
        }
        if (document.body) {
          var a = document.createElement("iframe");
          a.height = 1;
          a.width = 1;
          a.style.position = "absolute";
          a.style.top = 0;
          a.style.left = 0;
          a.style.border = "none";
          a.style.visibility = "hidden";
          document.body.appendChild(a);
          if ("loading" !== document.readyState) c();
          else if (window.addEventListener)
            document.addEventListener("DOMContentLoaded", c);
          else {
            var e = document.onreadystatechange || function () {};
            document.onreadystatechange = function (b) {
              e(b);
              "loading" !== document.readyState &&
                ((document.onreadystatechange = e), c());
            };
          }
        }
      })();
    </script>

    <script>
      // ===== PERBAIKAN 2: saveStoreSettings =====
      async function saveStoreSettings(e) {
        if (e) e.preventDefault();

        let currentLogo =
          document.getElementById("logoUrlCurrent")?.value || null;
        console.log("[saveStoreSettings] Initial currentLogo:", currentLogo);

        // Cek apakah logo akan dihapus
        if (typeof _logoWillBeDeleted !== "undefined" && _logoWillBeDeleted) {
          currentLogo = null; // Set ke null untuk hapus logo
          console.log(
            "[saveStoreSettings] Logo will be deleted, setting to null"
          );
        }

        const settings = {
          name: document.getElementById("storeName").value,
          address: document.getElementById("storeAddress").value,
          phone: document.getElementById("storePhone").value,
          email: document.getElementById("storeEmail").value.trim() || null,
          footer_message: document.getElementById("receiptFooterMessage").value,
          margin_top: parseInt(document.getElementById("marginTop").value),
          margin_left: parseInt(document.getElementById("marginLeft").value),
          margin_right: parseInt(document.getElementById("marginRight").value),
          margin_bottom: parseInt(
            document.getElementById("marginBottom").value
          ),
          font: document.getElementById("receiptFont").value,
          logo_url: currentLogo,
        };

        try {
          // Upload logo baru jika ada pending file
          const uploadedLogoUrl = await uploadLogoIfNeeded();
          if (uploadedLogoUrl) {
            settings.logo_url = uploadedLogoUrl;
            console.log(
              "[saveStoreSettings] New logo uploaded:",
              uploadedLogoUrl
            );
          }

          // Jika logo dihapus, pastikan null
          if (_logoWillBeDeleted) {
            settings.logo_url = null;
            console.log(
              "[saveStoreSettings] Logo deletion confirmed, setting to null"
            );
          }

          const { data, error } = await supabase
            .from("store_settings")
            .upsert([{ id: 1, ...settings }], { onConflict: "id" })
            .select()
            .single();

          if (error) throw error;

          const finalLogo = data?.logo_url || null;
          console.log(
            "[saveStoreSettings] Final logo from database:",
            finalLogo
          );

          // Reset flags
          _logoWillBeDeleted = false;
          _pendingLogoFile = null;

          // Update semua UI dengan hasil final
          document.getElementById("logoUrlCurrent").value = finalLogo || "";
          setSrc("storeLogoPreview", finalLogo || "");
          // applyLogoUI(finalLogo);
          applyLoginLogoUI(finalLogo);
          applyReceiptLogoUI(finalLogo);

          showAlert("Pengaturan toko berhasil diupdate", "success");

          // JANGAN panggil loadStoreSettings() lagi - sudah update manual di atas
        } catch (error) {
          console.error("Error saving store settings:", error);
          showAlert("Gagal update pengaturan toko", "error");
        }
      }

      function initializeStoreDetails() {
        // Initializing values from settings to receipt preview, title, and header
        const storeName = document.getElementById("storeName").value;
        const storePhone = document.getElementById("storePhone").value;
        const storeAddress = document.getElementById("storeAddress").value;

        // Update the receipt preview
        document.getElementById("receiptStoreName").innerText = storeName;
        document.getElementById(
          "receiptStorePhone"
        ).innerText = `Telp: ${storePhone}`;
        document.getElementById("receiptStoreAddress").innerText = storeAddress;

        // Update the title of the page
        document.title = `${storeName} - Wash Management System`;

        // Update the header text with the store name
        document.getElementById("storeNameHeader").innerText = storeName;
      }

      function updateStoreDetails() {
        // Get the updated store details
        const storeName = document.getElementById("storeName").value;
        const storePhone = document.getElementById("storePhone").value;
        const storeAddress = document.getElementById("storeAddress").value;

        // Update the receipt preview
        document.getElementById("receiptStoreName").innerText = storeName;
        document.getElementById(
          "receiptStorePhone"
        ).innerText = `Telp: ${storePhone}`;
        document.getElementById("receiptStoreAddress").innerText = storeAddress;

        // Update the title of the page
        document.title = `${storeName} - Wash Management System`;

        // Update the header text with the store name
        document.getElementById("storeNameHeader").innerText = storeName;
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Initialize store details in the receipt preview, title, and header

        // Add event listeners to store name, phone, and address fields
        document
          .getElementById("storeName")
          .addEventListener("input", updateStoreDetails);
        document
          .getElementById("storePhone")
          .addEventListener("input", updateStoreDetails);
        document
          .getElementById("storeAddress")
          .addEventListener("input", updateStoreDetails);
      });

      // Pastikan loadStoreSettings dipanggil saat halaman dimuat
      document.addEventListener("DOMContentLoaded", function () {
        // console.log('[DOMContentLoaded] Checking current page...');

        // Cek apakah ada login screen
        const loginScreen = document.getElementById("loginScreen");
        if (loginScreen) {
          // console.log('[DOMContentLoaded] Login screen found, loading store settings...');
          loadStoreSettings();
        }

        // Cek apakah ada form settings (halaman admin)
        const settingsForm =
          document.getElementById("storeSettings") ||
          document.querySelector("form");
        if (settingsForm) {
          // console.log('[DOMContentLoaded] Settings form found, loading store settings...');
          loadStoreSettings();
        }
      });

      // Alternatif: Load saat window selesai dimuat
      window.addEventListener("load", function () {
        // console.log('[window.load] Window fully loaded');

        // Double check untuk login logo
        const loginScreen = document.getElementById("loginScreen");
        if (loginScreen && !loginScreen.classList.contains("hidden")) {
          // console.log('[window.load] Login screen active, ensuring logo is loaded...');

          // Retry load store settings
          setTimeout(() => {
            loadStoreSettings();
          }, 500);
        }
      });
    </script>
    <script>
      (function () {
        // Global variables untuk logo handling
        let _pendingLogoFile = null;
        let _logoWillBeDeleted = false;
        let _isUploadingLogo = false; // Prevent double upload

        const MAX_LOGO_BYTES = 300 * 1024;
        const LOGO_BUCKET = "store_assets";

        // Helper function untuk set image src
        function setSrc(id, url) {
          const el = document.getElementById(id);
          if (el) {
            if (url) {
              el.src = url;
              el.style.display = "block";
            } else {
              el.src = "";
              el.style.display = "none";
            }
          }
        }

        // Apply logo ke semua UI elements
        function applyAllLogoUI(logoUrl) {
          // Main header logo
          const headerImg = document.getElementById("storeLogoHeader");
          const headerIcon = document.getElementById("storeLogoIcon");
          if (headerImg && headerIcon) {
            if (logoUrl) {
              headerImg.src = logoUrl;
              headerImg.classList.remove("hidden");
              headerIcon.classList.add("hidden");
            } else {
              headerImg.classList.add("hidden");
              headerIcon.classList.remove("hidden");
            }
            updateFaviconWithLogo(logoUrl);
          }

          // Login screen logo
          const loginImg = document.getElementById("loginLogoHeader");
          const loginIcon = document.getElementById("loginLogoIcon");
          if (loginImg && loginIcon) {
            if (logoUrl) {
              loginImg.src = logoUrl;
              loginImg.classList.remove("hidden");
              loginIcon.classList.add("hidden");
            } else {
              loginImg.classList.add("hidden");
              loginIcon.classList.remove("hidden");
            }
          }

          // Receipt preview logo
          const receiptImg = document.getElementById("receiptLogoPreview");
          if (receiptImg) {
            if (logoUrl) {
              receiptImg.src = logoUrl;
              receiptImg.classList.remove("hidden");
            } else {
              receiptImg.classList.add("hidden");
            }
          }

          // Update hidden input
          const hiddenInput = document.getElementById("logoUrlCurrent");
          if (hiddenInput) {
            hiddenInput.value = logoUrl || "";
          }

          // Toggle reset button
          toggleResetButton(!!logoUrl);
        }

        // Toggle reset button visibility
        function toggleResetButton(show) {
          const resetBtn = document.getElementById("logoResetBtn");
          if (resetBtn) {
            if (show) {
              resetBtn.classList.remove("hidden");
            } else {
              resetBtn.classList.add("hidden");
            }
          }
        }

        // Handle file selection
        window.handleLogoFileChange = function (e) {
          const file = e.target.files?.[0];

          // Reset previous state
          _pendingLogoFile = null;
          _logoWillBeDeleted = false;

          if (!file) {
            toggleResetButton(false);
            return;
          }

          // Validate file
          if (file.type !== "image/png") {
            alert("Hanya menerima file PNG.");
            e.target.value = "";
            toggleResetButton(false);
            return;
          }

          if (file.size > MAX_LOGO_BYTES) {
            alert(
              `Ukuran file terlalu besar. Maksimal ${Math.round(
                MAX_LOGO_BYTES / 1024
              )} KB.`
            );
            e.target.value = "";
            toggleResetButton(false);
            return;
          }

          // Preview the file
          const reader = new FileReader();
          reader.onload = () => {
            setSrc("storeLogoPreview", reader.result);
            toggleResetButton(true);
          };
          reader.readAsDataURL(file);

          // Store file for upload
          _pendingLogoFile = file;
        };

        // Reset logo (mark for deletion)
        window.resetLogo = function () {
          if (!confirm("Apakah Anda yakin ingin menghapus logo?")) {
            return;
          }

          // Mark for deletion
          _pendingLogoFile = null;
          _logoWillBeDeleted = true;

          // Clear preview
          setSrc("storeLogoPreview", "");

          // Clear file input
          const fileInput = document.getElementById("storeLogoFile");
          if (fileInput) fileInput.value = "";

          // Hide reset button
          toggleResetButton(false);
        };

        // Upload logo to Supabase Storage
        window.uploadLogoIfNeeded = async function () {
          // Prevent double upload
          if (_isUploadingLogo) {
            return null;
          }

          // Check if there's a file to upload
          if (!_pendingLogoFile) {
            return null;
          }

          _isUploadingLogo = true;

          try {
            // Generate unique file path
            const timestamp = Date.now();
            const safeName = _pendingLogoFile.name.replace(
              /[^a-zA-Z0-9_.-]/g,
              ""
            );
            const filePath = `logos/${timestamp}_${safeName}`;

            // Upload to Supabase
            const { error } = await supabase.storage
              .from(LOGO_BUCKET)
              .upload(filePath, _pendingLogoFile, {
                upsert: false, // Don't overwrite existing files
                contentType: "image/png",
                cacheControl: "3600",
              });

            if (error) {
              alert(`Upload logo gagal: ${error.message}`);
              return null;
            }

            // Get public URL
            const { data } = supabase.storage
              .from(LOGO_BUCKET)
              .getPublicUrl(filePath);

            const publicUrl = data?.publicUrl || null;

            // Clear pending file after successful upload
            _pendingLogoFile = null;

            return publicUrl;
          } catch (error) {
            console.error("Upload error:", error);
            alert("Gagal upload logo");
            return null;
          } finally {
            _isUploadingLogo = false;
          }
        };

        // Enhanced saveStoreSettings function
        window.saveStoreSettings = async function (e) {
          if (e) e.preventDefault();

          // Get current logo URL
          let currentLogo =
            document.getElementById("logoUrlCurrent")?.value || null;

          // Check if logo should be deleted
          if (_logoWillBeDeleted) {
            currentLogo = null;
          }

          // Prepare settings object
          const settings = {
            name: document.getElementById("storeName").value,
            address: document.getElementById("storeAddress").value,
            phone: document.getElementById("storePhone").value,
            email: document.getElementById("storeEmail").value,
            footer_message: document.getElementById("receiptFooterMessage")
              .value,
            margin_top: parseInt(document.getElementById("marginTop").value),
            margin_left: parseInt(document.getElementById("marginLeft").value),
            margin_right: parseInt(
              document.getElementById("marginRight").value
            ),
            margin_bottom: parseInt(
              document.getElementById("marginBottom").value
            ),
            font: document.getElementById("receiptFont").value,
            logo_url: currentLogo,
          };

          try {
            // Upload new logo if needed (only once!)
            if (_pendingLogoFile && !_isUploadingLogo) {
              const uploadedUrl = await uploadLogoIfNeeded();
              if (uploadedUrl) {
                settings.logo_url = uploadedUrl;
              }
            }

            // Save to database
            const { data, error } = await supabase
              .from("store_settings")
              .upsert([{ id: 1, ...settings }], { onConflict: "id" })
              .select()
              .single();

            if (error) throw error;

            // Update UI with saved data
            const finalLogo = data?.logo_url || null;

            // Reset flags after successful save
            _logoWillBeDeleted = false;
            _pendingLogoFile = null;

            // Update all UI elements
            document.getElementById("logoUrlCurrent").value = finalLogo || "";
            setSrc("storeLogoPreview", finalLogo);
            applyAllLogoUI(finalLogo);

            // Update store name in headers
            const storeName = data.name || "Wash Management System";
            const storeNameElements =
              document.querySelectorAll("#storeNameHeader");
            storeNameElements.forEach((el) => {
              if (el) el.textContent = storeName;
            });

            // Update receipt preview
            document.getElementById("receiptStoreName").textContent = storeName;
            document.getElementById("receiptStoreAddress").textContent =
              data.address || "";
            document.getElementById("receiptStorePhone").textContent = `Telp: ${
              data.phone || ""
            }`;
            document.getElementById("receiptFooter").textContent =
              data.footer_message || "";

            // Update document title
            document.title = `${storeName} - Wash Management System`;

            showAlert("Pengaturan toko berhasil diupdate", "success");
          } catch (error) {
            console.error("Error saving store settings:", error);
            showAlert("Gagal update pengaturan toko", "error");
          }
        };

        // Load store settings from database
        window.loadStoreSettings = async function () {
          try {
            const { data, error } = await supabase
              .from("store_settings")
              .select("*")
              .single();

            if (error) throw error;

            // Update form fields if they exist
            const formFields = [
              { id: "storeName", value: data.name },
              { id: "storeAddress", value: data.address },
              { id: "storePhone", value: data.phone },
              { id: "storeEmail", value: data.email },
              { id: "receiptFooterMessage", value: data.footer_message },
              { id: "marginTop", value: data.margin_top || 5 },
              { id: "marginLeft", value: data.margin_left || 5 },
              { id: "marginRight", value: data.margin_right || 5 },
              { id: "marginBottom", value: data.margin_bottom || 5 },
              { id: "receiptFont", value: data.font || "Courier New" },
            ];

            formFields.forEach((field) => {
              const element = document.getElementById(field.id);
              if (element) {
                element.value = field.value || "";
              }
            });

            // Update display elements
            const storeName = data.name || "Wash Management System";
            const storeNameElements =
              document.querySelectorAll("#storeNameHeader");
            storeNameElements.forEach((el) => {
              if (el) el.textContent = storeName;
            });

            // Update receipt preview
            const receiptElements = {
              receiptStoreName: data.name,
              receiptStoreAddress: data.address,
              receiptStorePhone: `Telp: ${data.phone || ""}`,
              receiptFooter: data.footer_message,
            };

            Object.entries(receiptElements).forEach(([id, value]) => {
              const el = document.getElementById(id);
              if (el) el.textContent = value || "";
            });

            // Update document title
            document.title = `${storeName} - Wash Management System`;

            // Handle logo
            const logoUrl = data.logo_url || "";

            // Reset flags
            _logoWillBeDeleted = false;
            _pendingLogoFile = null;
            _isUploadingLogo = false;

            // Update logo hidden input
            const logoUrlInput = document.getElementById("logoUrlCurrent");
            if (logoUrlInput) {
              logoUrlInput.value = logoUrl;
            }

            // Update all logo displays
            setSrc("storeLogoPreview", logoUrl);
            applyAllLogoUI(logoUrl);
          } catch (error) {
            console.error("Error loading store settings:", error);
          }
        };

        // Initialize on DOM ready
        document.addEventListener("DOMContentLoaded", function () {
          // Setup reset button event listener (only once!)
          const resetBtn = document.getElementById("logoResetBtn");
          if (resetBtn && !resetBtn.hasAttribute("data-initialized")) {
            resetBtn.addEventListener("click", window.resetLogo);
            resetBtn.setAttribute("data-initialized", "true");
          }
        });
      })();

      async function deleteOldLogo(oldUrl) {
        if (!oldUrl) return;

        try {
          // Extract file path from URL
          const urlParts = oldUrl.split("/");
          const filePath = urlParts.slice(-2).join("/"); // logos/filename.png

          await supabase.storage.from(LOGO_BUCKET).remove([filePath]);
        } catch (error) {
          console.error("Failed to delete old logo:", error);
        }
      }
    </script>
    <script>
      // JavaScript functions untuk user menu
      function toggleUserMenu() {
        const dropdown = document.getElementById("userDropdown");
        const arrow = document.getElementById("dropdownArrow");

        if (dropdown.classList.contains("hidden")) {
          dropdown.classList.remove("hidden");
          setTimeout(() => dropdown.classList.add("show"), 10);
          arrow.classList.add("rotate-180");
        } else {
          closeUserMenu();
        }
      }

      function closeUserMenu() {
        const dropdown = document.getElementById("userDropdown");
        const arrow = document.getElementById("dropdownArrow");

        dropdown.classList.add("hidden");
        dropdown.classList.remove("show");
        arrow.classList.remove("rotate-180");
      }

      // Close user menu when clicking outside
      document.addEventListener("click", function (event) {
        const userMenuToggle = document.getElementById("userMenuToggle");
        const userDropdown = document.getElementById("userDropdown");

        // Check if click is outside user menu
        if (
          !userMenuToggle.contains(event.target) &&
          !userDropdown.contains(event.target)
        ) {
          closeUserMenu();
        }
      });

      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          closeUserMenu();
        }
      });

      function logout() {
        showLogoutModal();
      }

      function showLogoutModal() {
        document.getElementById("logoutModal").classList.remove("hidden");
        document.getElementById("logoutModal").classList.add("flex");
      }

      function closeLogoutModal() {
        document.getElementById("logoutModal").classList.add("hidden");
        document.getElementById("logoutModal").classList.remove("flex");
      }

      // Hapus timer saat logout
      function confirmLogout() {
        currentUser = null;
        localStorage.removeItem("currentUser");

        document.getElementById("mainApp").classList.add("hidden");
        document.getElementById("loginScreen").classList.remove("hidden");

        document.getElementById("loginForm").reset();

        closeLogoutModal();
        showAlert("Anda telah berhasil keluar", "success");
        updateSidebarAccess();

        if (sessionTimeoutTimer) clearTimeout(sessionTimeoutTimer);
      }
    </script>
    <script>
      // Reset timer setiap ada aktivitas
      function resetSessionTimeout() {
        if (sessionTimeoutTimer) clearTimeout(sessionTimeoutTimer);

        sessionTimeoutTimer = setTimeout(() => {
          showAlert(
            "Sesi berakhir karena tidak ada aktivitas.",
            "warning",
            "session-timeout-alert"
          );
          confirmLogout();
        }, SESSION_TIMEOUT_MS);
      }

      // Event yang dianggap aktivitas
      ["click", "keydown", "mousemove", "touchstart"].forEach((evt) => {
        document.addEventListener(evt, resetSessionTimeout, true);
      });

      alert.className += " transition-all duration-300 ease-in-out transform";
    </script>
    <script>
      async function showPresentEmployeesModal() {
        try {
          // Ambil data karyawan hadir hari ini
          const now = new Date();
          const jakartaOffset = 8 * 60;
          const localOffset = now.getTimezoneOffset();
          const jakartaTime = new Date(
            now.getTime() + (jakartaOffset - localOffset) * 60000
          );
          const today = jakartaTime.toISOString().split("T")[0];

          const { data: presentEmployees } = await supabase
            .from("employees")
            .select("name")
            .eq("is_present", true)
            .eq("is_active", true);

          const list = document.getElementById("presentEmployeesListModal");
          list.innerHTML = "";

          if (presentEmployees && presentEmployees.length > 0) {
            presentEmployees.forEach((emp) => {
              const li = document.createElement("li");
              li.textContent = emp.name;
              list.appendChild(li);
            });
          } else {
            list.innerHTML =
              "<li class='text-gray-500'>Tidak ada karyawan hadir hari ini.</li>";
          }

          document
            .getElementById("presentEmployeesModal")
            .classList.remove("hidden");
          document
            .getElementById("presentEmployeesModal")
            .classList.add("flex");
        } catch (error) {
          showAlert("Gagal memuat karyawan hadir", "error");
        }
      }

      function closePresentEmployeesModal() {
        document
          .getElementById("presentEmployeesModal")
          .classList.add("hidden");
        document
          .getElementById("presentEmployeesModal")
          .classList.remove("flex");
      }
    </script>
    <script>
      function checkSessionValidity() {
        const savedUser = localStorage.getItem("currentUser");
        const savedDate = localStorage.getItem("sessionDate");
        const now = new Date();
        const jakartaOffset = 8 * 60;
        const localOffset = now.getTimezoneOffset();
        const jakartaTime = new Date(
          now.getTime() + (jakartaOffset - localOffset) * 60000
        );
        const today = jakartaTime.toISOString().split("T")[0];

        if (!savedUser || !savedDate || savedDate !== today) {
          localStorage.removeItem("currentUser");
          localStorage.removeItem("sessionDate");
          confirmLogout();
          return false;
        }
        return true;
      }
    </script>
    <script>
 function updateUserHeaderUI() {
  const userInitial = currentUser.username
    ? currentUser.username.charAt(0).toUpperCase()
    : "U";
  document.getElementById("userInitial").textContent = userInitial;

  document.getElementById("currentUser").textContent = currentUser.username;
  document.getElementById("mobileCurrentUser").textContent = currentUser.username;

  // Jabatan di header
  const jabatan = currentUser.role === "admin" ? "Admin" : "Karyawan";
  document.querySelectorAll("#currentUser, #mobileCurrentUser").forEach((el) => {
    if (el && el.nextElementSibling) {
      el.nextElementSibling.textContent = jabatan;
    }
  });
}

function updateUserMenuAccess() {
  const pengaturanBtn = document.querySelector(
    '#userDropdown button[onclick*="navigateToSection(\'settings\')"]'
  );
  if (pengaturanBtn) {
    pengaturanBtn.style.display = currentUser.access_menu.includes("settings")
      ? "flex"
      : "none";
  }
}

function updateEmployeeAddButton() {
  const addBtn = document.querySelector(
    '#employeesSection button[onclick="showEmployeeModal()"]'
  );
  if (addBtn) {
    addBtn.style.display = currentUser.role === "admin" ? "inline-flex" : "none";
  }
}
// Panggil di showMainApp dan setelah login sukses
    </script>
    <script>
// Update fungsi loadGrossProfitReport dengan perhitungan statistik
async function loadGrossProfitReport(from = "", to = "") {
  try {
    // jika tidak ada from/to, set default hari ini
    if (!from) from = new Date().toISOString().split("T")[0];
    if (!to) to = from;

    // gunakan timezone Asia/Jakarta dengan suffix +08:00
    const startIso = `${from}T00:00:00+08:00`;
    const endIso = `${to}T23:59:59+08:00`;

    let query = supabase
      .from("transactions")
      .select("*, services(name), employee_names")
      .eq("status", "paid")
      .gte("created_at", startIso)
      .lte("created_at", endIso);

    const { data, error } = await query.order("created_at", { ascending: true });

    const tbody = document.getElementById("grossProfitTableBody");
    tbody.innerHTML = "";

    if (error || !data || data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6" class="text-center py-6 text-gray-500">Tidak ada data</td></tr>`;
      resetGrossProfitStats();
      return;
    }

    // Variabel untuk statistik
    let totalRevenue = 0;
    let motor20k = 0;
    let motor25k = 0;
    let motor30k = 0;
    let soapCount = 0;

    data.forEach((trx, idx) => {
      const date = new Date(trx.created_at).toLocaleDateString("id-ID");
      const motor = trx.services?.name || "-";
      const notes = trx.notes || "-";
      const price = trx.price;
      const karyawan = Array.isArray(trx.employee_names) ? trx.employee_names.join(", ") : "-";

      totalRevenue += price;
      if (price === 20000) motor20k++;
      else if (price === 25000) motor25k++;
      else if (price === 30000) motor30k++;
      if (notes && notes.toLowerCase().includes("sabun")) soapCount++;

      tbody.innerHTML += `
        <tr class="border-b border-gray-100">
          <td class="py-2 px-4">${idx + 1}</td>
          <td class="py-2 px-4">${date}</td>
          <td class="py-2 px-4">${motor}</td>
          <td class="py-2 px-4">${notes}</td>
          <td class="py-2 px-4">${formatCurrency(price)}</td>
          <td class="py-2 px-4">${karyawan}</td>
        </tr>
      `;
    });

    updateGrossProfitStats(totalRevenue, motor20k, motor25k, motor30k, soapCount);

  } catch (error) {
    document.getElementById("grossProfitTableBody").innerHTML =
      `<tr><td colspan="6" class="text-center py-6 text-red-500">Gagal memuat data</td></tr>`;
    resetGrossProfitStats();
  }
}

// Fungsi untuk update statistik
function updateGrossProfitStats(totalRevenue, motor20k, motor25k, motor30k, soapCount) {
  document.getElementById("totalRevenue").textContent = formatCurrency(totalRevenue);
  document.getElementById("motor20k").textContent = `${motor20k} unit`;
  document.getElementById("motor25k").textContent = `${motor25k} unit`;
  document.getElementById("motor30k").textContent = `${motor30k} unit`;
  document.getElementById("soapCount").textContent = `${soapCount} kali`;
}

// Fungsi untuk reset statistik
function resetGrossProfitStats() {
  document.getElementById("totalRevenue").textContent = "Rp 0";
  document.getElementById("motor20k").textContent = "0 unit";
  document.getElementById("motor25k").textContent = "0 unit";
  document.getElementById("motor30k").textContent = "0 unit";
  document.getElementById("soapCount").textContent = "0 kali";
}

function searchGrossProfitReport() {
  const from = document.getElementById("grossReportFrom").value;
  const to = document.getElementById("grossReportTo").value;
  loadGrossProfitReport(from, to);
}

function setDefaultGrossReportDate() {
  const today = new Date().toISOString().split("T")[0];
  document.getElementById("grossReportFrom").value = today;
  document.getElementById("grossReportTo").value = today;
}

function clearGrossProfitTable() {
  document.getElementById("grossProfitTableBody").innerHTML =
    `<tr><td colspan="6" class="text-center py-6 text-gray-500">Tidak ada data</td></tr>`;
    resetGrossProfitStats();
}

function showExportGrossProfitModal() {
  // Ambil tanggal dan judul
  const from = document.getElementById("grossReportFrom").value;
  const to = document.getElementById("grossReportTo").value;
  const title = "Laporan Laba Kotor";
  let filename = `${title}_${from}${from !== to ? "_to_" + to : ""}.xls`;
  document.getElementById("exportGrossProfitTitle").textContent = title;
  document.getElementById("exportGrossProfitFilename").textContent = filename;
  document.getElementById("exportGrossProfitModal").classList.remove("hidden");
  document.getElementById("exportGrossProfitModal").classList.add("flex");
}

function closeExportGrossProfitModal() {
  document.getElementById("exportGrossProfitModal").classList.add("hidden");
  document.getElementById("exportGrossProfitModal").classList.remove("flex");
}

// Modifikasi fungsi downloadGrossProfitExcel
function downloadGrossProfitExcel() {
  const table = document.getElementById("grossProfitTable");
  const from = document.getElementById("grossReportFrom").value;
  const to = document.getElementById("grossReportTo").value;
  const storeName = document.getElementById("storeName")?.value || "Wash Management System";
  
  // Ambil data statistik
  const totalRevenue = document.getElementById("totalRevenue")?.textContent || "Rp 0";
  const motor20k = document.getElementById("motor20k")?.textContent || "0 unit";
  const motor25k = document.getElementById("motor25k")?.textContent || "0 unit";
  const motor30k = document.getElementById("motor30k")?.textContent || "0 unit";
  const soapCount = document.getElementById("soapCount")?.textContent || "0 kali";
  
  let html = `
    <html>
      <head>
        <meta charset="UTF-8">
        <style>
          table { border-collapse: collapse; width: 100%; }
          th, td { border: 1px solid black; padding: 8px; text-align: left; }
          th { background-color: #f3f4f6; font-weight: bold; }
          .header { text-align: center; font-weight: bold; font-size: 16px; margin-bottom: 10px; }
          .info { margin-bottom: 5px; }
          .summary { margin-top: 20px; background-color: #f9fafb; padding: 10px; }
          .summary-title { font-weight: bold; font-size: 14px; margin-bottom: 10px; border-bottom: 2px solid #333; }
          .summary-item { margin: 5px 0; }
        </style>
      </head>
      <body>
        <div class="header">LAPORAN LABA KOTOR</div>
        <div class="info"><strong>Toko:</strong> ${storeName}</div>
        <div class="info"><strong>Periode:</strong> ${from}${from !== to ? " s/d " + to : ""}</div>
        <br>
        <table>
          <thead>
            <tr>`;
  
  // Header tabel
  const headers = Array.from(table.querySelectorAll("thead th")).map(th => `<th>${th.textContent}</th>`);
  html += headers.join("");
  html += `</tr>
          </thead>
          <tbody>`;
  
  // Data rows
  const rows = table.querySelectorAll("tbody tr");
  rows.forEach(row => {
    html += "<tr>";
    const cols = Array.from(row.querySelectorAll("td")).map(td => `<td>${td.textContent}</td>`);
    html += cols.join("");
    html += "</tr>";
  });
  
  html += `</tbody>
        </table>
        
        <div class="summary">
          <div class="summary-title">RINGKASAN STATISTIK</div>
          <div class="summary-item"><strong>Total Pendapatan:</strong> ${totalRevenue}</div>
          <div class="summary-item"><strong>Motor Rp 20.000:</strong> ${motor20k}</div>
          <div class="summary-item"><strong>Motor Rp 25.000:</strong> ${motor25k}</div>
          <div class="summary-item"><strong>Motor Rp 30.000:</strong> ${motor30k}</div>
          <div class="summary-item"><strong>Transaksi Pakai Sabun:</strong> ${soapCount}</div>
        </div>
      </body>
    </html>`;

  let filename = `Laporan_Laba_Kotor_${from}${from !== to ? "_to_" + to : ""}.xls`;

  // Buat file blob HTML Excel
  const blob = new Blob([html], { type: "application/vnd.ms-excel" });
  const url = URL.createObjectURL(blob);

  const link = document.createElement("a");
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);

  closeExportGrossProfitModal();
  showAlert("File Excel berhasil didownload", "success");
}

// FUNGSI BARU: Share via WhatsApp
// Update juga fungsi shareViaWhatsApp untuk include statistik
function shareViaWhatsApp() {
  const from = document.getElementById("grossReportFrom").value;
  const to = document.getElementById("grossReportTo").value;
  const storeName = document.getElementById("storeName")?.value || "Wash Management System";
  
  const table = document.getElementById("grossProfitTable");
  const rows = table.querySelectorAll("tbody tr");
  
  // Ambil data statistik
  const totalRevenue = document.getElementById("totalRevenue")?.textContent || "Rp 0";
  const motor20k = document.getElementById("motor20k")?.textContent || "0 unit";
  const motor25k = document.getElementById("motor25k")?.textContent || "0 unit";
  const motor30k = document.getElementById("motor30k")?.textContent || "0 unit";
  const soapCount = document.getElementById("soapCount")?.textContent || "0 kali";
  
  let message = `*LAPORAN LABA KOTOR*\n`;
  message += `Toko: ${storeName}\n`;
  message += `Periode: ${from}${from !== to ? " s/d " + to : ""}\n`;
  message += `\n${"-".repeat(40)}\n\n`;
  
  if (rows.length === 0 || rows[0].textContent.includes("Tidak ada data")) {
    message += "Tidak ada data untuk periode ini.";
  } else {
    message += `Total Transaksi: ${rows.length}\n\n`;
    
    rows.forEach((row, idx) => {
      const cols = row.querySelectorAll("td");
      if (cols.length >= 6) {
        const tanggal = cols[1].textContent.trim();
        const motor = cols[2].textContent.trim();
        const catatan = cols[3].textContent.trim();
        const harga = cols[4].textContent.trim();
        const karyawan = cols[5].textContent.trim();
        
        message += `*${idx + 1}. ${tanggal}*\n`;
        message += `Motor: ${motor}\n`;
        if (catatan && catatan !== "-") {
          message += `Catatan: ${catatan}\n`;
        }
        message += `Harga: ${harga}\n`;
        message += `Karyawan: ${karyawan}\n\n`;
      }
    });
    
    message += `${"-".repeat(40)}\n`;
    message += `*RINGKASAN STATISTIK*\n`;
    message += `${"-".repeat(40)}\n`;
    message += `Total Pendapatan: ${totalRevenue}\n`;
    message += `Motor Rp 20.000: ${motor20k}\n`;
    message += `Motor Rp 25.000: ${motor25k}\n`;
    message += `Motor Rp 30.000: ${motor30k}\n`;
    message += `Pakai Sabun: ${soapCount}`;
  }
  
  const encodedMessage = encodeURIComponent(message);
  const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
  
  window.open(whatsappUrl, "_blank");
  closeExportGrossProfitModal();
  showAlert("Membuka WhatsApp...", "success");
}

// FUNGSI BARU: Share via Email
// Update juga fungsi shareViaEmail untuk include statistik
function shareViaEmail() {
  const from = document.getElementById("grossReportFrom").value;
  const to = document.getElementById("grossReportTo").value;
  const storeName = document.getElementById("storeName")?.value || "Wash Management System";
  
  const table = document.getElementById("grossProfitTable");
  const rows = table.querySelectorAll("tbody tr");
  
  // Ambil data statistik
  const totalRevenue = document.getElementById("totalRevenue")?.textContent || "Rp 0";
  const motor20k = document.getElementById("motor20k")?.textContent || "0 unit";
  const motor25k = document.getElementById("motor25k")?.textContent || "0 unit";
  const motor30k = document.getElementById("motor30k")?.textContent || "0 unit";
  const soapCount = document.getElementById("soapCount")?.textContent || "0 kali";
  
  const subject = `Laporan Laba Kotor - ${storeName} (${from}${from !== to ? " - " + to : ""})`;
  
  let bodyText = `LAPORAN LABA KOTOR\n`;
  bodyText += `${"=".repeat(60)}\n\n`;
  bodyText += `Toko: ${storeName}\n`;
  bodyText += `Periode: ${from}${from !== to ? " sampai " + to : ""}\n\n`;
  
  if (rows.length === 0 || rows[0].textContent.includes("Tidak ada data")) {
    bodyText += "Tidak ada data untuk periode ini.\n\n";
  } else {
    bodyText += `Total Transaksi: ${rows.length}\n\n`;
    bodyText += `DETAIL TRANSAKSI:\n`;
    bodyText += `${"-".repeat(60)}\n\n`;
    
    rows.forEach((row, idx) => {
      const cols = row.querySelectorAll("td");
      if (cols.length >= 6) {
        const tanggal = cols[1].textContent.trim();
        const motor = cols[2].textContent.trim();
        const catatan = cols[3].textContent.trim();
        const harga = cols[4].textContent.trim();
        const karyawan = cols[5].textContent.trim();
        
        bodyText += `${idx + 1}. Tanggal: ${tanggal}\n`;
        bodyText += `   Motor: ${motor}\n`;
        if (catatan && catatan !== "-") {
          bodyText += `   Catatan: ${catatan}\n`;
        }
        bodyText += `   Harga: ${harga}\n`;
        bodyText += `   Karyawan: ${karyawan}\n\n`;
      }
    });
    
    bodyText += `${"=".repeat(60)}\n`;
    bodyText += `RINGKASAN STATISTIK\n`;
    bodyText += `${"=".repeat(60)}\n`;
    bodyText += `Total Pendapatan: ${totalRevenue}\n`;
    bodyText += `Motor Rp 20.000: ${motor20k}\n`;
    bodyText += `Motor Rp 25.000: ${motor25k}\n`;
    bodyText += `Motor Rp 30.000: ${motor30k}\n`;
    bodyText += `Transaksi Pakai Sabun: ${soapCount}\n\n`;
  }
  
  bodyText += `\nLaporan dibuat otomatis oleh Wash Management System\n`;
  bodyText += `Untuk file Excel lengkap, silakan download melalui aplikasi.`;
  
  const encodedSubject = encodeURIComponent(subject);
  const encodedBody = encodeURIComponent(bodyText);
  const mailtoLink = `mailto:?subject=${encodedSubject}&body=${encodedBody}`;
  
  window.location.href = mailtoLink;
  closeExportGrossProfitModal();
  showAlert("Membuka aplikasi email...", "info");
}

// Fungsi shareGrossProfitFile asli tetap dipertahankan sebagai fallback
async function shareGrossProfitFile() {
  const table = document.getElementById("grossProfitTable");
  let html = "<table><tr>";
  const headers = Array.from(table.querySelectorAll("thead th")).map(th => `<th>${th.textContent}</th>`);
  html += headers.join("");
  html += "</tr>";
  const rows = table.querySelectorAll("tbody tr");
  rows.forEach(row => {
    html += "<tr>";
    const cols = Array.from(row.querySelectorAll("td")).map(td => `<td>${td.textContent}</td>`);
    html += cols.join("");
    html += "</tr>";
  });
  html += "</table>";

  const from = document.getElementById("grossReportFrom").value;
  const to = document.getElementById("grossReportTo").value;
  let filename = `Laporan_Laba_Kotor_${from}${from !== to ? "_to_" + to : ""}.xls`;
  const blob = new Blob([html], { type: "application/vnd.ms-excel" });
  const file = new File([blob], filename, { type: "application/vnd.ms-excel" });

  if (navigator.canShare && navigator.canShare({ files: [file] })) {
    try {
      await navigator.share({
        title: "Laporan Laba Kotor",
        text: "Berikut laporan laba kotor periode yang dipilih.",
        files: [file],
      });
      showAlert("File berhasil dibagikan!", "success");
    } catch (err) {
      showAlert("Gagal membagikan file: " + err.message, "error");
    }
  } else {
    showAlert("Browser Anda tidak mendukung fitur bagikan file langsung. Silakan download file terlebih dahulu.", "warning");
  }
  closeExportGrossProfitModal();
}

    </script>
    <script>
      // Fungsi untuk load laporan detail transaksi
async function loadDetailTransactionsReport(from = "", to = "") {
  try {
    if (!from) from = new Date().toISOString().split("T")[0];
    if (!to) to = from;

    const startIso = `${from}T00:00:00+08:00`;
    const endIso = `${to}T23:59:59+08:00`;

    // Ambil salary settings terlebih dahulu
    const { data: salarySettings } = await supabase
      .from("salary_settings")
      .select("*")
      .single();

    const salaryPerMotor = salarySettings?.salary_per_motor || 7000;

    // Query transaksi dengan range timezone-aware
    const { data, error } = await supabase
      .from("transactions")
      .select("*, services(name), employee_names, employee_ids")
      .eq("status", "paid")
      .gte("created_at", startIso)
      .lte("created_at", endIso)
      .order("created_at", { ascending: true });

    const tbody = document.getElementById("detail_transaksi_TableBody");
    tbody.innerHTML = "";

    if (error || !data || data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="8" class="text-center py-6 text-gray-500">Tidak ada data</td></tr>`;
      resetDetailTransactionsStats();
      return;
    }

    let totalRevenue = 0;
    let totalSalary = 0;

    for (let idx = 0; idx < data.length; idx++) {
      const trx = data[idx];
      const date = new Date(trx.created_at).toLocaleDateString("id-ID");
      const motor = trx.services?.name || "-";
      const plateNumber = trx.plate_number || "-";
      const notes = trx.notes || "-";
      const price = trx.price;
      const karyawan = Array.isArray(trx.employee_names) ? trx.employee_names.join(", ") : "-";

      const presentCount = Array.isArray(trx.employee_ids) ? trx.employee_ids.length : 0;
      const salaryPerEmployee = presentCount > 0 ? salaryPerMotor / presentCount : 0;

      totalRevenue += price;
      totalSalary += salaryPerMotor;

      tbody.innerHTML += `
        <tr class="border-b border-gray-100 hover:bg-gray-50">
          <td class="py-2 px-4 text-center">${idx + 1}</td>
          <td class="py-2 px-4">${date}</td>
          <td class="py-2 px-4">${motor}</td>
          <td class="py-2 px-4 text-center">${plateNumber}</td>
          <td class="py-2 px-4">${notes}</td>
          <td class="py-2 px-4 text-right">${formatCurrency(price)}</td>
          <td class="py-2 px-4">${karyawan}</td>
          <td class="py-2 px-4 text-right">${formatCurrency(salaryPerEmployee)}</td>
        </tr>
      `;
    }

    updateDetailTransactionsStats(totalRevenue, data.length, totalSalary);

  } catch (error) {
    console.error("Error loading detail transactions:", error);
    document.getElementById("detail_transaksi_TableBody").innerHTML =
      `<tr><td colspan="8" class="text-center py-6 text-red-500">Gagal memuat data</td></tr>`;
    resetDetailTransactionsStats();
  }
}

// Fungsi untuk update statistik
function updateDetailTransactionsStats(totalRevenue, totalTransactions, totalSalary) {
  document.getElementById("dt_totalRevenue").textContent = formatCurrency(totalRevenue);
  document.getElementById("dt_totalTransactions").textContent = `${totalTransactions} transaksi`;
  document.getElementById("dt_totalSalary").textContent = formatCurrency(totalSalary);
}

// Fungsi untuk reset statistik
function resetDetailTransactionsStats() {
  document.getElementById("dt_totalRevenue").textContent = "Rp 0";
  document.getElementById("dt_totalTransactions").textContent = "0 transaksi";
  document.getElementById("dt_totalSalary").textContent = "Rp 0";
}

// Fungsi untuk reset statistik
function resetDetailKaskeluarStats() {
  document.getElementById("kk_totalexpenses").textContent = "Rp 0";
  document.getElementById("kk_totalTransactions").textContent = "0 transaksi";
}

// Fungsi search
function searchDetailTransactions() {
  const from = document.getElementById("rd_transaksiFrom").value;
  const to = document.getElementById("rd_transaksiTo").value;
  loadDetailTransactionsReport(from, to);
}

// Set default date
function setDefaultDetailTransactionsDate() {
  const today = new Date().toISOString().split("T")[0];
  document.getElementById("rd_transaksiFrom").value = today;
  document.getElementById("rd_transaksiTo").value = today;
}

function searchDetailKaskeluar() {
  const from = document.getElementById("KasKeluar_From").value;
  const to = document.getElementById("KasKeluar_To").value;
  const category = document.getElementById("expenseFilterCategory")?.value || "";
  // pastikan default ke hari ini jika kosong (zona Jakarta)
  let f = from, t = to;
  if (!f || !t) {
    const now = new Date();
    const jakartaOffset = 8 * 60;
    const localOffset = now.getTimezoneOffset();
    const jakartaTime = new Date(now.getTime() + (jakartaOffset - localOffset) * 60000);
    const today = jakartaTime.toISOString().split("T")[0];
    if (!f) f = today;
    if (!t) t = today;
  }
  loadCashOutReport(f, t, category);
}


function setDefaultDetailKaskeluarDate() {
  const now = new Date();
  const jakartaOffset = 8 * 60; // menit
  const localOffset = now.getTimezoneOffset();
  const jakartaTime = new Date(now.getTime() + (jakartaOffset - localOffset) * 60000);
  const today = jakartaTime.toISOString().split("T")[0];
  const fromEl = document.getElementById("KasKeluar_From");
  const toEl = document.getElementById("KasKeluar_To");
  if (fromEl && !fromEl.value) fromEl.value = today;
  if (toEl && !toEl.value) toEl.value = today;
}

function showExportDetailKaskeluar() {
  // langsung download tanpa modal untuk kesederhanaan
  downloadDetailKaskeluarExcel();
}

// Clear table
function clearDetailTransactionsTable() {
  const tbody = document.getElementById("detail_transaksi_TableBody");
  if (tbody) {
    tbody.innerHTML = `<tr><td colspan="8" class="text-center py-6 text-gray-500">Silakan pilih tanggal dan klik tombol cari untuk menampilkan data</td></tr>`;
  }
  resetDetailTransactionsStats();
}

// Clear table
function clearDetailKaskeluarTable() {
  const tbody = document.getElementById("detail_kaskeluar_TableBody");
  if (tbody) {
    tbody.innerHTML = `<tr><td colspan="8" class="text-center py-6 text-gray-500">Silakan pilih tanggal dan klik tombol cari untuk menampilkan data</td></tr>`;
  }
  resetDetailKaskeluarStats();
}

// Modal functions
function showExportDetailTransactions() {
  const from = document.getElementById("rd_transaksiFrom").value;
  const to = document.getElementById("rd_transaksiTo").value;
  const title = "Laporan Detail Transaksi";
  let filename = `${title}_${from}${from !== to ? "_to_" + to : ""}.xls`;
  document.getElementById("exportDetailTransactionsTitle").textContent = title;
  document.getElementById("exportDetailTransactionsFilename").textContent = filename;
  document.getElementById("exportDetailTransactionsModal").classList.remove("hidden");
  document.getElementById("exportDetailTransactionsModal").classList.add("flex");
}

function closeExportDetailTransactionsModal() {
  document.getElementById("exportDetailTransactionsModal").classList.add("hidden");
  document.getElementById("exportDetailTransactionsModal").classList.remove("flex");
}

// Download Excel
function downloadDetailTransactionsExcel() {
  const table = document.getElementById("detail_transaksi_tabel");
  const from = document.getElementById("rd_transaksiFrom").value;
  const to = document.getElementById("rd_transaksiTo").value;
  const storeName = document.getElementById("storeName")?.value || "Wash Management System";
  
  const totalRevenue = document.getElementById("dt_totalRevenue")?.textContent || "Rp 0";
  const totalTransactions = document.getElementById("dt_totalTransactions")?.textContent || "0 transaksi";
  const totalSalary = document.getElementById("dt_totalSalary")?.textContent || "Rp 0";
  
  let html = `
    <html>
      <head>
        <meta charset="UTF-8">
        <style>
          table { border-collapse: collapse; width: 100%; }
          th, td { border: 1px solid black; padding: 8px; text-align: left; }
          th { background-color: #f3f4f6; font-weight: bold; }
          .header { text-align: center; font-weight: bold; font-size: 16px; margin-bottom: 10px; }
          .info { margin-bottom: 5px; }
          .summary { margin-top: 20px; background-color: #f9fafb; padding: 10px; }
          .summary-title { font-weight: bold; font-size: 14px; margin-bottom: 10px; border-bottom: 2px solid #333; }
          .summary-item { margin: 5px 0; }
        </style>
      </head>
      <body>
        <div class="header">LAPORAN DETAIL TRANSAKSI</div>
        <div class="info"><strong>Toko:</strong> ${storeName}</div>
        <div class="info"><strong>Periode:</strong> ${from}${from !== to ? " s/d " + to : ""}</div>
        <br>
        <table>
          <thead>
            <tr>`;
  
  const headers = Array.from(table.querySelectorAll("thead th")).map(th => `<th>${th.textContent}</th>`);
  html += headers.join("");
  html += `</tr></thead><tbody>`;
  
  const rows = table.querySelectorAll("tbody tr");
  rows.forEach(row => {
    html += "<tr>";
    const cols = Array.from(row.querySelectorAll("td")).map(td => `<td>${td.textContent}</td>`);
    html += cols.join("");
    html += "</tr>";
  });
  
  html += `</tbody></table>
        <div class="summary">
          <div class="summary-title">RINGKASAN</div>
          <div class="summary-item"><strong>Total Pendapatan:</strong> ${totalRevenue}</div>
          <div class="summary-item"><strong>Total Transaksi:</strong> ${totalTransactions}</div>
          <div class="summary-item"><strong>Total Gaji Karyawan:</strong> ${totalSalary}</div>
        </div>
      </body>
    </html>`;

  let filename = `Laporan_Detail_Transaksi_${from}${from !== to ? "_to_" + to : ""}.xls`;
  const blob = new Blob([html], { type: "application/vnd.ms-excel" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
  closeExportDetailTransactionsModal();
  showAlert("File Excel berhasil didownload", "success");
}

// Share WhatsApp
function shareDetailTransactionsViaWhatsApp() {
  const from = document.getElementById("rd_transaksiFrom").value;
  const to = document.getElementById("rd_transaksiTo").value;
  const storeName = document.getElementById("storeName")?.value || "Wash Management System";
  const table = document.getElementById("detail_transaksi_tabel");
  const rows = table.querySelectorAll("tbody tr");
  
  const totalRevenue = document.getElementById("dt_totalRevenue")?.textContent || "Rp 0";
  const totalTransactions = document.getElementById("dt_totalTransactions")?.textContent || "0 transaksi";
  const totalSalary = document.getElementById("dt_totalSalary")?.textContent || "Rp 0";
  
  let message = `*LAPORAN DETAIL TRANSAKSI*\n`;
  message += `Toko: ${storeName}\n`;
  message += `Periode: ${from}${from !== to ? " s/d " + to : ""}\n\n`;
  
  if (rows.length === 0 || rows[0].textContent.includes("Tidak ada data")) {
    message += "Tidak ada data untuk periode ini.";
  } else {
    rows.forEach((row, idx) => {
      const cols = row.querySelectorAll("td");
      if (cols.length >= 8) {
        message += `*${cols[0].textContent.trim()}. ${cols[1].textContent.trim()}*\n`;
        message += `Motor: ${cols[2].textContent.trim()}\n`;
        message += `Plat: ${cols[3].textContent.trim()}\n`;
        message += `Catatan: ${cols[4].textContent.trim()}\n`;
        message += `Harga: ${cols[5].textContent.trim()}\n`;
        message += `Karyawan: ${cols[6].textContent.trim()}\n`;
        message += `Gaji: ${cols[7].textContent.trim()}\n\n`;
      }
    });
    
    message += `${"-".repeat(40)}\n*RINGKASAN*\n${"-".repeat(40)}\n`;
    message += `Total Pendapatan: ${totalRevenue}\n`;
    message += `Total Transaksi: ${totalTransactions}\n`;
    message += `Total Gaji: ${totalSalary}`;
  }
  
  const encodedMessage = encodeURIComponent(message);
  window.open(`https://wa.me/?text=${encodedMessage}`, "_blank");
  closeExportDetailTransactionsModal();
  showAlert("Membuka WhatsApp...", "success");
}

// Share Email
function shareDetailTransactionsViaEmail() {
  const from = document.getElementById("rd_transaksiFrom").value;
  const to = document.getElementById("rd_transaksiTo").value;
  const storeName = document.getElementById("storeName")?.value || "Wash Management System";
  const table = document.getElementById("detail_transaksi_tabel");
  const rows = table.querySelectorAll("tbody tr");
  
  const totalRevenue = document.getElementById("dt_totalRevenue")?.textContent || "Rp 0";
  const totalTransactions = document.getElementById("dt_totalTransactions")?.textContent || "0 transaksi";
  const totalSalary = document.getElementById("dt_totalSalary")?.textContent || "Rp 0";
  
  const subject = `Laporan Detail Transaksi - ${storeName} (${from}${from !== to ? " - " + to : ""})`;
  let bodyText = `LAPORAN DETAIL TRANSAKSI\n${"=".repeat(60)}\n\nToko: ${storeName}\nPeriode: ${from}${from !== to ? " sampai " + to : ""}\n\n`;
  
  if (rows.length === 0 || rows[0].textContent.includes("Tidak ada data")) {
    bodyText += "Tidak ada data untuk periode ini.\n\n";
  } else {
    rows.forEach((row) => {
      const cols = row.querySelectorAll("td");
      if (cols.length >= 8) {
        bodyText += `${cols[0].textContent.trim()}. Tanggal: ${cols[1].textContent.trim()}\n`;
        bodyText += `   Motor: ${cols[2].textContent.trim()}\n`;
        bodyText += `   Plat: ${cols[3].textContent.trim()}\n`;
        bodyText += `   Catatan: ${cols[4].textContent.trim()}\n`;
        bodyText += `   Harga: ${cols[5].textContent.trim()}\n`;
        bodyText += `   Karyawan: ${cols[6].textContent.trim()}\n`;
        bodyText += `   Gaji: ${cols[7].textContent.trim()}\n\n`;
      }
    });
    
    bodyText += `${"=".repeat(60)}\nRINGKASAN\n${"=".repeat(60)}\n`;
    bodyText += `Total Pendapatan: ${totalRevenue}\n`;
    bodyText += `Total Transaksi: ${totalTransactions}\n`;
    bodyText += `Total Gaji Karyawan: ${totalSalary}\n\n`;
  }
  
  bodyText += `\nLaporan dibuat otomatis oleh Wash Management System`;
  const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(bodyText)}`;
  window.location.href = mailtoLink;
  closeExportDetailTransactionsModal();
  showAlert("Membuka aplikasi email...", "info");
}
      </script>
      <script>
async function loadCashOutReport(from = "", to = "", category = "") {
  try {
    // default ke hari ini (zona Jakarta) bila kosong
    const now = new Date();
    const jakartaOffset = 8 * 60;
    const localOffset = now.getTimezoneOffset();
    const jakartaTime = new Date(now.getTime() + (jakartaOffset - localOffset) * 60000);
    const todayJakarta = jakartaTime.toISOString().split("T")[0];

    if (!from) from = todayJakarta;
    if (!to) to = todayJakarta;

    // Ambil semua expenses (kita akan normalisasi dan filter di client)
    const { data: allExpenses, error } = await supabase
      .from("expenses")
      .select("*")
      .order("id", { ascending: false });

    const tbody = document.getElementById("detail_kaskeluar_TableBody");
    tbody.innerHTML = "";

    if (error) {
      console.error("Error loading cash out report:", error);
      tbody.innerHTML = `<tr><td colspan="6" class="text-center py-6 text-red-500">Gagal memuat data</td></tr>`;
      resetDetailKaskeluarStats();
      return;
    }

    const parseExpenseDateToISO = (d, created_at) => {
      if (!d && created_at) {
        // fallback to created_at if date column empty
        const dt = new Date(created_at);
        if (!isNaN(dt)) return dt.toISOString().split("T")[0];
        return null;
      }
      if (!d) return null;
      d = String(d).trim();
      // Format DD/MM/YYYY (contoh from CSV)
      const slashMatch = /^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/.exec(d);
      if (slashMatch) {
        const day = String(slashMatch[1]).padStart(2, "0");
        const month = String(slashMatch[2]).padStart(2, "0");
        let year = slashMatch[3];
        if (year.length === 2) year = "20" + year;
        return `${year}-${month}-${day}`;
      }
      // If ISO-like (YYYY-MM-DD...) return first 10 chars
      const isoMatch = /^(\d{4})-(\d{2})-(\d{2})/.exec(d);
      if (isoMatch) return `${isoMatch[1]}-${isoMatch[2]}-${isoMatch[3]}`;
      // Try Date parse as last resort
      const parsed = new Date(d);
      if (!isNaN(parsed)) return parsed.toISOString().split("T")[0];
      return null;
    };

    const fromNorm = from;
    const toNorm = to;

    const filtered = (allExpenses || []).filter((exp) => {
      const expIso = parseExpenseDateToISO(exp.date, exp.created_at);
      if (!expIso) return false;
      if (category && category !== "" && exp.category !== category) return false;
      return expIso >= fromNorm && expIso <= toNorm;
    }).sort((a,b) => {
      // sort by parsed date asc
      const ad = parseExpenseDateToISO(a.date, a.created_at) || "";
      const bd = parseExpenseDateToISO(b.date, b.created_at) || "";
      return ad.localeCompare(bd);
    });

    if (!filtered || filtered.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6" class="text-center py-6 text-gray-500">Tidak ada data</td></tr>`;
      resetDetailKaskeluarStats();
      return;
    }

    // Populate table dan statistik
    let total = 0;
    filtered.forEach((exp, idx) => {
      const amt = parseFloat(exp.amount) || 0;
      total += amt;
      const dateIso = parseExpenseDateToISO(exp.date, exp.created_at) || "-";
      const categoryText = exp.category || "-";
      const description = exp.description || "-";
      const notes = exp.notes || "-";
      const nominal = formatCurrency(amt);

      tbody.innerHTML += `
        <tr class="border-b border-gray-100 hover:bg-gray-50">
          <td class="py-2 px-4 text-center">${idx + 1}</td>
          <td class="py-2 px-4">${dateIso}</td>
          <td class="py-2 px-4">${categoryText}</td>
          <td class="py-2 px-4">${description}</td>
          <td class="py-2 px-4">${notes}</td>
          <td class="py-2 px-4 text-right">${nominal}</td>
        </tr>
      `;
    });

    document.getElementById("kk_totalexpenses").textContent = formatCurrency(total);
    document.getElementById("kk_totalTransactions").textContent = `${filtered.length} transaksi`;
  } catch (err) {
    console.error("Error loading cash out report:", err);
    const tbody = document.getElementById("detail_kaskeluar_TableBody");
    tbody.innerHTML = `<tr><td colspan="6" class="text-center py-6 text-red-500">Gagal memuat data</td></tr>`;
    resetDetailKaskeluarStats();
  }
}

function downloadDetailKaskeluarExcel() {
  const table = document.getElementById("detail_kaskeluar_tabel");
  const from = document.getElementById("KasKeluar_From").value;
  const to = document.getElementById("KasKeluar_To").value;
  const storeName = document.getElementById("storeName")?.value || "Wash Management System";
  const totalExpenses = document.getElementById("kk_totalexpenses")?.textContent || "Rp 0";
  const totalTransactions = document.getElementById("kk_totalTransactions")?.textContent || "0 transaksi";

  let html = `
    <html><head><meta charset="UTF-8"><style>table{border-collapse:collapse}th,td{border:1px solid #000;padding:6px}</style></head><body>
    <h3>LAPORAN KAS KELUAR</h3>
    <div>Toko: ${storeName}</div>
    <div>Periode: ${from}${from !== to ? " s/d " + to : ""}</div>
    <br><table><thead><tr>`;

  const headers = Array.from(table.querySelectorAll("thead th")).map(th => `<th>${th.textContent}</th>`).join("");
  html += headers + `</tr></thead><tbody>`;

  const rows = table.querySelectorAll("tbody tr");
  rows.forEach(row => {
    html += "<tr>";
    const cols = Array.from(row.querySelectorAll("td")).map(td => `<td>${td.textContent}</td>`).join("");
    html += cols + "</tr>";
  });

  html += `</tbody></table>
    <br><div><strong>Total Pengeluaran:</strong> ${totalExpenses}</div>
    <div><strong>Total Transaksi:</strong> ${totalTransactions}</div>
    </body></html>`;

  const blob = new Blob([html], { type: "application/vnd.ms-excel" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `Laporan_Kas_Keluar_${from}${from !== to ? "_to_" + to : ""}.xls`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  showAlert("File Excel berhasil didownload", "success");
}
        </script>
        <script>
function setDefaultExpenseFilterDates() {
  const now = new Date();
  const jakartaOffset = 8 * 60; // menit
  const localOffset = now.getTimezoneOffset();
  const jakartaTime = new Date(now.getTime() + (jakartaOffset - localOffset) * 60000);
  const today = jakartaTime.toISOString().split("T")[0];

  const fromEl = document.getElementById("expenseFilterFrom");
  const toEl = document.getElementById("expenseFilterTo");
  // Set only jika belum diisi (tidak menimpa pilihan user)
  if (fromEl && !fromEl.value) fromEl.value = today;
  if (toEl && !toEl.value) toEl.value = today;
}
          </script>
<script>
// ========== LAPORAN LABA BERSIH ==========

// Function untuk set tanggal hari ini Laba Bersih
function setTodayDateLabaBersih() {
  const now = new Date();
  const jakartaOffset = 8 * 60;
  const localOffset = now.getTimezoneOffset();
  const jakartaTime = new Date(now.getTime() + (jakartaOffset - localOffset) * 60000);
  const today = jakartaTime.toISOString().split('T')[0];
  
  const fromEl = document.getElementById('LabaBersih_From');
  const toEl = document.getElementById('LabaBersih_To');
  if (fromEl && !fromEl.value) fromEl.value = today;
  if (toEl && !toEl.value) toEl.value = today;
}

// Function untuk search/load laporan
function searchLabaBersih() {
  const from = document.getElementById("LabaBersih_From").value;
  const to = document.getElementById("LabaBersih_To").value;
  
  if (!from || !to) {
    showAlert("Silakan pilih periode tanggal terlebih dahulu", "warning");
    return;
  }
  
  loadLabaBersihReport(from, to);
}

// Function untuk reset filter
function resetFilterLabaBersih() {
  setTodayDateLabaBersih();
  clearLabaBersihTable();
  resetLabaBersihStats();
}

// Function utama untuk load laporan laba bersih
async function loadLabaBersihReport(from = "", to = "") {
  try {
    // Set default ke hari ini jika kosong
    if (!from || !to) {
      const now = new Date();
      const jakartaOffset = 8 * 60;
      const localOffset = now.getTimezoneOffset();
      const jakartaTime = new Date(now.getTime() + (jakartaOffset - localOffset) * 60000);
      const today = jakartaTime.toISOString().split('T')[0];
      if (!from) from = today;
      if (!to) to = today;
    }

    const startIso = `${from}T00:00:00+08:00`;
    const endIso = `${to}T23:59:59+08:00`;

    // 1. Ambil salary settings
    const { data: salarySettings } = await supabase
      .from("salary_settings")
      .select("*")
      .single();
    const salaryPerMotor = salarySettings?.salary_per_motor || 7000;

    // 2. Query transaksi (pendapatan)
    const { data: transactions, error: trxError } = await supabase
      .from("transactions")
      .select("*, services(name), employee_names, employee_ids")
      .eq("status", "paid")
      .gte("created_at", startIso)
      .lte("created_at", endIso)
      .order("created_at", { ascending: true });

    if (trxError) throw trxError;

    // 3. Query expenses (pengeluaran)
    const { data: allExpenses, error: expError } = await supabase
      .from("expenses")
      .select("*")
      .order("id", { ascending: false });

    if (expError) throw expError;

    // Helper untuk parse expense date
    const parseExpenseDateToISO = (d, created_at) => {
      if (!d && created_at) {
        const dt = new Date(created_at);
        if (!isNaN(dt)) return dt.toISOString().split("T")[0];
        return null;
      }
      if (!d) return null;
      d = String(d).trim();
      
      const slashMatch = /^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/.exec(d);
      if (slashMatch) {
        const day = String(slashMatch[1]).padStart(2, "0");
        const month = String(slashMatch[2]).padStart(2, "0");
        let year = slashMatch[3];
        if (year.length === 2) year = "20" + year;
        return `${year}-${month}-${day}`;
      }
      
      const isoMatch = /^(\d{4})-(\d{2})-(\d{2})/.exec(d);
      if (isoMatch) return `${isoMatch[1]}-${isoMatch[2]}-${isoMatch[3]}`;
      
      const parsed = new Date(d);
      if (!isNaN(parsed)) return parsed.toISOString().split("T")[0];
      return null;
    };

    // Filter expenses berdasarkan tanggal
    const filteredExpenses = (allExpenses || []).filter((exp) => {
      const expIso = parseExpenseDateToISO(exp.date, exp.created_at);
      if (!expIso) return false;
      return expIso >= from && expIso <= to;
    });

    // 4. Hitung statistik
    let totalRevenue = 0;
    let totalExpenses = 0;
    let totalSalary = 0;
    const revenueCount = transactions?.length || 0;
    const expensesCount = filteredExpenses?.length || 0;

    // Hitung total pendapatan dan gaji
    (transactions || []).forEach(trx => {
      totalRevenue += trx.price || 0;
      totalSalary += salaryPerMotor; // Gaji per transaksi
    });

    // Hitung total pengeluaran
    filteredExpenses.forEach(exp => {
      totalExpenses += parseFloat(exp.amount) || 0;
    });

    // Hitung laba bersih
    const netProfit = totalRevenue - totalExpenses - totalSalary;
    const profitMargin = totalRevenue > 0 ? ((netProfit / totalRevenue) * 100).toFixed(2) : 0;

    // 5. Update summary cards
    updateLabaBersihSummary({
      totalRevenue,
      revenueCount,
      totalExpenses,
      expensesCount,
      totalSalary,
      netProfit,
      profitMargin
    });

    // 6. Populate table
    populateLabaBersihTable(transactions || [], filteredExpenses, salaryPerMotor);

  } catch (error) {
    console.error("Error loading laba bersih report:", error);
    showAlert("Gagal memuat laporan laba bersih", "error");
    clearLabaBersihTable();
    resetLabaBersihStats();
  }
}

// Function untuk update summary cards
function updateLabaBersihSummary(data) {
  // Total Pendapatan
  document.getElementById("lb_totalRevenue").textContent = formatCurrency(data.totalRevenue);
  document.getElementById("lb_revenueCount").textContent = `${data.revenueCount} transaksi`;

  // Total Pengeluaran
  document.getElementById("lb_totalExpenses").textContent = formatCurrency(data.totalExpenses);
  document.getElementById("lb_expensesCount").textContent = `${data.expensesCount} transaksi`;

  // Total Gaji
  document.getElementById("lb_totalSalary").textContent = formatCurrency(data.totalSalary);
  document.getElementById("lb_salaryInfo").textContent = `${data.revenueCount} transaksi`;

  // Laba Bersih
  document.getElementById("lb_netProfit").textContent = formatCurrency(data.netProfit);
  document.getElementById("lb_profitMargin").textContent = `Margin: ${data.profitMargin}%`;

  // Detail breakdown
  document.getElementById("lb_detail_revenue").textContent = formatCurrency(data.totalRevenue);
  document.getElementById("lb_detail_trxCount").textContent = data.revenueCount;
  document.getElementById("lb_detail_expenses").textContent = formatCurrency(data.totalExpenses);
  document.getElementById("lb_detail_salary").textContent = formatCurrency(data.totalSalary);
  document.getElementById("lb_detail_totalOut").textContent = formatCurrency(data.totalExpenses + data.totalSalary);

  // Profit analysis
  document.getElementById("lb_profitPercentage").textContent = `${data.profitMargin}%`;
  
  // Status
  const statusEl = document.getElementById("lb_profitStatus");
  if (data.netProfit > 0) {
    statusEl.innerHTML = `
      <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-green-100 text-green-800">
        <i class="fas fa-check-circle"></i>
        Untung
      </span>
    `;
  } else if (data.netProfit < 0) {
    statusEl.innerHTML = `
      <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-red-100 text-red-800">
        <i class="fas fa-times-circle"></i>
        Rugi
      </span>
    `;
  } else {
    statusEl.innerHTML = `
      <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-gray-100 text-gray-800">
        <i class="fas fa-minus-circle"></i>
        Impas
      </span>
    `;
  }
}

// Function untuk populate table
function populateLabaBersihTable(transactions, expenses, salaryPerMotor) {
  const tbody = document.getElementById("labaBersihTableBody");
  tbody.innerHTML = "";

  if ((!transactions || transactions.length === 0) && (!expenses || expenses.length === 0)) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7" class="text-center py-8 text-gray-500">
          <i class="fas fa-inbox text-4xl mb-2 opacity-30"></i>
          <p>Tidak ada data untuk periode yang dipilih</p>
        </td>
      </tr>
    `;
    return;
  }

  let rowNum = 0;

  // Tambahkan transaksi (pendapatan)
  (transactions || []).forEach(trx => {
    rowNum++;
    const date = new Date(trx.created_at).toLocaleDateString("id-ID");
    const serviceName = trx.services?.name || "-";
    const karyawan = Array.isArray(trx.employee_names) ? trx.employee_names.join(", ") : "-";
    
    tbody.innerHTML += `
      <tr class="border-b border-gray-100 hover:bg-green-50">
        <td class="py-3 px-4 text-center">${rowNum}</td>
        <td class="py-3 px-4">${date}</td>
        <td class="py-3 px-4">
          <span class="inline-flex items-center px-2 py-1 rounded-full bg-green-100 text-green-800 text-xs">
            <i class="fas fa-arrow-up mr-1"></i>
            Pendapatan
          </span>
        </td>
        <td class="py-3 px-4">${serviceName} - ${karyawan}</td>
        <td class="py-3 px-4 text-right font-semibold text-green-600">${formatCurrency(trx.price)}</td>
        <td class="py-3 px-4 text-right">-</td>
        <td class="py-3 px-4 text-right text-red-600">${formatCurrency(salaryPerMotor)}</td>
      </tr>
    `;
  });

  // Tambahkan expenses (pengeluaran)
  expenses.forEach(exp => {
    rowNum++;
    const parseExpenseDateToISO = (d, created_at) => {
      if (!d && created_at) {
        const dt = new Date(created_at);
        if (!isNaN(dt)) return dt.toISOString().split("T")[0];
        return null;
      }
      if (!d) return null;
      d = String(d).trim();
      const slashMatch = /^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/.exec(d);
      if (slashMatch) {
        const day = String(slashMatch[1]).padStart(2, "0");
        const month = String(slashMatch[2]).padStart(2, "0");
        let year = slashMatch[3];
        if (year.length === 2) year = "20" + year;
        return `${year}-${month}-${day}`;
      }
      const isoMatch = /^(\d{4})-(\d{2})-(\d{2})/.exec(d);
      if (isoMatch) return `${isoMatch[1]}-${isoMatch[2]}-${isoMatch[3]}`;
      const parsed = new Date(d);
      if (!isNaN(parsed)) return parsed.toISOString().split("T")[0];
      return null;
    };

    const dateIso = parseExpenseDateToISO(exp.date, exp.created_at);
    const displayDate = dateIso ? new Date(dateIso + "T00:00:00").toLocaleDateString("id-ID") : "-";
    const category = exp.category || "-";
    const description = exp.description || "-";
    const notes = exp.notes ? ` (${exp.notes})` : "";
    
    tbody.innerHTML += `
      <tr class="border-b border-gray-100 hover:bg-red-50">
        <td class="py-3 px-4 text-center">${rowNum}</td>
        <td class="py-3 px-4">${displayDate}</td>
        <td class="py-3 px-4">
          <span class="inline-flex items-center px-2 py-1 rounded-full bg-red-100 text-red-800 text-xs">
            <i class="fas fa-arrow-down mr-1"></i>
            Pengeluaran
          </span>
        </td>
        <td class="py-3 px-4">${category} - ${description}${notes}</td>
        <td class="py-3 px-4 text-right">-</td>
        <td class="py-3 px-4 text-right font-semibold text-red-600">${formatCurrency(exp.amount)}</td>
        <td class="py-3 px-4 text-right">-</td>
      </tr>
    `;
  });
}

// Function untuk reset statistik
function resetLabaBersihStats() {
  document.getElementById("lb_totalRevenue").textContent = "Rp 0";
  document.getElementById("lb_revenueCount").textContent = "0 transaksi";
  document.getElementById("lb_totalExpenses").textContent = "Rp 0";
  document.getElementById("lb_expensesCount").textContent = "0 transaksi";
  document.getElementById("lb_totalSalary").textContent = "Rp 0";
  document.getElementById("lb_salaryInfo").textContent = "-";
  document.getElementById("lb_netProfit").textContent = "Rp 0";
  document.getElementById("lb_profitMargin").textContent = "Margin: 0%";
  document.getElementById("lb_detail_revenue").textContent = "Rp 0";
  document.getElementById("lb_detail_trxCount").textContent = "0";
  document.getElementById("lb_detail_expenses").textContent = "Rp 0";
  document.getElementById("lb_detail_salary").textContent = "Rp 0";
  document.getElementById("lb_detail_totalOut").textContent = "Rp 0";
  document.getElementById("lb_profitPercentage").textContent = "0%";
  document.getElementById("lb_profitStatus").innerHTML = `
    <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-gray-200 text-gray-700">
      <i class="fas fa-minus-circle"></i>
      Belum ada data
    </span>
  `;
}

// Function untuk clear table
function clearLabaBersihTable() {
  const tbody = document.getElementById("labaBersihTableBody");
  if (tbody) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7" class="text-center py-8 text-gray-500">
          <i class="fas fa-inbox text-4xl mb-2 opacity-30"></i>
          <p>Pilih periode untuk menampilkan data</p>
        </td>
      </tr>
    `;
  }
}

// Function untuk export Excel
function showExportLabaBersih() {
  const from = document.getElementById("LabaBersih_From").value;
  const to = document.getElementById("LabaBersih_To").value;
  
  if (!from || !to) {
    showAlert("Silakan pilih periode terlebih dahulu", "warning");
    return;
  }
  
  downloadLabaBersihExcel();
}

function downloadLabaBersihExcel() {
  const from = document.getElementById("LabaBersih_From").value;
  const to = document.getElementById("LabaBersih_To").value;
  const storeName = document.getElementById("storeName")?.value || "Wash Management System";
  
  // Ambil data dari summary
  const totalRevenue = document.getElementById("lb_totalRevenue")?.textContent || "Rp 0";
  const totalExpenses = document.getElementById("lb_totalExpenses")?.textContent || "Rp 0";
  const totalSalary = document.getElementById("lb_totalSalary")?.textContent || "Rp 0";
  const netProfit = document.getElementById("lb_netProfit")?.textContent || "Rp 0";
  const profitMargin = document.getElementById("lb_profitPercentage")?.textContent || "0%";
  
  // Ambil data dari table
  const tbody = document.getElementById("labaBersihTableBody");
  const rows = tbody.querySelectorAll("tr");
  
  let html = `
    <html>
      <head>
        <meta charset="UTF-8">
        <style>
          table { border-collapse: collapse; width: 100%; }
          th, td { border: 1px solid black; padding: 8px; text-align: left; }
          th { background-color: #f3f4f6; font-weight: bold; }
          .header { text-align: center; font-weight: bold; font-size: 18px; margin-bottom: 10px; }
          .info { margin-bottom: 5px; }
          .summary { margin-top: 20px; background-color: #e8f5e9; padding: 15px; border: 2px solid #4caf50; }
          .summary-title { font-weight: bold; font-size: 16px; margin-bottom: 10px; color: #2e7d32; }
          .summary-item { margin: 8px 0; padding: 5px; }
          .profit { color: #2e7d32; font-weight: bold; }
          .loss { color: #c62828; font-weight: bold; }
        </style>
      </head>
      <body>
        <div class="header">LAPORAN LABA BERSIH</div>
        <div class="info"><strong>Toko:</strong> ${storeName}</div>
        <div class="info"><strong>Periode:</strong> ${from}${from !== to ? " s/d " + to : ""}</div>
        <br>
        <table>
          <thead>
            <tr>
              <th>No</th>
              <th>Tanggal</th>
              <th>Kategori</th>
              <th>Keterangan</th>
              <th>Pendapatan</th>
              <th>Pengeluaran</th>
              <th>Gaji</th>
            </tr>
          </thead>
          <tbody>`;
  
  // Tambahkan rows dari table
  rows.forEach(row => {
    if (!row.textContent.includes("Tidak ada data") && !row.textContent.includes("Pilih periode")) {
      html += "<tr>";
      const cols = Array.from(row.querySelectorAll("td")).map(td => `<td>${td.textContent}</td>`);
      html += cols.join("");
      html += "</tr>";
    }
  });
  
  html += `
          </tbody>
        </table>
        
        <div class="summary">
          <div class="summary-title">RINGKASAN LABA BERSIH</div>
          <div class="summary-item"><strong>Total Pendapatan:</strong> ${totalRevenue}</div>
          <div class="summary-item"><strong>Total Pengeluaran Operasional:</strong> ${totalExpenses}</div>
          <div class="summary-item"><strong>Total Gaji Karyawan:</strong> ${totalSalary}</div>
          <hr style="margin: 10px 0; border: 1px solid #4caf50;">
          <div class="summary-item profit"><strong>LABA BERSIH:</strong> ${netProfit}</div>
          <div class="summary-item"><strong>Margin Keuntungan:</strong> ${profitMargin}</div>
        </div>
        
        <br>
        <div style="text-align: center; color: #666; font-size: 12px;">
          Laporan dibuat otomatis oleh Wash Management System
        </div>
      </body>
    </html>
  `;

  const filename = `Laporan_Laba_Bersih_${from}${from !== to ? "_to_" + to : ""}.xls`;
  const blob = new Blob([html], { type: "application/vnd.ms-excel" });
  const url = URL.createObjectURL(blob);
  
  const link = document.createElement("a");
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
  
  showAlert("File Excel berhasil didownload", "success");
}

// Initialize saat DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
  setTodayDateLabaBersih();
});
          </script>
          <script>
/* ===========================================================
   🔧 UPDATE RECEIPT PREVIEW DARI DATA
   =========================================================== */
function updateReceiptPreviewFromData(data) {
  document.getElementById("receiptNumber").textContent = data.id || "-";
  document.getElementById("receiptDate").textContent = new Date(
    data.created_at
  ).toLocaleString("id-ID");
  document.getElementById("receiptPlate").textContent = data.plate_number || "-";
  document.getElementById("receiptService").textContent =
    data.services?.name || "Cuci Motor";
  document.getElementById("receiptPrice").textContent = formatCurrency(data.price);
  document.getElementById("receiptTotal").textContent = formatCurrency(data.price);
  document.getElementById("receiptNotesSection").classList.add("hidden");
}

/* ===========================================================
   ✅ FUNGSI UTAMA: GENERATE RECEIPT SEBAGAI TEKS MENTAH (FINAL)
   (Perbaikan Rata Kanan Metode Bayar & Center Header)
   =========================================================== */
function generateReceiptPlainTXT(data, storeSettings) {
    // Fungsi pembantu centerText harus sudah didefinisikan di atas

    const formatCurrency = typeof window.formatCurrency === 'function' ? window.formatCurrency : (v) => `Rp ${v.toLocaleString('id-ID')}`;
    const transactionDate = new Date(data.created_at).toLocaleString("id-ID", {
        day: '2-digit', month: '2-digit', year: 'numeric',
        hour: '2-digit', minute: '2-digit'
    });
    // Gunakan data.payment_method yang sebenarnya, BUKAN selectedPaymentMethod
    const paymentMethodText = {
        cash: "TUNAI",
        transfer: "TRANSFER BANK",
        qris: "QRIS",
    }[data.payment_method] || "TUNAI";

    const priceFormatted = formatCurrency(data.price);
    const totalFormatted = formatCurrency(data.price);
    const kembalian = data.payment_amount > data.price ? data.payment_amount - data.price : 0;
    const kembalianFormatted = formatCurrency(kembalian);

    const storeName = storeSettings.name || 'NAMA TOKO';
    const storeAddress = storeSettings.address || 'Alamat Toko';
    const storePhone = storeSettings.phone || 'Telp: -';
    const footerMessage = storeSettings.footer_message || 'Terima kasih atas kunjungan Anda.';
    
    const maxLength = 32; 
    const receiptContent = [];

    const ESC = '\x1B'; 
    const GS = '\x1D'; 

    // =======================================================
    // 2. CENTER HEADER (Nama Toko, Alamat, Telp)
    // =======================================================
    // Set font ke DOUBLE HEIGHT dan DOUBLE WIDTH (efek logo)
    receiptContent.push(ESC + '\x21\x11'); 
    receiptContent.push(centerText(storeName.toUpperCase(), maxLength)); // Tetap gunakan maxLength
    
    // Kembalikan ke font NORMAL
    receiptContent.push(ESC + '\x21\x00'); 
    
    // Teks di bawah logo/header
    receiptContent.push(centerText(storeAddress, maxLength));
    receiptContent.push(centerText(storePhone, maxLength));
    
    receiptContent.push("--------------------------------");
    
    // ... (Detail Transaksi, Layanan, Harga, Catatan - TIDAK BERUBAH) ...

    receiptContent.push(`No. Trx: ${data.id || "-"}`); 
    receiptContent.push(`Tanggal: ${transactionDate}`);
    receiptContent.push(`Plat: ${data.plate_number || 'TIDAK ADA'}`);
    receiptContent.push("--------------------------------");

    const serviceName = data.services?.name || 'Layanan';
    const serviceLength = serviceName.length;
    const priceLength = priceFormatted.length;
    const padding = " ".repeat(maxLength - serviceLength - priceLength);
    receiptContent.push(serviceName + padding + priceFormatted);
    
     // 🛑 MODIFIKASI: CATATAN (Jika Ada dan Tidak Kosong)
    // =======================================================
    // Cek apakah data.notes ada dan, setelah di-trim, tidak kosong
    if (data.notes && data.notes.trim() !== "") { 
        receiptContent.push("\nCATATAN:");
        
        // Memecah baris catatan
        const notesLines = data.notes.match(new RegExp('.{1,' + maxLength + '}', 'g'));
        
        // Pastikan ada baris yang valid untuk ditambahkan
        if (notesLines) {
             notesLines.forEach(line => receiptContent.push(line));
        }   
    }
    receiptContent.push("--------------------------------");    
    // TOTAL (dengan bold ESC/POS)
    // receiptContent.push(ESC + '\x45\x01'); 
    const totalText = "TOTAL";
    const totalPadding = " ".repeat(maxLength - totalText.length - totalFormatted.length);
    receiptContent.push(totalText + totalPadding + totalFormatted);
    // receiptContent.push(ESC + '\x45\x00'); 
    
    receiptContent.push("--------------------------------");
    
    // Metode Bayar Rata Kanan (TIDAK ADA BARIS PEMISAH DI ATASNYA)
    const methodLabel = "Metode Bayar:";
    const totalMethodLen = methodLabel.length + paymentMethodText.length;
    const methodPadding = " ".repeat(maxLength - totalMethodLen);
    receiptContent.push(methodLabel + methodPadding + paymentMethodText);
    
    // KEMBALIAN (Sudah Rata Kanan)
    if (kembalian > 0) {
        const kembaliText = "Kembalian:";
        const totalKembalianLen = kembaliText.length + kembalianFormatted.length;
        const kembaliPadding = " ".repeat(maxLength - totalKembalianLen);
        receiptContent.push(kembaliText + kembaliPadding + kembalianFormatted);
    }


    // receiptContent.push("--------------------------------");
    
    // ----------------------------------------------------
    // 7. FOOTER (CENTER)
    // ----------------------------------------------------
    receiptContent.push(centerText(footerMessage, maxLength));
    
    // 8. CUT
    receiptContent.push("\n\n"); // Hanya dua baris kosong untuk pemotongan
    receiptContent.push(GS + '\x56\x01'); 

    return receiptContent;
}

/* ===========================================================
   ⚙️ CORE: autoPrintThermalQZ (MODIFIKASI KE RAW TEXT)
   =========================================================== */
async function autoPrintThermalQZ(data) {
    try {
        const { data: storeSettings, error: settingsError } = await supabase.from("store_settings").select("*").single();
        if (settingsError) throw settingsError;

        // 🛑 Gunakan fungsi teks mentah yang baru
        const receiptPlainTXT = generateReceiptPlainTXT(data, storeSettings);

        if (!qz.websocket.isActive()) {
            await qz.websocket.connect();
        }
        
        const printer = await qz.printers.getDefault();
        if (!printer) {
             throw new Error("Printer default tidak ditemukan. Harap atur di QZ Tray.");
        }

        // 🛑 KONFIGURASI QZ TRAY UNTUK RAW TEXT
        // Config ini lebih sederhana dan lebih stabil untuk thermal
        const config = qz.configs.create(printer, {
             language: "text", // Coba 'EPL' atau 'ZPL' atau 'text'
             encoding: 'UTF-8',
        }); 
        
        const dataPayload = [];
        
        // Kirim setiap baris sebagai data mentah terpisah
        receiptPlainTXT.forEach(line => {
             dataPayload.push({ type: 'raw', data: line + '\n' }); // Tambahkan \n manual
        });

        // 7. Kirim Pekerjaan Cetak
        await qz.print(config, dataPayload);
        console.log(`Print job for Transaction #${data.id} sent to ${printer}`);
        
    } catch (error) {
        console.error("QZ Tray Print Error:", error);
        throw new Error("Gagal mencetak melalui QZ Tray. Pesan: " + error.message);
    }
}

/**
 * Mengatur teks agar berada di tengah (center) untuk lebar printer 58mm (32 kolom).
 * @param {string} text - Teks yang akan di-center
 * @param {number} [maxWidth=32] - Lebar maksimum kolom (default 32)
 * @returns {string} - Teks dengan padding di kiri/kanan
 */
function centerText(text, maxWidth = 32) {
    if (!text) return "";
    const len = text.length;
    if (len >= maxWidth) return text.substring(0, maxWidth); // Potong jika terlalu panjang
    
    const padding = Math.floor((maxWidth - len) / 2);
    return " ".repeat(padding) + text;
}


            </script>
  </body>
</html>
